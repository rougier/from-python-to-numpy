
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Code vectorization &#8212; From Python to Numpy</title>
    
  <link href="_static/css/theme.css" rel="stylesheet" />
  <link href="_static/css/index.c5995385ac14fb8791e8eb36b4908be2.css" rel="stylesheet" />

    
  <link rel="stylesheet"
    href="_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="_static/sphinx-book-theme.acff12b8f9c144ce68a297486a2fa670.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="_static/js/index.1c5a1a01449ed65a7b51.js">

    <script id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/togglebutton.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script >var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="_static/sphinx-book-theme.12a9622fbb08dcb3a2a40b2c02b83a57.js"></script>
    <script async="async" src="https://unpkg.com/thebelab@latest/lib/index.js"></script>
    <script >
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="_static/sphinx-thebe.js"></script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["\\(", "\\)"]], "displayMath": [["\\[", "\\]"]], "processRefs": false, "processEnvironments": false}})</script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Problem vectorization" href="05-problem-vectorization.html" />
    <link rel="prev" title="Anatomy of an array" href="03-anatomy.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="index.html">
      
      <img src="_static/cubes.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">From Python to Numpy</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
    <div class="bd-toc-item active">
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="book-jupyterbook.html">
   From Python to Numpy
  </a>
 </li>
</ul>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="01-preface-with-jupyter-book.html">
   Preface
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="02-introduction.html">
   Introduction
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="03-anatomy.html">
   Anatomy of an array
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Code vectorization
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="05-problem-vectorization.html">
   Problem vectorization
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="06-custom-vectorization.html">
   Custom vectorization
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="07-beyond-numpy.html">
   Beyond NumPy
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="08-conclusion.html">
   Conclusion
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="09-quick-reference.html">
   Quick References
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="10-bibliography.html">
   Bibliography
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="_sources/04-code-vectorization.rst"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.rst</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#introduction">
   Introduction
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#uniform-vectorization">
   Uniform vectorization
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#the-game-of-life">
     The Game of Life
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#python-implementation">
     Python implementation
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#numpy-implementation">
     NumPy implementation
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#exercise">
     Exercise
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#sources">
     Sources
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#references">
     References
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#temporal-vectorization">
   Temporal vectorization
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id1">
     Python implementation
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id2">
     NumPy implementation
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#faster-numpy-implementation">
     Faster NumPy implementation
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#visualization">
     Visualization
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id3">
     Exercise
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id4">
     Sources
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id5">
     References
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#spatial-vectorization">
   Spatial vectorization
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#boids">
     Boids
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id7">
     Python implementation
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id8">
     NumPy implementation
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id9">
     Exercise
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id10">
     Sources
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id11">
     References
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#conclusion">
   Conclusion
  </a>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <div class="section" id="code-vectorization">
<h1>Code vectorization<a class="headerlink" href="#code-vectorization" title="Permalink to this headline">¶</a></h1>
<div class="contents local topic" id="contents">
<p class="topic-title"><strong>Contents</strong></p>
<ul class="simple">
<li><p><a class="reference internal" href="#introduction" id="id12">Introduction</a></p></li>
<li><p><a class="reference internal" href="#uniform-vectorization" id="id13">Uniform vectorization</a></p>
<ul>
<li><p><a class="reference internal" href="#the-game-of-life" id="id14">The Game of Life</a></p></li>
<li><p><a class="reference internal" href="#python-implementation" id="id15">Python implementation</a></p></li>
<li><p><a class="reference internal" href="#numpy-implementation" id="id16">NumPy implementation</a></p></li>
<li><p><a class="reference internal" href="#exercise" id="id17">Exercise</a></p></li>
<li><p><a class="reference internal" href="#sources" id="id18">Sources</a></p></li>
<li><p><a class="reference internal" href="#references" id="id19">References</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#temporal-vectorization" id="id20">Temporal vectorization</a></p>
<ul>
<li><p><a class="reference internal" href="#id1" id="id21">Python implementation</a></p></li>
<li><p><a class="reference internal" href="#id2" id="id22">NumPy implementation</a></p></li>
<li><p><a class="reference internal" href="#faster-numpy-implementation" id="id23">Faster NumPy implementation</a></p></li>
<li><p><a class="reference internal" href="#visualization" id="id24">Visualization</a></p></li>
<li><p><a class="reference internal" href="#id3" id="id25">Exercise</a></p></li>
<li><p><a class="reference internal" href="#id4" id="id26">Sources</a></p></li>
<li><p><a class="reference internal" href="#id5" id="id27">References</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#spatial-vectorization" id="id28">Spatial vectorization</a></p>
<ul>
<li><p><a class="reference internal" href="#boids" id="id29">Boids</a></p></li>
<li><p><a class="reference internal" href="#id7" id="id30">Python implementation</a></p></li>
<li><p><a class="reference internal" href="#id8" id="id31">NumPy implementation</a></p></li>
<li><p><a class="reference internal" href="#id9" id="id32">Exercise</a></p></li>
<li><p><a class="reference internal" href="#id10" id="id33">Sources</a></p></li>
<li><p><a class="reference internal" href="#id11" id="id34">References</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#conclusion" id="id35">Conclusion</a></p></li>
</ul>
</div>
<div class="section" id="introduction">
<h2><a class="toc-backref" href="#id12">Introduction</a><a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p>Code vectorization means that the problem you’re trying to solve is inherently
vectorizable and only requires a few NumPy tricks to make it faster. Of course
it does not mean it is easy or straightforward, but at least it does not
necessitate totally rethinking your problem (as it will be the case in the
<a href="#id36"><span class="problematic" id="id37">`Problem vectorization`_</span></a> chapter). Still, it may require some experience to see
where code can be vectorized. Let’s illustrate this through a simple example
where we want to sum up two lists of integers. One simple way using pure Python
is:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">add_python</span><span class="p">(</span><span class="n">Z1</span><span class="p">,</span><span class="n">Z2</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">z1</span><span class="o">+</span><span class="n">z2</span> <span class="k">for</span> <span class="p">(</span><span class="n">z1</span><span class="p">,</span><span class="n">z2</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">Z1</span><span class="p">,</span><span class="n">Z2</span><span class="p">)]</span>
</pre></div>
</div>
<p>This first naive solution can be vectorized very easily using NumPy:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">add_numpy</span><span class="p">(</span><span class="n">Z1</span><span class="p">,</span><span class="n">Z2</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Z1</span><span class="p">,</span><span class="n">Z2</span><span class="p">)</span>
</pre></div>
</div>
<p>Without any surprise, benchmarking the two approaches shows the second method
is the fastest with one order of magnitude.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">Z1</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1000</span><span class="p">),</span> <span class="mi">100</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Z2</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1000</span><span class="p">),</span> <span class="mi">100</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">timeit</span><span class="p">(</span><span class="s2">&quot;add_python(Z1, Z2)&quot;</span><span class="p">,</span> <span class="nb">globals</span><span class="p">())</span>
<span class="go">1000 loops, best of 3: 68 usec per loop</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">timeit</span><span class="p">(</span><span class="s2">&quot;add_numpy(Z1, Z2)&quot;</span><span class="p">,</span> <span class="nb">globals</span><span class="p">())</span>
<span class="go">10000 loops, best of 3: 1.14 usec per loop</span>
</pre></div>
</div>
<p>Not only is the second approach faster, but it also naturally adapts to the
shape of <cite>Z1</cite> and <cite>Z2</cite>. This is the reason why we did not write <cite>Z1 + Z2</cite>
because it would not work if <cite>Z1</cite> and <cite>Z2</cite> were both lists. In the first Python
method, the inner <cite>+</cite> is interpreted differently depending on the nature of the
two objects such that if we consider two nested lists, we get the following
outputs:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">Z1</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">]]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Z2</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">],</span> <span class="p">[</span><span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">]]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Z1</span> <span class="o">+</span> <span class="n">Z2</span>
<span class="go">[[1, 2], [3, 4], [5, 6], [7, 8]]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">add_python</span><span class="p">(</span><span class="n">Z1</span><span class="p">,</span> <span class="n">Z2</span><span class="p">)</span>
<span class="go">[[1, 2, 5, 6], [3, 4, 7, 8]]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">add_numpy</span><span class="p">(</span><span class="n">Z1</span><span class="p">,</span> <span class="n">Z2</span><span class="p">)</span>
<span class="go">[[ 6  8]</span>
<span class="go"> [10 12]]</span>
</pre></div>
</div>
<p>The first method concatenates the two lists together, the second method
concatenates the internal lists together and the last one computes what is
(numerically) expected. As an exercise, you can rewrite the Python version
such that it accepts nested lists of any depth.</p>
</div>
<div class="section" id="uniform-vectorization">
<h2><a class="toc-backref" href="#id13">Uniform vectorization</a><a class="headerlink" href="#uniform-vectorization" title="Permalink to this headline">¶</a></h2>
<p>Uniform vectorization is the simplest form of vectorization where all the
elements share the same computation at every time step with no specific
processing for any element. One stereotypical case is the Game of Life that has
been invented by John Conway (see below) and is one of the earliest examples of
cellular automata. Those cellular automata can be conveniently regarded as
an array of cells that are connected together with the notion of neighbours and
their vectorization is straightforward. Let me first define the game and we’ll
see how to vectorize it.</p>
<div class="legend admonition">
<p class="admonition-title"><strong>Figure 4.1</strong></p>
<p>Conus textile snail exhibits a cellular automaton pattern on its shell.
Image by <a class="reference external" href="https://commons.wikimedia.org/wiki/File:Textile_cone.JPG">Richard Ling</a>, 2005.</p>
</div>
<a class="bordered reference internal image-reference" href="_images/Textile-Cone-cropped.jpg"><img alt="_images/Textile-Cone-cropped.jpg" class="bordered" src="_images/Textile-Cone-cropped.jpg" style="width: 100%;" /></a>
<div class="section" id="the-game-of-life">
<h3><a class="toc-backref" href="#id14">The Game of Life</a><a class="headerlink" href="#the-game-of-life" title="Permalink to this headline">¶</a></h3>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Excerpt from the Wikipedia entry on the
<a class="reference external" href="https://en.wikipedia.org/wiki/Conway%27s_Game_of_Life">Game of Life</a></p>
</div>
<p>The Game of Life is a cellular automaton devised by the British mathematician
John Horton Conway in 1970. It is the best-known example of a cellular
automaton. The “game” is actually a zero-player game, meaning that its
evolution is determined by its initial state, needing no input from human
players. One interacts with the Game of Life by creating an initial
configuration and observing how it evolves.</p>
<p>The universe of the Game of Life is an infinite two-dimensional orthogonal grid
of square cells, each of which is in one of two possible states, live or
dead. Every cell interacts with its eight neighbours, which are the cells that
are directly horizontally, vertically, or diagonally adjacent. At each step in
time, the following transitions occur:</p>
<ol class="arabic simple">
<li><p>Any live cell with fewer than two live neighbours dies, as if by
underpopulation.</p></li>
<li><p>Any live cell with more than three live neighbours dies, as if by
overcrowding.</p></li>
<li><p>Any live cell with two or three live neighbours lives, unchanged, to the
next generation.</p></li>
<li><p>Any dead cell with exactly three live neighbours becomes a live cell.</p></li>
</ol>
<p>The initial pattern constitutes the ‘seed’ of the system. The first generation
is created by applying the above rules simultaneously to every cell in the seed
– births and deaths happen simultaneously, and the discrete moment at which
this happens is sometimes called a tick. (In other words, each generation is a
pure function of the one before.) The rules continue to be applied repeatedly
to create further generations.</p>
</div>
<div class="section" id="python-implementation">
<h3><a class="toc-backref" href="#id15">Python implementation</a><a class="headerlink" href="#python-implementation" title="Permalink to this headline">¶</a></h3>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>We could have used the more efficient python <a class="reference external" href="http://docs.python.org/3/library/array.html">array interface</a> but it is more convenient to
use the familiar list object.</p>
</div>
<p>In pure Python, we can code the Game of Life using a list of lists representing
the board where cells are supposed to evolve. Such a board will be equipped with
border of 0 that allows to accelerate things a bit by avoiding having specific
tests for borders when counting the number of neighbours.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">Z</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span>
     <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span>
     <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span>
     <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span>
     <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span>
     <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]]</span>
</pre></div>
</div>
<p>Taking the border into account, counting neighbours then is straightforward:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">compute_neighbours</span><span class="p">(</span><span class="n">Z</span><span class="p">):</span>
    <span class="n">shape</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">Z</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">Z</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">N</span>  <span class="o">=</span> <span class="p">[[</span><span class="mi">0</span><span class="p">,]</span><span class="o">*</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">N</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="n">y</span><span class="p">]</span> <span class="o">=</span> <span class="n">Z</span><span class="p">[</span><span class="n">x</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">y</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">Z</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="n">y</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">Z</span><span class="p">[</span><span class="n">x</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="n">y</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> \
                    <span class="o">+</span> <span class="n">Z</span><span class="p">[</span><span class="n">x</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">y</span><span class="p">]</span>            <span class="o">+</span><span class="n">Z</span><span class="p">[</span><span class="n">x</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="n">y</span><span class="p">]</span>   \
                    <span class="o">+</span> <span class="n">Z</span><span class="p">[</span><span class="n">x</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">y</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">Z</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="n">y</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">Z</span><span class="p">[</span><span class="n">x</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="n">y</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">N</span>
</pre></div>
</div>
<p>To iterate one step in time, we then simply count the number of neighbours for
each internal cell and we update the whole board according to the four
aforementioned rules:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">iterate</span><span class="p">(</span><span class="n">Z</span><span class="p">):</span>
    <span class="n">N</span> <span class="o">=</span> <span class="n">compute_neighbours</span><span class="p">(</span><span class="n">Z</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
             <span class="k">if</span> <span class="n">Z</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="n">y</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="p">(</span><span class="n">N</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="n">y</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="ow">or</span> <span class="n">N</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="n">y</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">):</span>
                 <span class="n">Z</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="n">y</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
             <span class="k">elif</span> <span class="n">Z</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="n">y</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">N</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="n">y</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                 <span class="n">Z</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="n">y</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">Z</span>
</pre></div>
</div>
<p>The figure below shows four iterations on a 4x4 area where the initial state is a
<a class="reference external" href="https://en.wikipedia.org/wiki/Glider_(Conway%27s_Life)">glider</a>, a structure
discovered by Richard K. Guy in 1970.</p>
<div class="legend admonition">
<p class="admonition-title"><strong>Figure 4.2</strong></p>
<p>The glider pattern is known to replicate itself one step diagonally in 4
iterations.</p>
</div>
<a class="reference internal image-reference" href="_images/glider.png"><img alt="_images/glider.png" src="_images/glider.png" style="width: 100%;" /></a>
</div>
<div class="section" id="numpy-implementation">
<h3><a class="toc-backref" href="#id16">NumPy implementation</a><a class="headerlink" href="#numpy-implementation" title="Permalink to this headline">¶</a></h3>
<p>Starting from the Python version, the vectorization of the Game of Life
requires two parts, one responsible for counting the neighbours and one
responsible for enforcing the rules. Neighbour-counting is relatively easy if
we remember we took care of adding a null border around the arena. By
considering partial views of the arena we can actually access neighbours quite
intuitively as illustrated below for the one-dimensional case:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>               ┏━━━┳━━━┳━━━┓───┬───┐
        Z[:-2] ┃ 0 ┃ 1 ┃ 1 ┃ 1 │ 0 │ (left neighbours)
               ┗━━━┻━━━┻━━━┛───┴───┘
                     ↓︎
           ┌───┏━━━┳━━━┳━━━┓───┐
   Z[1:-1] │ 0 ┃ 1 ┃ 1 ┃ 1 ┃ 0 │ (actual cells)
           └───┗━━━┻━━━┻━━━┛───┘
                     ↑
       ┌───┬───┏━━━┳━━━┳━━━┓
Z[+2:] │ 0 │ 1 ┃ 1 ┃ 1 ┃ 0 ┃ (right neighbours)
       └───┴───┗━━━┻━━━┻━━━┛
</pre></div>
</div>
<p>Going to the two dimensional case requires just a bit of arithmetic to make
sure to consider all the eight neighbours.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">N</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">Z</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
<span class="n">N</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="n">Z</span><span class="p">[</span> <span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">Z</span><span class="p">[</span> <span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">Z</span><span class="p">[</span> <span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">:]</span> <span class="o">+</span>
                 <span class="n">Z</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>                <span class="o">+</span> <span class="n">Z</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">:]</span> <span class="o">+</span>
                 <span class="n">Z</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span>  <span class="p">,</span> <span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">Z</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span>  <span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">Z</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span>  <span class="p">,</span><span class="mi">2</span><span class="p">:])</span>
</pre></div>
</div>
<p>For the rule enforcement, we can write a first version using NumPy’s
<a class="reference external" href="http://docs.scipy.org/doc/numpy/reference/generated/numpy.argwhere.html">argwhere</a>
method that will give us the indices where a given condition is True.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Flatten arrays</span>
<span class="n">N_</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
<span class="n">Z_</span> <span class="o">=</span> <span class="n">Z</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

<span class="c1"># Apply rules</span>
<span class="n">R1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span> <span class="p">(</span><span class="n">Z_</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">N_</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">)</span>
<span class="n">R2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span> <span class="p">(</span><span class="n">Z_</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">N_</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">)</span>
<span class="n">R3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span> <span class="p">(</span><span class="n">Z_</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">((</span><span class="n">N_</span><span class="o">==</span><span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">N_</span><span class="o">==</span><span class="mi">3</span><span class="p">))</span> <span class="p">)</span>
<span class="n">R4</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span> <span class="p">(</span><span class="n">Z_</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">N_</span><span class="o">==</span><span class="mi">3</span><span class="p">)</span> <span class="p">)</span>

<span class="c1"># Set new values</span>
<span class="n">Z_</span><span class="p">[</span><span class="n">R1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">Z_</span><span class="p">[</span><span class="n">R2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">Z_</span><span class="p">[</span><span class="n">R3</span><span class="p">]</span> <span class="o">=</span> <span class="n">Z_</span><span class="p">[</span><span class="n">R3</span><span class="p">]</span>
<span class="n">Z_</span><span class="p">[</span><span class="n">R4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

<span class="c1"># Make sure borders stay null</span>
<span class="n">Z</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">Z</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">Z</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">Z</span><span class="p">[:,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</pre></div>
</div>
<p>Even if this first version does not use nested loops, it is far from optimal
because of the use of the four <cite>argwhere</cite> calls that may be quite slow. We can
instead factorize the rules into cells that will survive (stay at 1) and cells
that will give birth. For doing this, we can take advantage of NumPy boolean
capability and write quite naturally:</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>We did not write <cite>Z = 0</cite> as this would simply assign the value 0 to <cite>Z</cite> that
would then become a simple scalar.</p>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">birth</span> <span class="o">=</span> <span class="p">(</span><span class="n">N</span><span class="o">==</span><span class="mi">3</span><span class="p">)[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">Z</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span>
<span class="n">survive</span> <span class="o">=</span> <span class="p">((</span><span class="n">N</span><span class="o">==</span><span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">N</span><span class="o">==</span><span class="mi">3</span><span class="p">))[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">Z</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span>
<span class="n">Z</span><span class="p">[</span><span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">Z</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">birth</span> <span class="o">|</span> <span class="n">survive</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</pre></div>
</div>
<p>If you look at the <cite>birth</cite> and <cite>survive</cite> lines, you’ll see that these two
variables are arrays that can be used to set <cite>Z</cite> values to 1 after having
cleared it.</p>
<div class="legend admonition">
<p class="admonition-title"><strong>Figure 4.3</strong></p>
<p>The Game of Life. Gray levels indicate how much a cell has been active in
the past.</p>
</div>
<video width="100%" class="bordered" controls>
<source src="data/game-of-life.mp4" type="video/mp4">
Your browser does not support the video tag. </video></div>
<div class="section" id="exercise">
<h3><a class="toc-backref" href="#id17">Exercise</a><a class="headerlink" href="#exercise" title="Permalink to this headline">¶</a></h3>
<p>Reaction and diffusion of chemical species can produce a variety of
patterns, reminiscent of those often seen in nature. The Gray-Scott
equations model such a reaction. For more information on this chemical
system see the article <em>Complex Patterns in a Simple System</em>
(John E. Pearson, Science, Volume 261, 1993). Let’s consider two
chemical species <span class="math notranslate nohighlight">\(U\)</span> and <span class="math notranslate nohighlight">\(V\)</span> with respective
concentrations <span class="math notranslate nohighlight">\(u\)</span> and <span class="math notranslate nohighlight">\(v\)</span> and diffusion rates <span class="math notranslate nohighlight">\(Du\)</span>
and <span class="math notranslate nohighlight">\(Dv\)</span>. <span class="math notranslate nohighlight">\(V\)</span> is converted into <span class="math notranslate nohighlight">\(P\)</span> with a rate of
conversion <span class="math notranslate nohighlight">\(k\)</span>. <span class="math notranslate nohighlight">\(f\)</span> represents the rate of the process
that feeds <span class="math notranslate nohighlight">\(U\)</span> and drains <span class="math notranslate nohighlight">\(U\)</span>, <span class="math notranslate nohighlight">\(V\)</span> and
<span class="math notranslate nohighlight">\(P\)</span>. This can be written as:</p>
<table class="colwidths-given table">
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Chemical reaction</p></th>
<th class="head"><p>Equations</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><span class="math notranslate nohighlight">\(U + 2V  \rightarrow 3V\)</span></p></td>
<td><p><span class="math notranslate nohighlight">\(\dot{u} = Du \nabla^2 u - uv^2 + f(1-u)\)</span></p></td>
</tr>
<tr class="row-odd"><td><p><span class="math notranslate nohighlight">\(V  \rightarrow P\)</span></p></td>
<td><p><span class="math notranslate nohighlight">\(\dot{v} = Dv \nabla^2 v + uv^2 - (f+k)v\)</span></p></td>
</tr>
</tbody>
</table>
<p>Based on the Game of Life example, try to implement such reaction-diffusion system.
Here is a set of interesting parameters to test:</p>
<table class="table">
<colgroup>
<col style="width: 39%" />
<col style="width: 15%" />
<col style="width: 15%" />
<col style="width: 15%" />
<col style="width: 15%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Name</p></th>
<th class="head"><p>Du</p></th>
<th class="head"><p>Dv</p></th>
<th class="head"><p>f</p></th>
<th class="head"><p>k</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Bacteria 1</p></td>
<td><p>0.16</p></td>
<td><p>0.08</p></td>
<td><p>0.035</p></td>
<td><p>0.065</p></td>
</tr>
<tr class="row-odd"><td><p>Bacteria 2</p></td>
<td><p>0.14</p></td>
<td><p>0.06</p></td>
<td><p>0.035</p></td>
<td><p>0.065</p></td>
</tr>
<tr class="row-even"><td><p>Coral</p></td>
<td><p>0.16</p></td>
<td><p>0.08</p></td>
<td><p>0.060</p></td>
<td><p>0.062</p></td>
</tr>
<tr class="row-odd"><td><p>Fingerprint</p></td>
<td><p>0.19</p></td>
<td><p>0.05</p></td>
<td><p>0.060</p></td>
<td><p>0.062</p></td>
</tr>
<tr class="row-even"><td><p>Spirals</p></td>
<td><p>0.10</p></td>
<td><p>0.10</p></td>
<td><p>0.018</p></td>
<td><p>0.050</p></td>
</tr>
<tr class="row-odd"><td><p>Spirals Dense</p></td>
<td><p>0.12</p></td>
<td><p>0.08</p></td>
<td><p>0.020</p></td>
<td><p>0.050</p></td>
</tr>
<tr class="row-even"><td><p>Spirals Fast</p></td>
<td><p>0.10</p></td>
<td><p>0.16</p></td>
<td><p>0.020</p></td>
<td><p>0.050</p></td>
</tr>
<tr class="row-odd"><td><p>Unstable</p></td>
<td><p>0.16</p></td>
<td><p>0.08</p></td>
<td><p>0.020</p></td>
<td><p>0.055</p></td>
</tr>
<tr class="row-even"><td><p>Worms 1</p></td>
<td><p>0.16</p></td>
<td><p>0.08</p></td>
<td><p>0.050</p></td>
<td><p>0.065</p></td>
</tr>
<tr class="row-odd"><td><p>Worms 2</p></td>
<td><p>0.16</p></td>
<td><p>0.08</p></td>
<td><p>0.054</p></td>
<td><p>0.063</p></td>
</tr>
<tr class="row-even"><td><p>Zebrafish</p></td>
<td><p>0.16</p></td>
<td><p>0.08</p></td>
<td><p>0.035</p></td>
<td><p>0.060</p></td>
</tr>
</tbody>
</table>
<p>The figure below shows some animations of the model for a specific set of parameters.</p>
<div class="legend admonition">
<p class="admonition-title"><strong>Figure 4.4</strong></p>
<p>Reaction-diffusion Gray-Scott model. From left to right, <em>Bacteria 1</em>, <em>Coral</em> and
<em>Spiral Dense</em>.</p>
</div>
<video width="33%" controls>
<source src="data/gray-scott-1.mp4" type="video/mp4">
Your browser does not support the video tag. </video>

<video width="33%" controls>
<source src="data/gray-scott-2.mp4" type="video/mp4">
Your browser does not support the video tag. </video>

<video width="33%" controls>
<source src="data/gray-scott-3.mp4" type="video/mp4">
Your browser does not support the video tag. </video></div>
<div class="section" id="sources">
<h3><a class="toc-backref" href="#id18">Sources</a><a class="headerlink" href="#sources" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p><a class="reference external" href="code/game_of_life_python.py">game_of_life_python.py</a></p></li>
<li><p><a class="reference external" href="code/game_of_life_numpy.py">game_of_life_numpy.py</a></p></li>
<li><p><a class="reference external" href="code/gray_scott.py">gray_scott.py</a> (solution to the exercise)</p></li>
</ul>
</div>
<div class="section" id="references">
<h3><a class="toc-backref" href="#id19">References</a><a class="headerlink" href="#references" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p><a class="reference external" href="https://web.archive.org/web/20090603015231/http://ddi.cs.uni-potsdam.de/HyFISCH/Produzieren/lis_projekt/proj_gamelife/ConwayScientificAmerican.htm">John Conway new solitaire game “life”</a>, Martin Gardner, Scientific American 223, 1970.</p></li>
<li><p><a class="reference external" href="http://groups.csail.mit.edu/mac/projects/amorphous/GrayScott/">Gray Scott Model of Reaction Diffusion</a>, Abelson, Adams, Coore, Hanson, Nagpal, Sussman, 1997.</p></li>
<li><p><a class="reference external" href="http://mrob.com/pub/comp/xmorphia/">Reaction-Diffusion by the Gray-Scott Model</a>,
Robert P. Munafo, 1996.</p></li>
</ul>
</div>
</div>
<div class="section" id="temporal-vectorization">
<h2><a class="toc-backref" href="#id20">Temporal vectorization</a><a class="headerlink" href="#temporal-vectorization" title="Permalink to this headline">¶</a></h2>
<p>The Mandelbrot set is the set of complex numbers <span class="math notranslate nohighlight">\(c\)</span> for which
the function <span class="math notranslate nohighlight">\(f_c(z) = z^2+ c\)</span> does not diverge when iterated
from <span class="math notranslate nohighlight">\(z=0\)</span>, i.e., for which the sequence <span class="math notranslate nohighlight">\(f_c(0),
f_c(f_c(0))\)</span>, etc., remains bounded in absolute value. It is very easy
to compute, but it can take a very long time because you need to
ensure a given number does not diverge. This is generally done by
iterating the computation up to a maximum number of iterations, after
which, if the number is still within some bounds, it is considered
non-divergent. Of course, the more iterations you do, the more
precision you get.</p>
<div class="legend admonition">
<p class="admonition-title"><strong>Figure 4.5</strong></p>
<p>Romanesco broccoli, showing self-similar form approximating a natural fractal.
Image by <a class="reference external" href="https://commons.wikimedia.org/wiki/File:Fractal_Broccoli.jpg">Jon Sullivan</a>, 2004.</p>
</div>
<a class="bordered reference internal image-reference" href="_images/Fractal-Broccoli-cropped.jpg"><img alt="_images/Fractal-Broccoli-cropped.jpg" class="bordered" src="_images/Fractal-Broccoli-cropped.jpg" style="width: 100%;" /></a>
<div class="section" id="id1">
<h3><a class="toc-backref" href="#id21">Python implementation</a><a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<p>A pure python implementation is written as:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">mandelbrot_python</span><span class="p">(</span><span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span><span class="p">,</span> <span class="n">xn</span><span class="p">,</span> <span class="n">yn</span><span class="p">,</span> <span class="n">maxiter</span><span class="p">,</span> <span class="n">horizon</span><span class="o">=</span><span class="mf">2.0</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">mandelbrot</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">maxiter</span><span class="p">):</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">z</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">maxiter</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">z</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">horizon</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">n</span>
            <span class="n">z</span> <span class="o">=</span> <span class="n">z</span><span class="o">*</span><span class="n">z</span> <span class="o">+</span> <span class="n">c</span>
        <span class="k">return</span> <span class="n">maxiter</span>
    <span class="n">r1</span> <span class="o">=</span> <span class="p">[</span><span class="n">xmin</span><span class="o">+</span><span class="n">i</span><span class="o">*</span><span class="p">(</span><span class="n">xmax</span><span class="o">-</span><span class="n">xmin</span><span class="p">)</span><span class="o">/</span><span class="n">xn</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">xn</span><span class="p">)]</span>
    <span class="n">r2</span> <span class="o">=</span> <span class="p">[</span><span class="n">ymin</span><span class="o">+</span><span class="n">i</span><span class="o">*</span><span class="p">(</span><span class="n">ymax</span><span class="o">-</span><span class="n">ymin</span><span class="p">)</span><span class="o">/</span><span class="n">yn</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">yn</span><span class="p">)]</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">mandelbrot</span><span class="p">(</span><span class="nb">complex</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">i</span><span class="p">),</span><span class="n">maxiter</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">r1</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">r2</span><span class="p">]</span>
</pre></div>
</div>
<p>The interesting (and slow) part of this code is the <cite>mandelbrot</cite> function that
actually computes the sequence <span class="math notranslate nohighlight">\(f_c(f_c(f_c ...)))\)</span>. The vectorization of
such code is not totally straightforward because the internal <cite>return</cite> implies a
differential processing of the element. Once it has diverged, we don’t need to
iterate any more and we can safely return the iteration count at
divergence. The problem is to then do the same in NumPy. But how?</p>
</div>
<div class="section" id="id2">
<h3><a class="toc-backref" href="#id22">NumPy implementation</a><a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h3>
<p>The trick is to search at each iteration values that have not yet
diverged and update relevant information for these values and only
these values. Because we start from <span class="math notranslate nohighlight">\(Z = 0\)</span>, we know that each
value will be updated at least once (when they’re equal to <span class="math notranslate nohighlight">\(0\)</span>,
they have not yet diverged) and will stop being updated as soon as
they’ve diverged. To do that, we’ll use NumPy fancy indexing with the
<cite>less(x1,x2)</cite> function that return the truth value of <cite>(x1 &lt; x2)</cite>
element-wise.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">mandelbrot_numpy</span><span class="p">(</span><span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span><span class="p">,</span> <span class="n">xn</span><span class="p">,</span> <span class="n">yn</span><span class="p">,</span> <span class="n">maxiter</span><span class="p">,</span> <span class="n">horizon</span><span class="o">=</span><span class="mf">2.0</span><span class="p">):</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">xn</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span><span class="p">,</span> <span class="n">yn</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">C</span> <span class="o">=</span> <span class="n">X</span> <span class="o">+</span> <span class="n">Y</span><span class="p">[:,</span><span class="kc">None</span><span class="p">]</span><span class="o">*</span><span class="mi">1</span><span class="n">j</span>
    <span class="n">N</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">C</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">C</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">complex64</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">maxiter</span><span class="p">):</span>
        <span class="n">I</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">less</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">Z</span><span class="p">),</span> <span class="n">horizon</span><span class="p">)</span>
        <span class="n">N</span><span class="p">[</span><span class="n">I</span><span class="p">]</span> <span class="o">=</span> <span class="n">n</span>
        <span class="n">Z</span><span class="p">[</span><span class="n">I</span><span class="p">]</span> <span class="o">=</span> <span class="n">Z</span><span class="p">[</span><span class="n">I</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">C</span><span class="p">[</span><span class="n">I</span><span class="p">]</span>
    <span class="n">N</span><span class="p">[</span><span class="n">N</span> <span class="o">==</span> <span class="n">maxiter</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="n">Z</span><span class="p">,</span> <span class="n">N</span>
</pre></div>
</div>
<p>Here is the benchmark:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">xn</span> <span class="o">=</span> <span class="o">-</span><span class="mf">2.25</span><span class="p">,</span> <span class="o">+</span><span class="mf">0.75</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="mi">3000</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span><span class="p">,</span> <span class="n">yn</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.25</span><span class="p">,</span> <span class="o">+</span><span class="mf">1.25</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="mi">2500</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">maxiter</span> <span class="o">=</span> <span class="mi">200</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">timeit</span><span class="p">(</span><span class="s2">&quot;mandelbrot_python(xmin, xmax, ymin, ymax, xn, yn, maxiter)&quot;</span><span class="p">,</span> <span class="nb">globals</span><span class="p">())</span>
<span class="go">1 loops, best of 3: 6.1 sec per loop</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">timeit</span><span class="p">(</span><span class="s2">&quot;mandelbrot_numpy(xmin, xmax, ymin, ymax, xn, yn, maxiter)&quot;</span><span class="p">,</span> <span class="nb">globals</span><span class="p">())</span>
<span class="go">1 loops, best of 3: 1.15 sec per loop</span>
</pre></div>
</div>
</div>
<div class="section" id="faster-numpy-implementation">
<h3><a class="toc-backref" href="#id23">Faster NumPy implementation</a><a class="headerlink" href="#faster-numpy-implementation" title="Permalink to this headline">¶</a></h3>
<p>The gain is roughly a 5x factor, not as much as we could have
expected. Part of the problem is that the <cite>np.less</cite> function implies
<span class="math notranslate nohighlight">\(xn \times yn\)</span> tests at every iteration while we know that some
values have already diverged. Even if these tests are performed at the
C level (through NumPy), the cost is nonetheless
significant. Another approach proposed by <a class="reference external" href="https://thesamovar.wordpress.com/">Dan Goodman</a> is to work on a dynamic array at
each iteration that stores only the points which have not yet
diverged. It requires more lines but the result is faster and leads to
a 10x factor speed improvement compared to the Python version.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">mandelbrot_numpy_2</span><span class="p">(</span><span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span><span class="p">,</span> <span class="n">xn</span><span class="p">,</span> <span class="n">yn</span><span class="p">,</span> <span class="n">itermax</span><span class="p">,</span> <span class="n">horizon</span><span class="o">=</span><span class="mf">2.0</span><span class="p">):</span>
    <span class="n">Xi</span><span class="p">,</span> <span class="n">Yi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mgrid</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">xn</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="n">yn</span><span class="p">]</span>
    <span class="n">Xi</span><span class="p">,</span> <span class="n">Yi</span> <span class="o">=</span> <span class="n">Xi</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">),</span> <span class="n">Yi</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">)</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">xn</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)[</span><span class="n">Xi</span><span class="p">]</span>
    <span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span><span class="p">,</span> <span class="n">yn</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)[</span><span class="n">Yi</span><span class="p">]</span>
    <span class="n">C</span> <span class="o">=</span> <span class="n">X</span> <span class="o">+</span> <span class="n">Y</span><span class="o">*</span><span class="mi">1</span><span class="n">j</span>
    <span class="n">N_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">C</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">)</span>
    <span class="n">Z_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">C</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">complex64</span><span class="p">)</span>
    <span class="n">Xi</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="n">Yi</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="n">C</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="n">xn</span><span class="o">*</span><span class="n">yn</span>

    <span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">C</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">complex64</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">itermax</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">Z</span><span class="p">):</span> <span class="k">break</span>

        <span class="c1"># Compute for relevant points only</span>
        <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span> <span class="n">Z</span><span class="p">,</span> <span class="n">Z</span><span class="p">)</span>
        <span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">Z</span><span class="p">)</span>

        <span class="c1"># Failed convergence</span>
        <span class="n">I</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">Z</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">horizon</span>
        <span class="n">N_</span><span class="p">[</span><span class="n">Xi</span><span class="p">[</span><span class="n">I</span><span class="p">],</span> <span class="n">Yi</span><span class="p">[</span><span class="n">I</span><span class="p">]]</span> <span class="o">=</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span>
        <span class="n">Z_</span><span class="p">[</span><span class="n">Xi</span><span class="p">[</span><span class="n">I</span><span class="p">],</span> <span class="n">Yi</span><span class="p">[</span><span class="n">I</span><span class="p">]]</span> <span class="o">=</span> <span class="n">Z</span><span class="p">[</span><span class="n">I</span><span class="p">]</span>

        <span class="c1"># Keep going with those who have not diverged yet</span>
        <span class="n">np</span><span class="o">.</span><span class="n">negative</span><span class="p">(</span><span class="n">I</span><span class="p">,</span><span class="n">I</span><span class="p">)</span>
        <span class="n">Z</span> <span class="o">=</span> <span class="n">Z</span><span class="p">[</span><span class="n">I</span><span class="p">]</span>
        <span class="n">Xi</span><span class="p">,</span> <span class="n">Yi</span> <span class="o">=</span> <span class="n">Xi</span><span class="p">[</span><span class="n">I</span><span class="p">],</span> <span class="n">Yi</span><span class="p">[</span><span class="n">I</span><span class="p">]</span>
        <span class="n">C</span> <span class="o">=</span> <span class="n">C</span><span class="p">[</span><span class="n">I</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">Z_</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">N_</span><span class="o">.</span><span class="n">T</span>
</pre></div>
</div>
<p>The benchmark gives us:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">timeit</span><span class="p">(</span><span class="s2">&quot;mandelbrot_numpy_2(xmin, xmax, ymin, ymax, xn, yn, maxiter)&quot;</span><span class="p">,</span> <span class="nb">globals</span><span class="p">())</span>
<span class="go">1 loops, best of 3: 510 msec per loop</span>
</pre></div>
</div>
</div>
<div class="section" id="visualization">
<h3><a class="toc-backref" href="#id24">Visualization</a><a class="headerlink" href="#visualization" title="Permalink to this headline">¶</a></h3>
<p>In order to visualize our results, we could directly display the <cite>N</cite> array
using the matplotlib <cite>imshow</cite> command, but this would result in a “banded” image
that is a known consequence of the escape count algorithm that we’ve been
using. Such banding can be eliminated by using a fractional escape count. This
can be done by measuring how far the iterated point landed outside of the
escape cutoff. See the reference below about the renormalization of the escape
count. Here is a picture of the result where we use recount normalization,
and added a power normalized color map (gamma=0.3) as well as light shading.</p>
<div class="legend admonition">
<p class="admonition-title"><strong>Figure 4.6</strong></p>
<p>The Mandelbrot as rendered by matplotlib using recount normalization, power
normalized color map (gamma=0.3) and light shading.</p>
</div>
<div class="figure align-default">
<a class="bordered reference internal image-reference" href="_images/mandelbrot.png"><img alt="_images/mandelbrot.png" class="bordered" src="_images/mandelbrot.png" style="width: 100%;" /></a>
</div>
</div>
<div class="section" id="id3">
<h3><a class="toc-backref" href="#id25">Exercise</a><a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h3>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>You should look at the <a class="reference external" href="https://docs.scipy.org/doc/numpy/reference/generated/numpy.ufunc.reduceat.html">ufunc.reduceat</a> method that performs a (local) reduce with specified slices over a single axis.</p>
</div>
<p>We now want to measure the fractal dimension of the Mandelbrot set using the
<a class="reference external" href="https://en.wikipedia.org/wiki/Minkowski–Bouligand_dimension">Minkowski–Bouligand dimension</a>. To do that, we
need to do box-counting with a decreasing box size (see figure below). As you
can imagine, we cannot use pure Python because it would be way too slow. The goal of
the exercise is to write a function using NumPy that takes a two-dimensional
float array and returns the dimension. We’ll consider values in the array to be
normalized (i.e. all values are between 0 and 1).</p>
<div class="legend admonition">
<p class="admonition-title"><strong>Figure 4.7</strong></p>
<p>The Minkowski–Bouligand dimension of the Great Britain coastlines is
approximately 1.24.</p>
</div>
<div class="figure align-default">
<a class="reference internal image-reference" href="_images/fractal-dimension.png"><img alt="_images/fractal-dimension.png" src="_images/fractal-dimension.png" style="width: 100%;" /></a>
</div>
</div>
<div class="section" id="id4">
<h3><a class="toc-backref" href="#id26">Sources</a><a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p><a class="reference external" href="code/mandelbrot.py">mandelbrot.py</a></p></li>
<li><p><a class="reference external" href="code/mandelbrot_python.py">mandelbrot_python.py</a></p></li>
<li><p><a class="reference external" href="code/mandelbrot_numpy_1.py">mandelbrot_numpy_1.py</a></p></li>
<li><p><a class="reference external" href="code/mandelbrot_numpy_2.py">mandelbrot_numpy_2.py</a></p></li>
<li><p><a class="reference external" href="code/fractal_dimension.py">fractal_dimension.py</a> (solution to the exercise)</p></li>
</ul>
</div>
<div class="section" id="id5">
<h3><a class="toc-backref" href="#id27">References</a><a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p><a class="reference external" href="https://www.ibm.com/developerworks/community/blogs/jfp/entry/How_To_Compute_Mandelbrodt_Set_Quickly?lang=en">How To Quickly Compute the Mandelbrot Set in Python</a>, Jean Francois Puget, 2015.</p></li>
<li><p><a class="reference external" href="https://www.ibm.com/developerworks/community/blogs/jfp/entry/My_Christmas_Gift?lang=en">My Christmas Gift: Mandelbrot Set Computation In Python</a>, Jean Francois Puget, 2015.</p></li>
<li><p><a class="reference external" href="https://thesamovar.wordpress.com/2009/03/22/fast-fractals-with-python-and-numpy/">Fast fractals with Python and NumPy</a>, Dan Goodman, 2009.</p></li>
<li><p><a class="reference external" href="http://linas.org/art-gallery/escape/escape.html">Renormalizing the Mandelbrot Escape</a>, Linas Vepstas, 1997.</p></li>
</ul>
</div>
</div>
<div class="section" id="spatial-vectorization">
<h2><a class="toc-backref" href="#id28">Spatial vectorization</a><a class="headerlink" href="#spatial-vectorization" title="Permalink to this headline">¶</a></h2>
<p>Spatial vectorization refers to a situation where elements share the same
computation but are in interaction with only a subgroup of other elements. This
was already the case for the game of life example, but in some situations
there is an added difficulty because the subgroup is dynamic and needs to be
updated at each iteration. This the case, for example, in particle systems where
particles interact mostly with local neighbours. This is also the case for
“boids” that simulate flocking behaviors.</p>
<div class="legend admonition">
<p class="admonition-title"><strong>Figure 4.8</strong></p>
<p>Flocking birds are an example of self-organization in biology.
Image by <a class="reference external" href="https://commons.wikimedia.org/wiki/File:Fugle,_ørnsø_073.jpg">Christoffer A Rasmussen</a>, 2012.</p>
</div>
<a class="bordered reference internal image-reference" href="_images/Fugle-cropped.jpg"><img alt="_images/Fugle-cropped.jpg" class="bordered" src="_images/Fugle-cropped.jpg" style="width: 100%;" /></a>
<div class="section" id="boids">
<h3><a class="toc-backref" href="#id29">Boids</a><a class="headerlink" href="#boids" title="Permalink to this headline">¶</a></h3>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Excerpt from the Wikipedia entry
<a class="reference external" href="https://en.wikipedia.org/wiki/Boids">Boids</a></p>
</div>
<p>Boids is an artificial life program, developed by Craig Reynolds in 1986, which
simulates the flocking behaviour of birds. The name “boid” corresponds to a
shortened version of “bird-oid object”, which refers to a bird-like object.</p>
<p>As with most artificial life simulations, Boids is an example of emergent
behavior; that is, the complexity of Boids arises from the interaction of
individual agents (the boids, in this case) adhering to a set of simple
rules. The rules applied in the simplest Boids world are as follows:</p>
<ul class="simple">
<li><p><strong>separation</strong>: steer to avoid crowding local flock-mates</p></li>
<li><p><strong>alignment</strong>: steer towards the average heading of local flock-mates</p></li>
<li><p><strong>cohesion</strong>: steer to move toward the average position (center of mass) of
local flock-mates</p></li>
</ul>
<div class="legend admonition">
<p class="admonition-title"><strong>Figure 4.9</strong></p>
<p>Boids are governed by a set of three local rules (separation, cohesion and
alignment) that serve as computing velocity and acceleration.</p>
</div>
<a class="reference internal image-reference" href="_images/boids.png"><img alt="_images/boids.png" src="_images/boids.png" style="width: 100%;" /></a>
</div>
<div class="section" id="id7">
<h3><a class="toc-backref" href="#id30">Python implementation</a><a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h3>
<p>Since each boid is an autonomous entity with several properties such as
position and velocity, it seems natural to start by writing a Boid class:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">from</span> <span class="nn">vec2</span> <span class="kn">import</span> <span class="n">vec2</span>

<span class="k">class</span> <span class="nc">Boid</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="n">vec2</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
        <span class="n">angle</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">velocity</span> <span class="o">=</span> <span class="n">vec2</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">angle</span><span class="p">),</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">angle</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">acceleration</span> <span class="o">=</span> <span class="n">vec2</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
<p>The <cite>vec2</cite> object is a very simple class that handles all common vector
operations with 2 components. It will save us some writing in the main <cite>Boid</cite>
class. Note that there are some vector packages in the Python Package Index, but
that would be overkill for such a simple example.</p>
<p>Boid is a difficult case for regular Python because a boid has interaction with
local neighbours. However, and because boids are moving, to find such local
neighbours requires computing at each time step the distance to each and every
other boid in order to sort those which are in a given interaction radius. The
prototypical way of writing the three rules is thus something like:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">separation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">boids</span><span class="p">):</span>
    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">other</span> <span class="ow">in</span> <span class="n">boids</span><span class="p">:</span>
        <span class="n">d</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">position</span> <span class="o">-</span> <span class="n">other</span><span class="o">.</span><span class="n">position</span><span class="p">)</span><span class="o">.</span><span class="n">length</span><span class="p">()</span>
        <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">d</span> <span class="o">&lt;</span> <span class="n">desired_separation</span><span class="p">:</span>
            <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="o">...</span>
    <span class="k">if</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="o">...</span>

 <span class="k">def</span> <span class="nf">alignment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">boids</span><span class="p">):</span> <span class="o">...</span>
 <span class="k">def</span> <span class="nf">cohesion</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">boids</span><span class="p">):</span> <span class="o">...</span>
</pre></div>
</div>
<p>Full sources are given in the references section below, it would be too long to
describe it here and there is no real difficulty.</p>
<p>To complete the picture, we can also create a <cite>Flock</cite> object:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Flock</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="mi">150</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">boids</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">count</span><span class="p">):</span>
            <span class="n">boid</span> <span class="o">=</span> <span class="n">Boid</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">boids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">boid</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">boid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">boids</span><span class="p">:</span>
            <span class="n">boid</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">boids</span><span class="p">)</span>
</pre></div>
</div>
<p>Using this approach, we can have up to 50 boids until the computation
time becomes too slow for a smooth animation. As you may have guessed,
we can do much better using NumPy, but let me first point out the main
problem with this Python implementation. If you look at the code, you
will certainly notice there is a lot of redundancy. More precisely, we
do not exploit the fact that the Euclidean distance is reflexive, that
is, <span class="math notranslate nohighlight">\(|x-y| = |y-x|\)</span>. In this naive Python implementation, each
rule (function) computes <span class="math notranslate nohighlight">\(n^2\)</span> distances while
<span class="math notranslate nohighlight">\(\frac{n^2}{2}\)</span> would be sufficient if properly
cached. Furthermore, each rule re-computes every distance without
caching the result for the other functions. In the end, we are
computing <span class="math notranslate nohighlight">\(3n^2\)</span> distances instead of <span class="math notranslate nohighlight">\(\frac{n^2}{2}\)</span>.</p>
</div>
<div class="section" id="id8">
<h3><a class="toc-backref" href="#id31">NumPy implementation</a><a class="headerlink" href="#id8" title="Permalink to this headline">¶</a></h3>
<p>As you might expect, the NumPy implementation takes a different approach and
we’ll gather all our boids into a <cite>position</cite> array and a <cite>velocity</cite> array:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">n</span> <span class="o">=</span> <span class="mi">500</span>
<span class="n">velocity</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="n">position</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</pre></div>
</div>
<p>The first step is to compute the local neighborhood for all boids, and for
this we need to compute all paired distances:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">dx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">subtract</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">position</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">position</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span>
<span class="n">dy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">subtract</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">position</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">position</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span>
<span class="n">distance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hypot</span><span class="p">(</span><span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">)</span>
</pre></div>
</div>
<p>We could have used the scipy <a class="reference external" href="https://docs.scipy.org/doc/scipy/reference/generated/scipy.spatial.distance.cdist.html">cdist</a>
but we’ll need the <cite>dx</cite> and <cite>dy</cite> arrays later. Once those have been computed,
it is faster to use the <a class="reference external" href="https://docs.scipy.org/doc/numpy/reference/generated/numpy.hypot.html">hypot</a>
method. Note that distance shape is <cite>(n, n)</cite> and each line relates to one boid,
i.e. each line gives the distance to all other boids (including self).</p>
<p>From theses distances, we can now compute the local neighborhood for
each of the three rules, taking advantage of the fact that we can mix
them together. We can actually compute a mask for distances that are
strictly positive (i.e. have no self-interaction) and multiply it with
other distance masks.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If we suppose that boids cannot occupy the same position, how can you
compute <cite>mask_0</cite> more efficiently?</p>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">mask_0</span> <span class="o">=</span> <span class="p">(</span><span class="n">distance</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">mask_1</span> <span class="o">=</span> <span class="p">(</span><span class="n">distance</span> <span class="o">&lt;</span> <span class="mi">25</span><span class="p">)</span>
<span class="n">mask_2</span> <span class="o">=</span> <span class="p">(</span><span class="n">distance</span> <span class="o">&lt;</span> <span class="mi">50</span><span class="p">)</span>
<span class="n">mask_1</span> <span class="o">*=</span> <span class="n">mask_0</span>
<span class="n">mask_2</span> <span class="o">*=</span> <span class="n">mask_0</span>
<span class="n">mask_3</span> <span class="o">=</span> <span class="n">mask_2</span>
</pre></div>
</div>
<p>Then, we compute the number of neighbours within the given radius and we ensure
it is at least 1 to avoid division by zero.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">mask_1_count</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">mask_1</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">mask_2_count</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">mask_2</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">mask_3_count</span> <span class="o">=</span> <span class="n">mask_2_count</span>
</pre></div>
</div>
<p>We’re ready to write our three rules:</p>
<p><strong>Alignment</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Compute the average velocity of local neighbours</span>
<span class="n">target</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">velocity</span><span class="p">)</span><span class="o">/</span><span class="n">count</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="c1"># Normalize the result</span>
<span class="n">norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">target</span><span class="o">*</span><span class="n">target</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">norm</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">target</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="n">norm</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>

<span class="c1"># Alignment at constant speed</span>
<span class="n">target</span> <span class="o">*=</span> <span class="n">max_velocity</span>

<span class="c1"># Compute the resulting steering</span>
<span class="n">alignment</span> <span class="o">=</span> <span class="n">target</span> <span class="o">-</span> <span class="n">velocity</span>
</pre></div>
</div>
<p><strong>Cohesion</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Compute the gravity center of local neighbours</span>
<span class="n">center</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">position</span><span class="p">)</span><span class="o">/</span><span class="n">count</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="c1"># Compute direction toward the center</span>
<span class="n">target</span> <span class="o">=</span> <span class="n">center</span> <span class="o">-</span> <span class="n">position</span>

<span class="c1"># Normalize the result</span>
<span class="n">norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">target</span><span class="o">*</span><span class="n">target</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">norm</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">target</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="n">norm</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>

<span class="c1"># Cohesion at constant speed (max_velocity)</span>
<span class="n">target</span> <span class="o">*=</span> <span class="n">max_velocity</span>

<span class="c1"># Compute the resulting steering</span>
<span class="n">cohesion</span> <span class="o">=</span> <span class="n">target</span> <span class="o">-</span> <span class="n">velocity</span>
</pre></div>
</div>
<p><strong>Separation</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Compute the repulsion force from local neighbours</span>
<span class="n">repulsion</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dstack</span><span class="p">((</span><span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">))</span>

<span class="c1"># Force is inversely proportional to the distance</span>
<span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">repulsion</span><span class="p">,</span> <span class="n">distance</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">repulsion</span><span class="p">,</span>
          <span class="n">where</span><span class="o">=</span><span class="n">distance</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>

<span class="c1"># Compute direction away from others</span>
<span class="n">target</span> <span class="o">=</span> <span class="p">(</span><span class="n">repulsion</span><span class="o">*</span><span class="n">mask</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">count</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="c1"># Normalize the result</span>
<span class="n">norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">target</span><span class="o">*</span><span class="n">target</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">norm</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">target</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="n">norm</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>

<span class="c1"># Separation at constant speed (max_velocity)</span>
<span class="n">target</span> <span class="o">*=</span> <span class="n">max_velocity</span>

<span class="c1"># Compute the resulting steering</span>
<span class="n">separation</span> <span class="o">=</span> <span class="n">target</span> <span class="o">-</span> <span class="n">velocity</span>
</pre></div>
</div>
<p>All three resulting steerings (separation, alignment &amp; cohesion) need to
be limited in magnitude. We leave this as an exercise for the reader. Combination
of these rules is straightforward as well as the resulting update of
velocity and position:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">acceleration</span> <span class="o">=</span> <span class="mf">1.5</span> <span class="o">*</span> <span class="n">separation</span> <span class="o">+</span> <span class="n">alignment</span> <span class="o">+</span> <span class="n">cohesion</span>
<span class="n">velocity</span> <span class="o">+=</span> <span class="n">acceleration</span>
<span class="n">position</span> <span class="o">+=</span> <span class="n">velocity</span>
</pre></div>
</div>
<p>We finally visualize the result using a custom oriented scatter plot.</p>
<div class="legend admonition">
<p class="admonition-title"><strong>Figure 4.10</strong></p>
<p>Boids is an artificial life program, developed by Craig Reynolds in 1986,
which simulates the flocking behaviour of birds.</p>
</div>
<video width="100%" class="bordered" controls>
<source src="data/boids.mp4" type="video/mp4">
Your browser does not support the video tag. </video></div>
<div class="section" id="id9">
<h3><a class="toc-backref" href="#id32">Exercise</a><a class="headerlink" href="#id9" title="Permalink to this headline">¶</a></h3>
<p>We are now ready to visualize our boids. The easiest way is to use the
matplotlib animation function and a scatter plot. Unfortunately, scatters
cannot be individually oriented and we need to make our own objects using a
matplotlib <cite>PathCollection</cite>. A simple triangle path can be defined as:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">v</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([(</span><span class="o">-</span><span class="mf">0.25</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.25</span><span class="p">),</span>
             <span class="p">(</span> <span class="mf">0.00</span><span class="p">,</span>  <span class="mf">0.50</span><span class="p">),</span>
             <span class="p">(</span> <span class="mf">0.25</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.25</span><span class="p">),</span>
             <span class="p">(</span> <span class="mf">0.00</span><span class="p">,</span>  <span class="mf">0.00</span><span class="p">)])</span>
<span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">Path</span><span class="o">.</span><span class="n">MOVETO</span><span class="p">,</span>
              <span class="n">Path</span><span class="o">.</span><span class="n">LINETO</span><span class="p">,</span>
              <span class="n">Path</span><span class="o">.</span><span class="n">LINETO</span><span class="p">,</span>
              <span class="n">Path</span><span class="o">.</span><span class="n">CLOSEPOLY</span><span class="p">])</span>
</pre></div>
</div>
<p>This path can be repeated several times inside an array and each triangle can
be made independent.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">n</span> <span class="o">=</span> <span class="mi">500</span>
<span class="n">vertices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">n</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">codes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">n</span><span class="p">)</span>
</pre></div>
</div>
<p>We now have a <cite>(n,4,2)</cite> array for vertices and a <cite>(n,4)</cite> array for codes
representing <cite>n</cite> boids. We are interested in manipulating the vertices array to
reflect the translation, scaling and rotation of each of the <cite>n</cite> boids.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Rotate is really tricky.</p>
</div>
<p>How would you write the <cite>translate</cite>, <cite>scale</cite> and <cite>rotate</cite> functions ?</p>
</div>
<div class="section" id="id10">
<h3><a class="toc-backref" href="#id33">Sources</a><a class="headerlink" href="#id10" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p><a class="reference external" href="code/boid_python.py">boid_python.py</a></p></li>
<li><p><a class="reference external" href="code/boid_numpy.py">boid_numpy.py</a> (solution to the exercise)</p></li>
</ul>
</div>
<div class="section" id="id11">
<h3><a class="toc-backref" href="#id34">References</a><a class="headerlink" href="#id11" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p><a class="reference external" href="https://processing.org/examples/flocking.html">Flocking</a>, Daniel Shiffman, 2010.</p></li>
<li><p><a class="reference external" href="http://www.red3d.com/cwr/boids/">Flocks, herds and schools: A distributed behavioral model</a>, Craig Reynolds, SIGGRAPH, 1987</p></li>
</ul>
</div>
</div>
<div class="section" id="conclusion">
<h2><a class="toc-backref" href="#id35">Conclusion</a><a class="headerlink" href="#conclusion" title="Permalink to this headline">¶</a></h2>
<p>We’ve seen through these examples three forms of code vectorization:</p>
<ul class="simple">
<li><p>Uniform vectorization where elements share the same computation
unconditionally and for the same duration.</p></li>
<li><p>Temporal vectorization where elements share the same computation but
necessitate a different number of iterations.</p></li>
<li><p>Spatial vectorization where elements share the same computation but on
dynamic spatial arguments.</p></li>
</ul>
<p>And there are probably many more forms of such direct code vectorization. As
explained before, this kind of vectorization is one of the most simple even
though we’ve seen it can be really tricky to implement and requires some
experience, some help or both. For example, the solution to the boids exercise
was provided by <a class="reference external" href="http://stackoverflow.com/users/3293881/divakar">Divakar</a> on
<a class="reference external" href="http://stackoverflow.com/questions/40822983/multiple-individual-2d-rotation-at-once">stack overflow</a> after having explained my problem.</p>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
        
        <div class='prev-next-bottom'>
            
    <a class='left-prev' id="prev-link" href="03-anatomy.html" title="previous page">Anatomy of an array</a>
    <a class='right-next' id="next-link" href="05-problem-vectorization.html" title="next page">Problem vectorization</a>

        </div>
        
        </div>
    </div>
    <footer class="footer mt-5 mt-md-0">
    <div class="container">
      <p>
        
          By Nicolas P. Rougier; Loïc Houpert<br/>
        
            &copy; Copyright 2021.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>
  
  <script src="_static/js/index.1c5a1a01449ed65a7b51.js"></script>

  
  </body>
</html>