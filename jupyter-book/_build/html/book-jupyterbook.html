
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta content="An open-source book about numpy vectorization techniques, based on experience, practice and descriptive examples" name="description" />
<meta content="width=device-width, initial-scale=1, maximum-scale=1" name="viewport" />

    <title>From Python to Numpy &#8212; From Python to Numpy</title>
    
  <link href="_static/css/theme.css" rel="stylesheet" />
  <link href="_static/css/index.c5995385ac14fb8791e8eb36b4908be2.css" rel="stylesheet" />

    
  <link rel="stylesheet"
    href="_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="_static/sphinx-book-theme.acff12b8f9c144ce68a297486a2fa670.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="_static/js/index.1c5a1a01449ed65a7b51.js">

    <script id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/togglebutton.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script >var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="_static/sphinx-book-theme.12a9622fbb08dcb3a2a40b2c02b83a57.js"></script>
    <script async="async" src="https://unpkg.com/thebelab@latest/lib/index.js"></script>
    <script >
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="_static/sphinx-thebe.js"></script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["\\(", "\\)"]], "displayMath": [["\\[", "\\]"]], "processRefs": false, "processEnvironments": false}})</script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Preface" href="01-preface-with-jupyter-book.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="index.html">
      
      <img src="_static/cubes.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">From Python to Numpy</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
    <div class="bd-toc-item active">
        <ul class="nav bd-sidenav">
 <li class="toctree-l1 current">
  <a class="reference internal" href="#">
   From Python to Numpy
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="01-preface-with-jupyter-book.html">
   Preface
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="02-introduction.html">
   Introduction
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="03-anatomy.html">
   Anatomy of an array
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="04-code-vectorization.html">
   Code vectorization
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="05-problem-vectorization.html">
   Problem vectorization
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="06-custom-vectorization.html">
   Custom vectorization
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="07-beyond-numpy.html">
   Beyond NumPy
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="08-conclusion.html">
   Conclusion
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="09-quick-reference.html">
   Quick References
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="10-bibliography.html">
   Bibliography
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="_sources/book-jupyterbook.rst"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.rst</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#preface">
   Preface
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#about-the-author">
     About the author
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#about-this-book">
     About this book
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#about-the-jupyter-book">
       About the Jupyter Book
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#prerequisites">
       Prerequisites
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#conventions">
       Conventions
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#how-to-contribute">
       How to contribute
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#publishing">
       Publishing
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#license">
     License
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#introduction">
   Introduction
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#simple-example">
     Simple example
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#readability-vs-speed">
     Readability vs speed
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#anatomy-of-an-array">
   Anatomy of an array
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id5">
     Introduction
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#memory-layout">
     Memory layout
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#views-and-copies">
     Views and copies
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#direct-and-indirect-access">
       Direct and indirect access
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#temporary-copy">
       Temporary copy
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#conclusion">
     Conclusion
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#code-vectorization">
   Code vectorization
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id7">
     Introduction
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#uniform-vectorization">
     Uniform vectorization
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#the-game-of-life">
       The Game of Life
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#python-implementation">
       Python implementation
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#numpy-implementation">
       NumPy implementation
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#exercise">
       Exercise
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#sources">
       Sources
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#references">
       References
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#temporal-vectorization">
     Temporal vectorization
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#id8">
       Python implementation
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#id9">
       NumPy implementation
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#faster-numpy-implementation">
       Faster NumPy implementation
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#visualization">
       Visualization
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#id10">
       Exercise
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#id11">
       Sources
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#id12">
       References
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#spatial-vectorization">
     Spatial vectorization
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#boids">
       Boids
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#id14">
       Python implementation
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#id15">
       NumPy implementation
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#id16">
       Exercise
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#id17">
       Sources
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#id18">
       References
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id19">
     Conclusion
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#problem-vectorization">
   Problem vectorization
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id21">
     Introduction
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#path-finding">
     Path finding
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#building-a-maze">
       Building a maze
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#breadth-first">
       Breadth-first
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#bellman-ford-method">
       Bellman-Ford method
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#id22">
       Sources
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#id23">
       References
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#fluid-dynamics">
     Fluid Dynamics
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#lagrangian-vs-eulerian-method">
       Lagrangian vs Eulerian method
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#id24">
       NumPy implementation
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#id25">
       Sources
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#id26">
       References
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#blue-noise-sampling">
     Blue noise sampling
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#dart-method">
       DART method
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#bridson-method">
       Bridson method
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#id27">
       Sources
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#id28">
       References
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id29">
     Conclusion
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#custom-vectorization">
   Custom vectorization
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id31">
     Introduction
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#typed-list">
     Typed list
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#creation">
       Creation
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#access">
       Access
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#id33">
       Exercise
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#id34">
       Sources
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#memory-aware-array">
     Memory aware array
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#id35">
       Glumpy
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#array-subclass">
       Array subclass
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#computing-extents">
       Computing extents
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#keeping-track-of-pending-data">
       Keeping track of pending data
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#id37">
       Sources
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id38">
     Conclusion
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#beyond-numpy">
   Beyond NumPy
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#back-to-python">
     Back to Python
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#numpy-co">
     NumPy &amp; co
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#numexpr">
       NumExpr
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#cython">
       Cython
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#numba">
       Numba
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#theano">
       Theano
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#pycuda">
       PyCUDA
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#pyopencl">
       PyOpenCL
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#scipy-co">
     Scipy &amp; co
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#scikit-learn">
       scikit-learn
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#scikit-image">
       scikit-image
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#sympy">
       SymPy
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#astropy">
       Astropy
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#cartopy">
       Cartopy
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#brian">
       Brian
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#id52">
       Glumpy
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id54">
     Conclusion
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#id55">
   Conclusion
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#quick-references">
   Quick References
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id58">
     Data type
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id59">
     Creation
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id60">
     Indexing
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#reshaping">
     Reshaping
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#broadcasting">
     Broadcasting
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#bibliography">
   Bibliography
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#tutorials">
     Tutorials
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#articles">
     Articles
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#books">
     Books
    </a>
   </li>
  </ul>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <div class="section" id="from-python-to-numpy">
<h1><a class="toc-backref" href="#id62">From Python to Numpy</a><a class="headerlink" href="#from-python-to-numpy" title="Permalink to this headline">¶</a></h1>
<p>Copyright (c) 2021 - Nicolas P. Rougier &lt;<a class="reference external" href="mailto:Nicolas&#46;Rougier&#37;&#52;&#48;inria&#46;fr">Nicolas<span>&#46;</span>Rougier<span>&#64;</span>inria<span>&#46;</span>fr</a>&gt;  &amp; Loïc Houpert &lt;<a class="reference external" href="mailto:loic&#37;&#52;&#48;lhoupert&#46;fr">loic<span>&#64;</span>lhoupert<span>&#46;</span>fr</a>&gt;</p>
<div class="title-logos docutils container">
<a class="reference internal image-reference" href="_images/cc.large.png"><img alt="_images/cc.large.png" src="_images/cc.large.png" style="width: 40px;" /></a>
<a class="reference internal image-reference" href="_images/by.large.png"><img alt="_images/by.large.png" src="_images/by.large.png" style="width: 40px;" /></a>
<a class="reference internal image-reference" href="_images/sa.large.png"><img alt="_images/sa.large.png" src="_images/sa.large.png" style="width: 40px;" /></a>
<a class="reference internal image-reference" href="_images/nc.large.png"><img alt="_images/nc.large.png" src="_images/nc.large.png" style="width: 40px;" /></a>
<div class="line-block">
<div class="line"><br /></div>
<div class="line">Latest version - May 2021</div>
<div class="line">DOI: <a class="reference external" href="http://doi.org/10.5281/zenodo.225783">10.5281/zenodo.225783</a></div>
</div>
</div>
<div class="title-logos docutils container">
<a class="reference internal image-reference" href="_images/cubes.png"><img alt="_images/cubes.png" src="_images/cubes.png" style="width: 100%;" /></a>
</div>
<p>There are already a fair number of books about Numpy (see <a class="reference internal" href="#bibliography">Bibliography</a>) and a
legitimate question is to wonder if another book is really necessary. As you
may have guessed by reading these lines, my personal answer is yes, mostly
because I think there is room for a different approach concentrating on the
migration from Python to Numpy through vectorization. There are a lot of
techniques that you don’t find in books and such techniques are mostly learned
through experience. The goal of this book is to explain some of these
techniques and to provide an opportunity for making this experience in the
process.</p>
<p><strong>Website:</strong> <a class="reference external" href="http://www.labri.fr/perso/nrougier/from-python-to-numpy">http://www.labri.fr/perso/nrougier/from-python-to-numpy</a></p>
<div class="contents main-content topic" id="table-of-contents">
<p class="topic-title"><strong>Table of Contents</strong></p>
<ul class="simple">
<li><p><a class="reference internal" href="#from-python-to-numpy" id="id62">From Python to Numpy</a></p>
<ul>
<li><p><a class="reference internal" href="#preface" id="id63">Preface</a></p></li>
<li><p><a class="reference internal" href="#introduction" id="id64">Introduction</a></p></li>
<li><p><a class="reference internal" href="#anatomy-of-an-array" id="id65">Anatomy of an array</a></p></li>
<li><p><a class="reference internal" href="#code-vectorization" id="id66">Code vectorization</a></p></li>
<li><p><a class="reference internal" href="#problem-vectorization" id="id67">Problem vectorization</a></p></li>
<li><p><a class="reference internal" href="#custom-vectorization" id="id68">Custom vectorization</a></p></li>
<li><p><a class="reference internal" href="#beyond-numpy" id="id69">Beyond NumPy</a></p></li>
<li><p><a class="reference internal" href="#id55" id="id70">Conclusion</a></p></li>
<li><p><a class="reference internal" href="#quick-references" id="id71">Quick References</a></p></li>
<li><p><a class="reference internal" href="#bibliography" id="id72">Bibliography</a></p></li>
</ul>
</li>
</ul>
</div>
<div class="line-block">
<div class="line"><br /></div>
<div class="line"><br /></div>
</div>
<p><strong>Disclaimer:</strong> All external pictures should have associated credits. If there
are missing credits, please tell me, I will correct it. Similarly, all excerpts
should be sourced (wikipedia mostly). If not, this is an error and I will
correct it as soon as you tell me.</p>
<p>The book is open-access (you’re reading it) but <strong>if you insist on buying it</strong>,
my advice would be to read it first and then decide if you still want to buy it
(!?). If this is the case, you can do it via <a class="reference external" href="https://www.paypal.me/NicolasPRougier/">Paypal</a>, price is free (<a class="reference external" href="https://www.paypal.me/NicolasPRougier/5">5 euros</a>, <a class="reference external" href="https://www.paypal.me/NicolasPRougier/10">10 euros</a>, <a class="reference external" href="https://www.paypal.me/NicolasPRougier/25">25 euros</a>). You won’t get anything extra but
it might help me with the writing of the upcoming <strong>Python and OpenGL for
Scientific Visualization</strong> (May 2018).</p>
<div class="section" id="preface">
<h2><a class="toc-backref" href="#id63">Preface</a><a class="headerlink" href="#preface" title="Permalink to this headline">¶</a></h2>
<div class="contents local topic" id="contents">
<p class="topic-title"><strong>Contents</strong></p>
<ul class="simple">
<li><p><a class="reference internal" href="#about-the-author" id="id73">About the author</a></p></li>
<li><p><a class="reference internal" href="#about-this-book" id="id74">About this book</a></p>
<ul>
<li><p><a class="reference internal" href="#about-the-jupyter-book" id="id75">About the Jupyter Book</a></p></li>
<li><p><a class="reference internal" href="#prerequisites" id="id76">Prerequisites</a></p></li>
<li><p><a class="reference internal" href="#conventions" id="id77">Conventions</a></p></li>
<li><p><a class="reference internal" href="#how-to-contribute" id="id78">How to contribute</a></p></li>
<li><p><a class="reference internal" href="#publishing" id="id79">Publishing</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#license" id="id80">License</a></p></li>
</ul>
</div>
<div class="section" id="about-the-author">
<h3><a class="toc-backref" href="#id73">About the author</a><a class="headerlink" href="#about-the-author" title="Permalink to this headline">¶</a></h3>
<p><a class="reference external" href="http://www.labri.fr/perso/nrougier/">Nicolas P. Rougier</a> is a full-time research scientist at <a class="reference external" href="http://www.inria.fr/en">Inria</a> which is the
French national institute for research in computer science and control. This is
a public scientific and technological establishment (EPST) under the double
supervision of the Research &amp; Education Ministry, and the Ministry of Economy
Finance and Industry. Nicolas P. Rougier is working within the <a class="reference external" href="http://www.inria.fr/en/teams/mnemosyne">Mnemosyne</a>
project which lies at the frontier between integrative and computational
neuroscience in association with the <a class="reference external" href="http://www.imn-bordeaux.org/en/">Institute of Neurodegenerative
Diseases</a>, the Bordeaux laboratory for research in computer science
(<a class="reference external" href="https://www.labri.fr/">LaBRI</a>), the <a class="reference external" href="http://www.u-bordeaux.com/">University of Bordeaux</a> and the national center for scientific
research (<a class="reference external" href="http://www.cnrs.fr/index.php">CNRS</a>).</p>
<p>He has been using Python for more than 15 years and NumPy for more than 10
years for modeling in neuroscience, machine learning and for advanced
visualization (OpenGL). Nicolas P. Rougier is the author of several online
resources and tutorials (Matplotlib, NumPy, OpenGL) and he’s teaching Python,
NumPy and scientific visualization at the University of Bordeaux and in various
conferences and schools worldwide (SciPy, EuroScipy, etc). He’s also the author
of the popular article <a class="reference external" href="http://dx.doi.org/10.1371/journal.pcbi.1003833">Ten Simple Rules for Better Figures</a> and a popular
<a class="reference external" href="http://www.labri.fr/perso/nrougier/teaching/matplotlib/matplotlib.html">matplotlib tutorial</a>.</p>
</div>
<div class="section" id="about-this-book">
<h3><a class="toc-backref" href="#id74">About this book</a><a class="headerlink" href="#about-this-book" title="Permalink to this headline">¶</a></h3>
<p>This book has been written in <a class="reference external" href="http://docutils.sourceforge.net/rst.html">restructured text</a> format and generated using the
<code class="code docutils literal notranslate"><span class="pre">rst2html.py</span></code> command line available from the <a class="reference external" href="http://docutils.sourceforge.net/">docutils</a> python package.</p>
<p>If you want to rebuild the html output, from the top directory, type:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ rst2html.py --link-stylesheet --cloak-email-addresses \
              --toc-top-backlinks --stylesheet=book.css \
              --stylesheet-dirs=. book.rst book.html
</pre></div>
</div>
<p>The sources are available from <a class="reference external" href="https://github.com/rougier/from-python-to-numpy">https://github.com/rougier/from-python-to-numpy</a>.</p>
<div class="section" id="about-the-jupyter-book">
<h4><a class="toc-backref" href="#id75">About the Jupyter Book</a><a class="headerlink" href="#about-the-jupyter-book" title="Permalink to this headline">¶</a></h4>
<p><strong>html version</strong></p>
<p>To generate the <a class="reference external" href="https://jupyterbook.org">Jupyter Book</a> from the top directory:</p>
<ol class="arabic simple">
<li><p>Install the most up to date version of jupyter-book:</p></li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ pip install -U jupyter-book
</pre></div>
</div>
<ol class="arabic simple" start="2">
<li><p>Go to the root directory of the repository and run:</p></li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ jupyter-book build . --path-output jupyter-book/.
</pre></div>
</div>
<ol class="arabic simple" start="3">
<li><p>Copy the data folder into the html directory:</p></li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ cp -r data jupyter-book/_build/html/.
</pre></div>
</div>
<ol class="arabic simple" start="4">
<li><p>Open Jupyter-book at: <code class="code docutils literal notranslate"><span class="pre">jupyter-book/_build/html/index.html</span></code></p></li>
</ol>
<p><strong>pdf version</strong></p>
<p>To generate a pdf version of the book, you will need <a class="reference external" href="https://pypi.org/project/pyppeteer/">pyppeteer</a> installed,
then in the top directory, run:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ jupyter-book build . --builder pdfhtml --path-output jupyter-book/.
</pre></div>
</div>
<p>The pdf version of the book is available at <code class="code docutils literal notranslate"><span class="pre">jupyter-book/_build/pdf/book.pdf</span></code></p>
</div>
<div class="section" id="prerequisites">
<h4><a class="toc-backref" href="#id76">Prerequisites</a><a class="headerlink" href="#prerequisites" title="Permalink to this headline">¶</a></h4>
<p>This is not a Python beginner guide and you should have an intermediate level in
Python and ideally a beginner level in NumPy. If this is not the case, have
a look at the <a class="reference internal" href="#bibliography">bibliography</a> for a curated list of resources.</p>
</div>
<div class="section" id="conventions">
<h4><a class="toc-backref" href="#id77">Conventions</a><a class="headerlink" href="#conventions" title="Permalink to this headline">¶</a></h4>
<p>We will use usual naming conventions. If not stated explicitly, each script
should import NumPy, scipy and matplotlib as:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">scipy</span> <span class="k">as</span> <span class="nn">sp</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
</pre></div>
</div>
<p>We’ll use up-to-date versions (at the date of writing, i.e. January, 2017) of the
different packages:</p>
<table class="table">
<colgroup>
<col style="width: 55%" />
<col style="width: 45%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Packages</p></th>
<th class="head"><p>Version</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Python</p></td>
<td><p>3.6.0</p></td>
</tr>
<tr class="row-odd"><td><p>NumPy</p></td>
<td><p>1.12.0</p></td>
</tr>
<tr class="row-even"><td><p>Scipy</p></td>
<td><p>0.18.1</p></td>
</tr>
<tr class="row-odd"><td><p>Matplotlib</p></td>
<td><p>2.0.0</p></td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="how-to-contribute">
<h4><a class="toc-backref" href="#id78">How to contribute</a><a class="headerlink" href="#how-to-contribute" title="Permalink to this headline">¶</a></h4>
<p>If you want to contribute to this book, you can:</p>
<ul class="simple">
<li><p>Review chapters (please contact me)</p></li>
<li><p>Report issues (<a class="reference external" href="https://github.com/rougier/from-python-to-numpy/issues">https://github.com/rougier/from-python-to-numpy/issues</a>)</p></li>
<li><p>Suggest improvements (<a class="reference external" href="https://github.com/rougier/from-python-to-numpy/pulls">https://github.com/rougier/from-python-to-numpy/pulls</a>)</p></li>
<li><p>Correct English (<a class="reference external" href="https://github.com/rougier/from-python-to-numpy/issues">https://github.com/rougier/from-python-to-numpy/issues</a>)</p></li>
<li><p>Design a better and more responsive html template for the book.</p></li>
<li><p>Star the project (<a class="reference external" href="https://github.com/rougier/from-python-to-numpy">https://github.com/rougier/from-python-to-numpy</a>)</p></li>
</ul>
</div>
<div class="section" id="publishing">
<h4><a class="toc-backref" href="#id79">Publishing</a><a class="headerlink" href="#publishing" title="Permalink to this headline">¶</a></h4>
<p>If you’re an editor interested in publishing this book, you can <a class="reference external" href="mailto:Nicolas&#46;Rougier&#37;&#52;&#48;inria&#46;fr">contact me</a> if you agree to have this version and all
subsequent versions open access (i.e. online at <a class="reference external" href="http://www.labri.fr/perso/nrougier/from-python-to-numpy">this address</a>), you know how to
deal with <a class="reference external" href="http://docutils.sourceforge.net/rst.html">restructured text</a> (Word
is not an option), you provide a real added-value as well as supporting
services, and more importantly, you have a truly amazing latex book template
(and be warned that I’m a bit picky about typography &amp; design: <a class="reference external" href="https://www.edwardtufte.com/tufte/">Edward Tufte</a> is my hero). Still here?</p>
</div>
</div>
<div class="section" id="license">
<h3><a class="toc-backref" href="#id80">License</a><a class="headerlink" href="#license" title="Permalink to this headline">¶</a></h3>
<p><strong>Book</strong></p>
<p>This work is licensed under a <a class="reference external" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">Creative Commons Attribution-Non Commercial-Share
Alike 4.0 International License</a>. You are free to:</p>
<ul class="simple">
<li><p><strong>Share</strong> — copy and redistribute the material in any medium or format</p></li>
<li><p><strong>Adapt</strong> — remix, transform, and build upon the material</p></li>
</ul>
<p>The licensor cannot revoke these freedoms as long as you follow the license terms.</p>
<p><strong>Code</strong></p>
<p>The code is licensed under the <a class="reference external" href="LICENSE-code.txt">OSI-approved BSD 2-Clause License</a>.</p>
</div>
</div>
<div class="section" id="introduction">
<h2><a class="toc-backref" href="#id64">Introduction</a><a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<div class="contents local topic" id="id3">
<p class="topic-title"><strong>Contents</strong></p>
<ul class="simple">
<li><p><a class="reference internal" href="#simple-example" id="id81">Simple example</a></p></li>
<li><p><a class="reference internal" href="#readability-vs-speed" id="id82">Readability vs speed</a></p></li>
</ul>
</div>
<div class="section" id="simple-example">
<h3><a class="toc-backref" href="#id81">Simple example</a><a class="headerlink" href="#simple-example" title="Permalink to this headline">¶</a></h3>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>You can execute any code below from the <a class="reference external" href="code">code</a> folder using the
regular python shell or from inside an IPython session or Jupyter notebook. In
such a case, you might want to use the magic command <code class="code docutils literal notranslate"><span class="pre">%timeit</span></code> instead of the
<a class="reference external" href="code/tools.py">custom one</a> I wrote.</p>
</div>
<p>NumPy is all about vectorization. If you are familiar with Python, this is the
main difficulty you’ll face because you’ll need to change your way of thinking
and your new friends (among others) are named “vectors”, “arrays”, “views” or
“ufuncs”.</p>
<p>Let’s take a very simple example, random walk. One possible object oriented
approach would be to define a <code class="code docutils literal notranslate"><span class="pre">RandomWalker</span></code> class and write a walk
method that would return the current position after each (random) step. It’s nice,
it’s readable, but it is slow:</p>
<p><strong>Object oriented approach</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">RandomWalker</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">walk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">position</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">position</span> <span class="o">+=</span> <span class="mi">2</span><span class="o">*</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>

<span class="n">walker</span> <span class="o">=</span> <span class="n">RandomWalker</span><span class="p">()</span>
<span class="n">walk</span> <span class="o">=</span> <span class="p">[</span><span class="n">position</span> <span class="k">for</span> <span class="n">position</span> <span class="ow">in</span> <span class="n">walker</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="mi">1000</span><span class="p">)]</span>
</pre></div>
</div>
<p>Benchmarking gives us:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">tools</span> <span class="kn">import</span> <span class="n">timeit</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">walker</span> <span class="o">=</span> <span class="n">RandomWalker</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">timeit</span><span class="p">(</span><span class="s2">&quot;[position for position in walker.walk(n=10000)]&quot;</span><span class="p">,</span> <span class="nb">globals</span><span class="p">())</span>
<span class="go">10 loops, best of 3: 15.7 msec per loop</span>
</pre></div>
</div>
<p><strong>Procedural approach</strong></p>
<p>For such a simple problem, we can probably save the class definition and
concentrate only on the walk method that computes successive positions after
each random step.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">random_walk</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="n">position</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">walk</span> <span class="o">=</span> <span class="p">[</span><span class="n">position</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">position</span> <span class="o">+=</span> <span class="mi">2</span><span class="o">*</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span>
        <span class="n">walk</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">position</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">walk</span>

<span class="n">walk</span> <span class="o">=</span> <span class="n">random_walk</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>
</pre></div>
</div>
<p>This new method saves some CPU cycles but not that much because this function
is pretty much the same as in the object-oriented approach and the few cycles
we saved probably come from the inner Python object-oriented machinery.</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">tools</span> <span class="kn">import</span> <span class="n">timeit</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">timeit</span><span class="p">(</span><span class="s2">&quot;random_walk(n=10000)&quot;</span><span class="p">,</span> <span class="nb">globals</span><span class="p">())</span>
<span class="go">10 loops, best of 3: 15.6 msec per loop</span>
</pre></div>
</div>
<p><strong>Vectorized approach</strong></p>
<p>But we can do better using the <a class="reference external" href="https://docs.python.org/3.6/library/itertools.html">itertools</a> Python module that
offers <em>a set of functions creating iterators for efficient looping</em>. If we
observe that a random walk is an accumulation of steps, we can rewrite the
function by first generating all the steps and accumulate them without any
loop:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">random_walk_faster</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">1000</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">accumulate</span>
    <span class="c1"># Only available from Python 3.6</span>
    <span class="n">steps</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choices</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">k</span><span class="o">=</span><span class="n">n</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="nb">list</span><span class="p">(</span><span class="n">accumulate</span><span class="p">(</span><span class="n">steps</span><span class="p">))</span>

 <span class="n">walk</span> <span class="o">=</span> <span class="n">random_walk_faster</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>
</pre></div>
</div>
<p>In fact, we’ve just <em>vectorized</em> our function. Instead of looping for picking
sequential steps and add them to the current position, we first generated all the
steps at once and used the <a class="reference external" href="https://docs.python.org/3.6/library/itertools.html#itertools.accumulate">accumulate</a>
function to compute all the positions. We got rid of the loop and this makes
things faster:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">tools</span> <span class="kn">import</span> <span class="n">timeit</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">timeit</span><span class="p">(</span><span class="s2">&quot;random_walk_faster(n=10000)&quot;</span><span class="p">,</span> <span class="nb">globals</span><span class="p">())</span>
<span class="go">10 loops, best of 3: 2.21 msec per loop</span>
</pre></div>
</div>
<p>We gained 85% of computation-time compared to the previous version, not so
bad. But the advantage of this new version is that it makes NumPy vectorization
super simple. We just have to translate itertools call into NumPy ones.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">random_walk_fastest</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">1000</span><span class="p">):</span>
    <span class="c1"># No &#39;s&#39; in NumPy choice (Python offers choice &amp; choices)</span>
    <span class="n">steps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">n</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">steps</span><span class="p">)</span>

<span class="n">walk</span> <span class="o">=</span> <span class="n">random_walk_fastest</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>
</pre></div>
</div>
<p>Not too difficult, but we gained a factor 500x using NumPy:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">tools</span> <span class="kn">import</span> <span class="n">timeit</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">timeit</span><span class="p">(</span><span class="s2">&quot;random_walk_fastest(n=10000)&quot;</span><span class="p">,</span> <span class="nb">globals</span><span class="p">())</span>
<span class="go">1000 loops, best of 3: 14 usec per loop</span>
</pre></div>
</div>
<p>This book is about vectorization, be it at the code or problem level. We’ll
see this difference is important before looking at custom vectorization.</p>
</div>
<div class="section" id="readability-vs-speed">
<h3><a class="toc-backref" href="#id82">Readability vs speed</a><a class="headerlink" href="#readability-vs-speed" title="Permalink to this headline">¶</a></h3>
<p>Before heading to the next chapter, I would like to warn you about a potential
problem you may encounter once you’ll have become familiar with NumPy. It is a
very powerful library and you can make wonders with it but, most of the time,
this comes at the price of readability. If you don’t comment your code at the
time of writing, you won’t be able to tell what a function is doing after a few
weeks (or possibly days). For example, can you tell what the two functions
below are doing? Probably you can tell for the first one, but unlikely for the
second (or your name is <a class="reference external" href="http://stackoverflow.com/questions/7100242/python-numpy-first-occurrence-of-subarray">Jaime Fernández del Río</a>
and you don’t need to read this book).</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">function_1</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="n">sub</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">seq</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">sub</span><span class="p">)</span> <span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="n">seq</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">sub</span><span class="p">)]</span> <span class="o">==</span> <span class="n">sub</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">function_2</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="n">sub</span><span class="p">):</span>
    <span class="n">target</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">sub</span><span class="p">,</span> <span class="n">sub</span><span class="p">)</span>
    <span class="n">candidates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">correlate</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="n">sub</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;valid&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="n">target</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">check</span> <span class="o">=</span> <span class="n">candidates</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sub</span><span class="p">))</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="n">check</span><span class="p">)</span> <span class="o">==</span> <span class="n">sub</span><span class="p">),</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">candidates</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
</pre></div>
</div>
<p>As you may have guessed, the second function is the
vectorized-optimized-faster-NumPy version of the first function. It is 10 times
faster than the pure Python version, but it is hardly readable.</p>
</div>
</div>
<div class="section" id="anatomy-of-an-array">
<h2><a class="toc-backref" href="#id65">Anatomy of an array</a><a class="headerlink" href="#anatomy-of-an-array" title="Permalink to this headline">¶</a></h2>
<div class="contents local topic" id="id4">
<p class="topic-title"><strong>Contents</strong></p>
<ul class="simple">
<li><p><a class="reference internal" href="#id5" id="id83">Introduction</a></p></li>
<li><p><a class="reference internal" href="#memory-layout" id="id84">Memory layout</a></p></li>
<li><p><a class="reference internal" href="#views-and-copies" id="id85">Views and copies</a></p>
<ul>
<li><p><a class="reference internal" href="#direct-and-indirect-access" id="id86">Direct and indirect access</a></p></li>
<li><p><a class="reference internal" href="#temporary-copy" id="id87">Temporary copy</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#conclusion" id="id88">Conclusion</a></p></li>
</ul>
</div>
<div class="section" id="id5">
<h3><a class="toc-backref" href="#id83">Introduction</a><a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h3>
<p>As explained in the <a class="reference internal" href="#preface">Preface</a>, you should have a basic experience with NumPy to
read this book. If this is not the case, you’d better start with a beginner
tutorial before coming back here. Consequently I’ll only give here a quick
reminder on the basic anatomy of NumPy arrays, especially regarding the memory
layout, view, copy and the data type. They are critical notions to
understand if you want your computation to benefit from NumPy philosophy.</p>
<p>Let’s consider a simple example where we want to clear all the values from an
array which has the dtype <code class="code docutils literal notranslate"><span class="pre">np.float32</span></code>. How does one write it to maximize speed? The
below syntax is rather obvious (at least for those familiar with NumPy) but the
above question asks to find the fastest operation.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="mi">1000000</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Z</span><span class="p">[</span><span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</pre></div>
</div>
<p>If you look more closely at both the dtype and the size of the array, you can
observe that this array can be casted (i.e. viewed) into many other
“compatible” data types. By compatible, I mean that <code class="code docutils literal notranslate"><span class="pre">Z.size</span> <span class="pre">*</span> <span class="pre">Z.itemsize</span></code> can
be divided by the new dtype itemsize.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">timeit</span><span class="p">(</span><span class="s2">&quot;Z.view(np.float16)[...] = 0&quot;</span><span class="p">,</span> <span class="nb">globals</span><span class="p">())</span>
<span class="go">100 loops, best of 3: 2.72 msec per loop</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">timeit</span><span class="p">(</span><span class="s2">&quot;Z.view(np.int16)[...] = 0&quot;</span><span class="p">,</span> <span class="nb">globals</span><span class="p">())</span>
<span class="go">100 loops, best of 3: 2.77 msec per loop</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">timeit</span><span class="p">(</span><span class="s2">&quot;Z.view(np.int32)[...] = 0&quot;</span><span class="p">,</span> <span class="nb">globals</span><span class="p">())</span>
<span class="go">100 loops, best of 3: 1.29 msec per loop</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">timeit</span><span class="p">(</span><span class="s2">&quot;Z.view(np.float32)[...] = 0&quot;</span><span class="p">,</span> <span class="nb">globals</span><span class="p">())</span>
<span class="go">100 loops, best of 3: 1.33 msec per loop</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">timeit</span><span class="p">(</span><span class="s2">&quot;Z.view(np.int64)[...] = 0&quot;</span><span class="p">,</span> <span class="nb">globals</span><span class="p">())</span>
<span class="go">100 loops, best of 3: 874 usec per loop</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">timeit</span><span class="p">(</span><span class="s2">&quot;Z.view(np.float64)[...] = 0&quot;</span><span class="p">,</span> <span class="nb">globals</span><span class="p">())</span>
<span class="go">100 loops, best of 3: 865 usec per loop</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">timeit</span><span class="p">(</span><span class="s2">&quot;Z.view(np.complex128)[...] = 0&quot;</span><span class="p">,</span> <span class="nb">globals</span><span class="p">())</span>
<span class="go">100 loops, best of 3: 841 usec per loop</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">timeit</span><span class="p">(</span><span class="s2">&quot;Z.view(np.int8)[...] = 0&quot;</span><span class="p">,</span> <span class="nb">globals</span><span class="p">())</span>
<span class="go">100 loops, best of 3: 630 usec per loop</span>
</pre></div>
</div>
<p>Interestingly enough, the obvious way of clearing all the values is not the
fastest. By casting the array into a larger data type such as <code class="code docutils literal notranslate"><span class="pre">np.float64</span></code>, we
gained a 25% speed factor. But, by viewing the array as a byte array
(<code class="code docutils literal notranslate"><span class="pre">np.int8</span></code>), we gained a 50% factor. The reason for such speedup are to be
found in the internal NumPy machinery and the compiler optimization. This
simple example illustrates the philosophy of NumPy as we’ll see in the next
section below.</p>
</div>
<div class="section" id="memory-layout">
<h3><a class="toc-backref" href="#id84">Memory layout</a><a class="headerlink" href="#memory-layout" title="Permalink to this headline">¶</a></h3>
<p>The <a class="reference external" href="https://docs.scipy.org/doc/numpy/reference/arrays.ndarray.html">NumPy documentation</a> defines the
ndarray class very clearly:</p>
<blockquote>
<div><p><em>An instance of class ndarray consists of a contiguous one-dimensional segment
of computer memory (owned by the array, or by some other object), combined
with an indexing scheme that maps N integers into the location of an item in
the block.</em></p>
</div></blockquote>
<p>Said differently, an array is mostly a contiguous block of memory whose parts
can be accessed using an indexing scheme. Such indexing scheme is in turn
defined by a <a class="reference external" href="https://docs.scipy.org/doc/numpy/reference/generated/numpy.ndarray.shape.html#numpy.ndarray.shape">shape</a>
and a <a class="reference external" href="https://docs.scipy.org/doc/numpy/reference/arrays.dtypes.html">data type</a> and this is
precisely what is needed when you define a new array:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">)</span>
</pre></div>
</div>
<p>Here, we know that Z itemsize is 2 bytes (<code class="code docutils literal notranslate"><span class="pre">int16</span></code>), the shape is (3,3) and
the number of dimensions is 2 (<code class="code docutils literal notranslate"><span class="pre">len(Z.shape)</span></code>).</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">Z</span><span class="o">.</span><span class="n">itemsize</span><span class="p">)</span>
<span class="go">2</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">Z</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="go">(3, 3)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">Z</span><span class="o">.</span><span class="n">ndim</span><span class="p">)</span>
<span class="go">2</span>
</pre></div>
</div>
<p>Furthermore and because Z is not a view, we can deduce the
<a class="reference external" href="https://docs.scipy.org/doc/numpy/reference/generated/numpy.ndarray.strides.html#numpy.ndarray.strides">strides</a> of the array that define the number of bytes to step in each dimension when traversing the array.</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">strides</span> <span class="o">=</span> <span class="n">Z</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">Z</span><span class="o">.</span><span class="n">itemsize</span><span class="p">,</span> <span class="n">Z</span><span class="o">.</span><span class="n">itemsize</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">strides</span><span class="p">)</span>
<span class="go">(6, 2)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">Z</span><span class="o">.</span><span class="n">strides</span><span class="p">)</span>
<span class="go">(6, 2)</span>
</pre></div>
</div>
<p>With all these information, we know how to access a specific item (designed by
an index tuple) and more precisely, how to compute the start and end offsets:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">offset_start</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Z</span><span class="o">.</span><span class="n">ndim</span><span class="p">):</span>
    <span class="n">offset_start</span> <span class="o">+=</span> <span class="n">Z</span><span class="o">.</span><span class="n">strides</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">index</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
<span class="n">offset_end</span> <span class="o">=</span> <span class="n">offset_start</span> <span class="o">+</span> <span class="n">Z</span><span class="o">.</span><span class="n">itemsize</span>
</pre></div>
</div>
<p>Let’s see if this is correct using the <a class="reference external" href="https://docs.scipy.org/doc/numpy/reference/generated/numpy.ndarray.tobytes.html">tobytes</a>
conversion method:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">index</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">Z</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">tobytes</span><span class="p">())</span>
<span class="go">b&#39;\x04\x00&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">offset_start</span> <span class="o">=</span> <span class="mi">0</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Z</span><span class="o">.</span><span class="n">ndim</span><span class="p">):</span>
<span class="gp">... </span>    <span class="n">offset_start</span> <span class="o">+=</span> <span class="n">Z</span><span class="o">.</span><span class="n">strides</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">index</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">offset_end</span> <span class="o">=</span> <span class="n">offset_start</span> <span class="o">+</span> <span class="n">Z</span><span class="o">.</span><span class="n">itemsize</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">Z</span><span class="o">.</span><span class="n">tobytes</span><span class="p">()[</span><span class="n">offset_start</span><span class="p">:</span><span class="n">offset_end</span><span class="p">])</span>
<span class="go">b&#39;\x04\x00&#39;</span>
</pre></div>
</div>
<p>This array can be actually considered from different perspectives (i.e. layouts):</p>
<p><strong>Item layout</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>               shape[1]
                 (=3)
            ┌───────────┐

         ┌  ┌───┬───┬───┐  ┐
         │  │ 0 │ 1 │ 2 │  │
         │  ├───┼───┼───┤  │
shape[0] │  │ 3 │ 4 │ 5 │  │ len(Z)
 (=3)    │  ├───┼───┼───┤  │  (=3)
         │  │ 6 │ 7 │ 8 │  │
         └  └───┴───┴───┘  ┘
</pre></div>
</div>
<p><strong>Flattened item layout</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>┌───┬───┬───┬───┬───┬───┬───┬───┬───┐
│ 0 │ 1 │ 2 │ 3 │ 4 │ 5 │ 6 │ 7 │ 8 │
└───┴───┴───┴───┴───┴───┴───┴───┴───┘

└───────────────────────────────────┘
               Z.size
                (=9)
</pre></div>
</div>
<p><strong>Memory layout (C order, big endian)</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>                         strides[1]
                           (=2)
                  ┌─────────────────────┐

          ┌       ┌──────────┬──────────┐ ┐
          │ p+00: │ 00000000 │ 00000000 │ │
          │       ├──────────┼──────────┤ │
          │ p+02: │ 00000000 │ 00000001 │ │ strides[0]
          │       ├──────────┼──────────┤ │   (=2x3)
          │ p+04  │ 00000000 │ 00000010 │ │
          │       ├──────────┼──────────┤ ┘
          │ p+06  │ 00000000 │ 00000011 │
          │       ├──────────┼──────────┤
Z.nbytes  │ p+08: │ 00000000 │ 00000100 │
(=3x3x2)  │       ├──────────┼──────────┤
          │ p+10: │ 00000000 │ 00000101 │
          │       ├──────────┼──────────┤
          │ p+12: │ 00000000 │ 00000110 │
          │       ├──────────┼──────────┤
          │ p+14: │ 00000000 │ 00000111 │
          │       ├──────────┼──────────┤
          │ p+16: │ 00000000 │ 00001000 │
          └       └──────────┴──────────┘

                  └─────────────────────┘
                        Z.itemsize
                     Z.dtype.itemsize
                           (=2)
</pre></div>
</div>
<p>If we now take a slice of <code class="code docutils literal notranslate"><span class="pre">Z</span></code>, the result is a view of the base array <code class="code docutils literal notranslate"><span class="pre">Z</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">V</span> <span class="o">=</span> <span class="n">Z</span><span class="p">[::</span><span class="mi">2</span><span class="p">,::</span><span class="mi">2</span><span class="p">]</span>
</pre></div>
</div>
<p>Such view is specified using a shape, a dtype <strong>and</strong> strides because strides
cannot be deduced anymore from the dtype and shape only:</p>
<p><strong>Item layout</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>               shape[1]
                 (=2)
            ┌───────────┐

         ┌  ┌───┬╌╌╌┬───┐  ┐
         │  │ 0 │   │ 2 │  │            ┌───┬───┐
         │  ├───┼╌╌╌┼───┤  │            │ 0 │ 2 │
shape[0] │  ╎   ╎   ╎   ╎  │ len(Z)  →  ├───┼───┤
 (=2)    │  ├───┼╌╌╌┼───┤  │  (=2)      │ 6 │ 8 │
         │  │ 6 │   │ 8 │  │            └───┴───┘
         └  └───┴╌╌╌┴───┘  ┘
</pre></div>
</div>
<p><strong>Flattened item layout</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>┌───┬╌╌╌┬───┬╌╌╌┬╌╌╌┬╌╌╌┬───┬╌╌╌┬───┐       ┌───┬───┬───┬───┐
│ 0 │   │ 2 │   ╎   ╎   │ 6 │   │ 8 │   →   │ 0 │ 2 │ 6 │ 8 │
└───┴╌╌╌┴───┴╌╌╌┴╌╌╌┴╌╌╌┴───┴╌╌╌┴───┘       └───┴───┴───┴───┘
└─┬─┘   └─┬─┘           └─┬─┘   └─┬─┘
  └───┬───┘               └───┬───┘
      └───────────┬───────────┘
               Z.size
                (=4)
</pre></div>
</div>
<p><strong>Memory layout (C order, big endian)</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>              ┌        ┌──────────┬──────────┐ ┐             ┐
            ┌─┤  p+00: │ 00000000 │ 00000000 │ │             │
            │ └        ├──────────┼──────────┤ │ strides[1]  │
          ┌─┤    p+02: │          │          │ │   (=4)      │
          │ │ ┌        ├──────────┼──────────┤ ┘             │
          │ └─┤  p+04  │ 00000000 │ 00000010 │               │
          │   └        ├──────────┼──────────┤               │ strides[0]
          │      p+06: │          │          │               │   (=12)
          │            ├──────────┼──────────┤               │
Z.nbytes ─┤      p+08: │          │          │               │
  (=8)    │            ├──────────┼──────────┤               │
          │      p+10: │          │          │               │
          │   ┌        ├──────────┼──────────┤               ┘
          │ ┌─┤  p+12: │ 00000000 │ 00000110 │
          │ │ └        ├──────────┼──────────┤
          └─┤    p+14: │          │          │
            │ ┌        ├──────────┼──────────┤
            └─┤  p+16: │ 00000000 │ 00001000 │
              └        └──────────┴──────────┘

                       └─────────────────────┘
                             Z.itemsize
                          Z.dtype.itemsize
                                (=2)
</pre></div>
</div>
</div>
<div class="section" id="views-and-copies">
<h3><a class="toc-backref" href="#id85">Views and copies</a><a class="headerlink" href="#views-and-copies" title="Permalink to this headline">¶</a></h3>
<p>Views and copies are important concepts for the optimization of your numerical
computations. Even if we’ve already manipulated them in the previous section,
the whole story is a bit more complex.</p>
<div class="section" id="direct-and-indirect-access">
<h4><a class="toc-backref" href="#id86">Direct and indirect access</a><a class="headerlink" href="#direct-and-indirect-access" title="Permalink to this headline">¶</a></h4>
<p>First, we have to distinguish between <a class="reference external" href="https://docs.scipy.org/doc/numpy/user/basics.indexing.html#">indexing</a> and <a class="reference external" href="https://docs.scipy.org/doc/numpy/reference/arrays.indexing.html#advanced-indexing">fancy
indexing</a>. The first will always return a view while the second will return a
copy. This difference is important because in the first case, modifying the view
modifies the base array while this is not true in the second case:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Z_view</span> <span class="o">=</span> <span class="n">Z</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Z_view</span><span class="p">[</span><span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">Z</span><span class="p">)</span>
<span class="go">[ 1.  1.  1.  0.  0.  0.  0.  0.  0.]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Z_copy</span> <span class="o">=</span> <span class="n">Z</span><span class="p">[[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Z_copy</span><span class="p">[</span><span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">Z</span><span class="p">)</span>
<span class="go">[ 0.  0.  0.  0.  0.  0.  0.  0.  0.]</span>
</pre></div>
</div>
<p>Thus, if you need fancy indexing, it’s better to keep a copy of your fancy index
(especially if it was complex to compute it) and to work with it:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">index</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Z</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">Z</span><span class="p">)</span>
<span class="go">[ 1.  1.  1.  0.  0.  0.  0.  0.  0.]</span>
</pre></div>
</div>
<p>If you are unsure if the result of your indexing is a view or a copy, you can
check what is the <code class="code docutils literal notranslate"><span class="pre">base</span></code> of your result. If it is <code class="code docutils literal notranslate"><span class="pre">None</span></code>, then you result is a
copy:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,(</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Z1</span> <span class="o">=</span> <span class="n">Z</span><span class="p">[:</span><span class="mi">3</span><span class="p">,:]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Z2</span> <span class="o">=</span> <span class="n">Z</span><span class="p">[[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span> <span class="p">:]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">Z1</span><span class="p">,</span><span class="n">Z2</span><span class="p">))</span>
<span class="go">True</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">Z1</span><span class="o">.</span><span class="n">base</span> <span class="ow">is</span> <span class="n">Z</span><span class="p">)</span>
<span class="go">True</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">Z2</span><span class="o">.</span><span class="n">base</span> <span class="ow">is</span> <span class="n">Z</span><span class="p">)</span>
<span class="go">False</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">Z2</span><span class="o">.</span><span class="n">base</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span>
<span class="go">True</span>
</pre></div>
</div>
<p>Note that some NumPy functions return a view when possible (e.g. <a class="reference external" href="https://docs.scipy.org/doc/numpy/reference/generated/numpy.ravel.html">ravel</a>)
while some others always return a copy (e.g. <a class="reference external" href="https://docs.scipy.org/doc/numpy/reference/generated/numpy.ndarray.flatten.html#numpy.ndarray.flatten">flatten</a>):</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Z</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span><span class="o">.</span><span class="n">base</span> <span class="ow">is</span> <span class="n">Z</span>
<span class="go">True</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Z</span><span class="p">[::</span><span class="mi">2</span><span class="p">,::</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span><span class="o">.</span><span class="n">base</span> <span class="ow">is</span> <span class="n">Z</span>
<span class="go">False</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Z</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span><span class="o">.</span><span class="n">base</span> <span class="ow">is</span> <span class="n">Z</span>
<span class="go">False</span>
</pre></div>
</div>
</div>
<div class="section" id="temporary-copy">
<h4><a class="toc-backref" href="#id87">Temporary copy</a><a class="headerlink" href="#temporary-copy" title="Permalink to this headline">¶</a></h4>
<p>Copies can be made explicitly like in the previous section, but the most
general case is the implicit creation of intermediate copies. This is the case
when you are doing some arithmetic with arrays:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">A</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">X</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">Y</span>
</pre></div>
</div>
<p>In the example above, three intermediate arrays have been created. One for
holding the result of <code class="code docutils literal notranslate"><span class="pre">2*X</span></code>, one for holding the result of <code class="code docutils literal notranslate"><span class="pre">2*Y</span></code> and the last
one for holding the result of <code class="code docutils literal notranslate"><span class="pre">2*X+2*Y</span></code>. In this specific case, the arrays are
small enough and this does not really make a difference. However, if your
arrays are big, then you have to be careful with such expressions and wonder if
you can do it differently. For example, if only the final result matters and
you don’t need <code class="code docutils literal notranslate"><span class="pre">X</span></code> nor <code class="code docutils literal notranslate"><span class="pre">Y</span></code> afterwards, an alternate solution would be:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">X</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">Y</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">X</span><span class="p">)</span>
</pre></div>
</div>
<p>Using this alternate solution, no temporary array has been created. The problem
is that there are many other cases where such copies need to be created and
this impacts the performance like demonstrated in the example below:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">1000000000</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">1000000000</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">timeit</span><span class="p">(</span><span class="s2">&quot;X = X + 2.0*Y&quot;</span><span class="p">,</span> <span class="nb">globals</span><span class="p">())</span>
<span class="go">100 loops, best of 3: 3.61 ms per loop</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">timeit</span><span class="p">(</span><span class="s2">&quot;X = X + 2*Y&quot;</span><span class="p">,</span> <span class="nb">globals</span><span class="p">())</span>
<span class="go">100 loops, best of 3: 3.47 ms per loop</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">timeit</span><span class="p">(</span><span class="s2">&quot;X += 2*Y&quot;</span><span class="p">,</span> <span class="nb">globals</span><span class="p">())</span>
<span class="go">100 loops, best of 3: 2.79 ms per loop</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">timeit</span><span class="p">(</span><span class="s2">&quot;np.add(X, Y, out=X); np.add(X, Y, out=X)&quot;</span><span class="p">,</span> <span class="nb">globals</span><span class="p">())</span>
<span class="go">1000 loops, best of 3: 1.57 ms per loop</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="conclusion">
<h3><a class="toc-backref" href="#id88">Conclusion</a><a class="headerlink" href="#conclusion" title="Permalink to this headline">¶</a></h3>
<p>As a conclusion, we’ll make an exercise. Given two vectors <code class="code docutils literal notranslate"><span class="pre">Z1</span></code> and <code class="code docutils literal notranslate"><span class="pre">Z2</span></code>. We
would like to know if <code class="code docutils literal notranslate"><span class="pre">Z2</span></code> is a view of <code class="code docutils literal notranslate"><span class="pre">Z1</span></code> and if yes, what is this view ?</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">Z1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Z2</span> <span class="o">=</span> <span class="n">Z1</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>
</pre></div>
</div>
<div class="output highlight-default notranslate"><div class="highlight"><pre><span></span>   ╌╌╌┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬╌╌
Z1    │ 0 │ 1 │ 2 │ 3 │ 4 │ 5 │ 6 │ 7 │ 8 │ 9 │
   ╌╌╌┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴╌╌
   ╌╌╌╌╌╌╌┬───┬╌╌╌┬───┬╌╌╌┬───┬╌╌╌┬───┬╌╌╌╌╌╌╌╌╌╌
Z2        │ 1 │   │ 3 │   │ 5 │   │ 7 │
   ╌╌╌╌╌╌╌┴───┴╌╌╌┴───┴╌╌╌┴───┴╌╌╌┴───┴╌╌╌╌╌╌╌╌╌╌
</pre></div>
</div>
<p>First, we need to check if <code class="code docutils literal notranslate"><span class="pre">Z1</span></code> is the base of <code class="code docutils literal notranslate"><span class="pre">Z2</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">Z2</span><span class="o">.</span><span class="n">base</span> <span class="ow">is</span> <span class="n">Z1</span><span class="p">)</span>
<span class="go">True</span>
</pre></div>
</div>
<p>At this point, we know <code class="code docutils literal notranslate"><span class="pre">Z2</span></code> is a view of <code class="code docutils literal notranslate"><span class="pre">Z1</span></code>, meaning <code class="code docutils literal notranslate"><span class="pre">Z2</span></code> can be expressed as
<code class="code docutils literal notranslate"><span class="pre">Z1[start:stop:step]</span></code>. The difficulty is to find <code class="code docutils literal notranslate"><span class="pre">start</span></code>, <code class="code docutils literal notranslate"><span class="pre">stop</span></code> and
<code class="code docutils literal notranslate"><span class="pre">step</span></code>.  For the <code class="code docutils literal notranslate"><span class="pre">step</span></code>, we can use the <code class="code docutils literal notranslate"><span class="pre">strides</span></code> property of any array that
gives the number of bytes to go from one element to the other in each
dimension. In our case, and because both arrays are one-dimensional, we can
directly compare the first stride only:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">step</span> <span class="o">=</span> <span class="n">Z2</span><span class="o">.</span><span class="n">strides</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">//</span> <span class="n">Z1</span><span class="o">.</span><span class="n">strides</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">step</span><span class="p">)</span>
<span class="go">2</span>
</pre></div>
</div>
<p>Next difficulty is to find the <code class="code docutils literal notranslate"><span class="pre">start</span></code> and the <code class="code docutils literal notranslate"><span class="pre">stop</span></code> indices. To do this, we
can take advantage of the <code class="code docutils literal notranslate"><span class="pre">byte_bounds</span></code> method that returns a pointer to the
end-points of an array.</p>
<div class="output highlight-default notranslate"><div class="highlight"><pre><span></span>  byte_bounds(Z1)[0]                  byte_bounds(Z1)[-1]
      ↓                                       ↓
   ╌╌╌┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬╌╌
Z1    │ 0 │ 1 │ 2 │ 3 │ 4 │ 5 │ 6 │ 7 │ 8 │ 9 │
   ╌╌╌┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴╌╌

      byte_bounds(Z2)[0]      byte_bounds(Z2)[-1]
          ↓                           ↓
   ╌╌╌╌╌╌╌┬───┬╌╌╌┬───┬╌╌╌┬───┬╌╌╌┬───┬╌╌╌╌╌╌╌╌╌╌
Z2        │ 1 │   │ 3 │   │ 5 │   │ 7 │
   ╌╌╌╌╌╌╌┴───┴╌╌╌┴───┴╌╌╌┴───┴╌╌╌┴───┴╌╌╌╌╌╌╌╌╌╌
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">offset_start</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">byte_bounds</span><span class="p">(</span><span class="n">Z2</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">byte_bounds</span><span class="p">(</span><span class="n">Z1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">offset_start</span><span class="p">)</span> <span class="c1"># bytes</span>
<span class="go">8</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">offset_stop</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">byte_bounds</span><span class="p">(</span><span class="n">Z2</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">byte_bounds</span><span class="p">(</span><span class="n">Z1</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">offset_stop</span><span class="p">)</span> <span class="c1"># bytes</span>
<span class="go">-16</span>
</pre></div>
</div>
<p>Converting these offsets into indices is straightforward using the <code class="code docutils literal notranslate"><span class="pre">itemsize</span></code>
and taking into account that the <code class="code docutils literal notranslate"><span class="pre">offset_stop</span></code> is negative (end-bound of <code class="code docutils literal notranslate"><span class="pre">Z2</span></code>
is logically smaller than end-bound of <code class="code docutils literal notranslate"><span class="pre">Z1</span></code> array). We thus need to add the
items size of Z1 to get the right end index.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">start</span> <span class="o">=</span> <span class="n">offset_start</span> <span class="o">//</span> <span class="n">Z1</span><span class="o">.</span><span class="n">itemsize</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">stop</span> <span class="o">=</span> <span class="n">Z1</span><span class="o">.</span><span class="n">size</span> <span class="o">+</span> <span class="n">offset_stop</span> <span class="o">//</span> <span class="n">Z1</span><span class="o">.</span><span class="n">itemsize</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">step</span><span class="p">)</span>
<span class="go">1, 8, 2</span>
</pre></div>
</div>
<p>Last we test our results:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">Z1</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">:</span><span class="n">step</span><span class="p">],</span> <span class="n">Z2</span><span class="p">))</span>
<span class="go">True</span>
</pre></div>
</div>
<p>As an exercise, you can improve this first and very simple implementation by
taking into account:</p>
<ul class="simple">
<li><p>Negative steps</p></li>
<li><p>Multi-dimensional arrays</p></li>
</ul>
<p><a class="reference external" href="code/find_index.py">Solution</a> to the exercise.</p>
</div>
</div>
<div class="section" id="code-vectorization">
<h2><a class="toc-backref" href="#id66">Code vectorization</a><a class="headerlink" href="#code-vectorization" title="Permalink to this headline">¶</a></h2>
<div class="contents local topic" id="id6">
<p class="topic-title"><strong>Contents</strong></p>
<ul class="simple">
<li><p><a class="reference internal" href="#id7" id="id89">Introduction</a></p></li>
<li><p><a class="reference internal" href="#uniform-vectorization" id="id90">Uniform vectorization</a></p>
<ul>
<li><p><a class="reference internal" href="#the-game-of-life" id="id91">The Game of Life</a></p></li>
<li><p><a class="reference internal" href="#python-implementation" id="id92">Python implementation</a></p></li>
<li><p><a class="reference internal" href="#numpy-implementation" id="id93">NumPy implementation</a></p></li>
<li><p><a class="reference internal" href="#exercise" id="id94">Exercise</a></p></li>
<li><p><a class="reference internal" href="#sources" id="id95">Sources</a></p></li>
<li><p><a class="reference internal" href="#references" id="id96">References</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#temporal-vectorization" id="id97">Temporal vectorization</a></p>
<ul>
<li><p><a class="reference internal" href="#id8" id="id98">Python implementation</a></p></li>
<li><p><a class="reference internal" href="#id9" id="id99">NumPy implementation</a></p></li>
<li><p><a class="reference internal" href="#faster-numpy-implementation" id="id100">Faster NumPy implementation</a></p></li>
<li><p><a class="reference internal" href="#visualization" id="id101">Visualization</a></p></li>
<li><p><a class="reference internal" href="#id10" id="id102">Exercise</a></p></li>
<li><p><a class="reference internal" href="#id11" id="id103">Sources</a></p></li>
<li><p><a class="reference internal" href="#id12" id="id104">References</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#spatial-vectorization" id="id105">Spatial vectorization</a></p>
<ul>
<li><p><a class="reference internal" href="#boids" id="id106">Boids</a></p></li>
<li><p><a class="reference internal" href="#id14" id="id107">Python implementation</a></p></li>
<li><p><a class="reference internal" href="#id15" id="id108">NumPy implementation</a></p></li>
<li><p><a class="reference internal" href="#id16" id="id109">Exercise</a></p></li>
<li><p><a class="reference internal" href="#id17" id="id110">Sources</a></p></li>
<li><p><a class="reference internal" href="#id18" id="id111">References</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#id19" id="id112">Conclusion</a></p></li>
</ul>
</div>
<div class="section" id="id7">
<h3><a class="toc-backref" href="#id89">Introduction</a><a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h3>
<p>Code vectorization means that the problem you’re trying to solve is inherently
vectorizable and only requires a few NumPy tricks to make it faster. Of course
it does not mean it is easy or straightforward, but at least it does not
necessitate totally rethinking your problem (as it will be the case in the
<a class="reference internal" href="#problem-vectorization">Problem vectorization</a> chapter). Still, it may require some experience to see
where code can be vectorized. Let’s illustrate this through a simple example
where we want to sum up two lists of integers. One simple way using pure Python
is:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">add_python</span><span class="p">(</span><span class="n">Z1</span><span class="p">,</span><span class="n">Z2</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">z1</span><span class="o">+</span><span class="n">z2</span> <span class="k">for</span> <span class="p">(</span><span class="n">z1</span><span class="p">,</span><span class="n">z2</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">Z1</span><span class="p">,</span><span class="n">Z2</span><span class="p">)]</span>
</pre></div>
</div>
<p>This first naive solution can be vectorized very easily using NumPy:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">add_numpy</span><span class="p">(</span><span class="n">Z1</span><span class="p">,</span><span class="n">Z2</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Z1</span><span class="p">,</span><span class="n">Z2</span><span class="p">)</span>
</pre></div>
</div>
<p>Without any surprise, benchmarking the two approaches shows the second method
is the fastest with one order of magnitude.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">Z1</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1000</span><span class="p">),</span> <span class="mi">100</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Z2</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1000</span><span class="p">),</span> <span class="mi">100</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">timeit</span><span class="p">(</span><span class="s2">&quot;add_python(Z1, Z2)&quot;</span><span class="p">,</span> <span class="nb">globals</span><span class="p">())</span>
<span class="go">1000 loops, best of 3: 68 usec per loop</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">timeit</span><span class="p">(</span><span class="s2">&quot;add_numpy(Z1, Z2)&quot;</span><span class="p">,</span> <span class="nb">globals</span><span class="p">())</span>
<span class="go">10000 loops, best of 3: 1.14 usec per loop</span>
</pre></div>
</div>
<p>Not only is the second approach faster, but it also naturally adapts to the
shape of <code class="code docutils literal notranslate"><span class="pre">Z1</span></code> and <code class="code docutils literal notranslate"><span class="pre">Z2</span></code>. This is the reason why we did not write <code class="code docutils literal notranslate"><span class="pre">Z1</span> <span class="pre">+</span> <span class="pre">Z2</span></code>
because it would not work if <code class="code docutils literal notranslate"><span class="pre">Z1</span></code> and <code class="code docutils literal notranslate"><span class="pre">Z2</span></code> were both lists. In the first Python
method, the inner <code class="code docutils literal notranslate"><span class="pre">+</span></code> is interpreted differently depending on the nature of the
two objects such that if we consider two nested lists, we get the following
outputs:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">Z1</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">]]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Z2</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">],</span> <span class="p">[</span><span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">]]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Z1</span> <span class="o">+</span> <span class="n">Z2</span>
<span class="go">[[1, 2], [3, 4], [5, 6], [7, 8]]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">add_python</span><span class="p">(</span><span class="n">Z1</span><span class="p">,</span> <span class="n">Z2</span><span class="p">)</span>
<span class="go">[[1, 2, 5, 6], [3, 4, 7, 8]]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">add_numpy</span><span class="p">(</span><span class="n">Z1</span><span class="p">,</span> <span class="n">Z2</span><span class="p">)</span>
<span class="go">[[ 6  8]</span>
<span class="go"> [10 12]]</span>
</pre></div>
</div>
<p>The first method concatenates the two lists together, the second method
concatenates the internal lists together and the last one computes what is
(numerically) expected. As an exercise, you can rewrite the Python version
such that it accepts nested lists of any depth.</p>
</div>
<div class="section" id="uniform-vectorization">
<h3><a class="toc-backref" href="#id90">Uniform vectorization</a><a class="headerlink" href="#uniform-vectorization" title="Permalink to this headline">¶</a></h3>
<p>Uniform vectorization is the simplest form of vectorization where all the
elements share the same computation at every time step with no specific
processing for any element. One stereotypical case is the Game of Life that has
been invented by John Conway (see below) and is one of the earliest examples of
cellular automata. Those cellular automata can be conveniently regarded as
an array of cells that are connected together with the notion of neighbours and
their vectorization is straightforward. Let me first define the game and we’ll
see how to vectorize it.</p>
<div class="legend admonition">
<p class="admonition-title"><strong>Figure 4.1</strong></p>
<p>Conus textile snail exhibits a cellular automaton pattern on its shell.
Image by <a class="reference external" href="https://commons.wikimedia.org/wiki/File:Textile_cone.JPG">Richard Ling</a>, 2005.</p>
</div>
<a class="bordered reference internal image-reference" href="_images/Textile-Cone-cropped.jpg"><img alt="_images/Textile-Cone-cropped.jpg" class="bordered" src="_images/Textile-Cone-cropped.jpg" style="width: 100%;" /></a>
<div class="section" id="the-game-of-life">
<h4><a class="toc-backref" href="#id91">The Game of Life</a><a class="headerlink" href="#the-game-of-life" title="Permalink to this headline">¶</a></h4>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Excerpt from the Wikipedia entry on the
<a class="reference external" href="https://en.wikipedia.org/wiki/Conway%27s_Game_of_Life">Game of Life</a></p>
</div>
<p>The Game of Life is a cellular automaton devised by the British mathematician
John Horton Conway in 1970. It is the best-known example of a cellular
automaton. The “game” is actually a zero-player game, meaning that its
evolution is determined by its initial state, needing no input from human
players. One interacts with the Game of Life by creating an initial
configuration and observing how it evolves.</p>
<p>The universe of the Game of Life is an infinite two-dimensional orthogonal grid
of square cells, each of which is in one of two possible states, live or
dead. Every cell interacts with its eight neighbours, which are the cells that
are directly horizontally, vertically, or diagonally adjacent. At each step in
time, the following transitions occur:</p>
<ol class="arabic simple">
<li><p>Any live cell with fewer than two live neighbours dies, as if by
underpopulation.</p></li>
<li><p>Any live cell with more than three live neighbours dies, as if by
overcrowding.</p></li>
<li><p>Any live cell with two or three live neighbours lives, unchanged, to the
next generation.</p></li>
<li><p>Any dead cell with exactly three live neighbours becomes a live cell.</p></li>
</ol>
<p>The initial pattern constitutes the ‘seed’ of the system. The first generation
is created by applying the above rules simultaneously to every cell in the seed
– births and deaths happen simultaneously, and the discrete moment at which
this happens is sometimes called a tick. (In other words, each generation is a
pure function of the one before.) The rules continue to be applied repeatedly
to create further generations.</p>
</div>
<div class="section" id="python-implementation">
<h4><a class="toc-backref" href="#id92">Python implementation</a><a class="headerlink" href="#python-implementation" title="Permalink to this headline">¶</a></h4>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>We could have used the more efficient python <a class="reference external" href="http://docs.python.org/3/library/array.html">array interface</a> but it is more convenient to
use the familiar list object.</p>
</div>
<p>In pure Python, we can code the Game of Life using a list of lists representing
the board where cells are supposed to evolve. Such a board will be equipped with
border of 0 that allows to accelerate things a bit by avoiding having specific
tests for borders when counting the number of neighbours.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">Z</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span>
     <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span>
     <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span>
     <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span>
     <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span>
     <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]]</span>
</pre></div>
</div>
<p>Taking the border into account, counting neighbours then is straightforward:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">compute_neighbours</span><span class="p">(</span><span class="n">Z</span><span class="p">):</span>
    <span class="n">shape</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">Z</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">Z</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">N</span>  <span class="o">=</span> <span class="p">[[</span><span class="mi">0</span><span class="p">,]</span><span class="o">*</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">N</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="n">y</span><span class="p">]</span> <span class="o">=</span> <span class="n">Z</span><span class="p">[</span><span class="n">x</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">y</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">Z</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="n">y</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">Z</span><span class="p">[</span><span class="n">x</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="n">y</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> \
                    <span class="o">+</span> <span class="n">Z</span><span class="p">[</span><span class="n">x</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">y</span><span class="p">]</span>            <span class="o">+</span><span class="n">Z</span><span class="p">[</span><span class="n">x</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="n">y</span><span class="p">]</span>   \
                    <span class="o">+</span> <span class="n">Z</span><span class="p">[</span><span class="n">x</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">y</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">Z</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="n">y</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">Z</span><span class="p">[</span><span class="n">x</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="n">y</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">N</span>
</pre></div>
</div>
<p>To iterate one step in time, we then simply count the number of neighbours for
each internal cell and we update the whole board according to the four
aforementioned rules:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">iterate</span><span class="p">(</span><span class="n">Z</span><span class="p">):</span>
    <span class="n">N</span> <span class="o">=</span> <span class="n">compute_neighbours</span><span class="p">(</span><span class="n">Z</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
             <span class="k">if</span> <span class="n">Z</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="n">y</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="p">(</span><span class="n">N</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="n">y</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="ow">or</span> <span class="n">N</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="n">y</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">):</span>
                 <span class="n">Z</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="n">y</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
             <span class="k">elif</span> <span class="n">Z</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="n">y</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">N</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="n">y</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                 <span class="n">Z</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="n">y</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">Z</span>
</pre></div>
</div>
<p>The figure below shows four iterations on a 4x4 area where the initial state is a
<a class="reference external" href="https://en.wikipedia.org/wiki/Glider_(Conway%27s_Life)">glider</a>, a structure
discovered by Richard K. Guy in 1970.</p>
<div class="legend admonition">
<p class="admonition-title"><strong>Figure 4.2</strong></p>
<p>The glider pattern is known to replicate itself one step diagonally in 4
iterations.</p>
</div>
<a class="reference internal image-reference" href="_images/glider.png"><img alt="_images/glider.png" src="_images/glider.png" style="width: 100%;" /></a>
</div>
<div class="section" id="numpy-implementation">
<h4><a class="toc-backref" href="#id93">NumPy implementation</a><a class="headerlink" href="#numpy-implementation" title="Permalink to this headline">¶</a></h4>
<p>Starting from the Python version, the vectorization of the Game of Life
requires two parts, one responsible for counting the neighbours and one
responsible for enforcing the rules. Neighbour-counting is relatively easy if
we remember we took care of adding a null border around the arena. By
considering partial views of the arena we can actually access neighbours quite
intuitively as illustrated below for the one-dimensional case:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>               ┏━━━┳━━━┳━━━┓───┬───┐
        Z[:-2] ┃ 0 ┃ 1 ┃ 1 ┃ 1 │ 0 │ (left neighbours)
               ┗━━━┻━━━┻━━━┛───┴───┘
                     ↓︎
           ┌───┏━━━┳━━━┳━━━┓───┐
   Z[1:-1] │ 0 ┃ 1 ┃ 1 ┃ 1 ┃ 0 │ (actual cells)
           └───┗━━━┻━━━┻━━━┛───┘
                     ↑
       ┌───┬───┏━━━┳━━━┳━━━┓
Z[+2:] │ 0 │ 1 ┃ 1 ┃ 1 ┃ 0 ┃ (right neighbours)
       └───┴───┗━━━┻━━━┻━━━┛
</pre></div>
</div>
<p>Going to the two dimensional case requires just a bit of arithmetic to make
sure to consider all the eight neighbours.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">N</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">Z</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
<span class="n">N</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="n">Z</span><span class="p">[</span> <span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">Z</span><span class="p">[</span> <span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">Z</span><span class="p">[</span> <span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">:]</span> <span class="o">+</span>
                 <span class="n">Z</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>                <span class="o">+</span> <span class="n">Z</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">:]</span> <span class="o">+</span>
                 <span class="n">Z</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span>  <span class="p">,</span> <span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">Z</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span>  <span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">Z</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span>  <span class="p">,</span><span class="mi">2</span><span class="p">:])</span>
</pre></div>
</div>
<p>For the rule enforcement, we can write a first version using NumPy’s
<a class="reference external" href="http://docs.scipy.org/doc/numpy/reference/generated/numpy.argwhere.html">argwhere</a>
method that will give us the indices where a given condition is True.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Flatten arrays</span>
<span class="n">N_</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
<span class="n">Z_</span> <span class="o">=</span> <span class="n">Z</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

<span class="c1"># Apply rules</span>
<span class="n">R1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span> <span class="p">(</span><span class="n">Z_</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">N_</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">)</span>
<span class="n">R2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span> <span class="p">(</span><span class="n">Z_</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">N_</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">)</span>
<span class="n">R3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span> <span class="p">(</span><span class="n">Z_</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">((</span><span class="n">N_</span><span class="o">==</span><span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">N_</span><span class="o">==</span><span class="mi">3</span><span class="p">))</span> <span class="p">)</span>
<span class="n">R4</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span> <span class="p">(</span><span class="n">Z_</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">N_</span><span class="o">==</span><span class="mi">3</span><span class="p">)</span> <span class="p">)</span>

<span class="c1"># Set new values</span>
<span class="n">Z_</span><span class="p">[</span><span class="n">R1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">Z_</span><span class="p">[</span><span class="n">R2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">Z_</span><span class="p">[</span><span class="n">R3</span><span class="p">]</span> <span class="o">=</span> <span class="n">Z_</span><span class="p">[</span><span class="n">R3</span><span class="p">]</span>
<span class="n">Z_</span><span class="p">[</span><span class="n">R4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

<span class="c1"># Make sure borders stay null</span>
<span class="n">Z</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">Z</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">Z</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">Z</span><span class="p">[:,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</pre></div>
</div>
<p>Even if this first version does not use nested loops, it is far from optimal
because of the use of the four <code class="code docutils literal notranslate"><span class="pre">argwhere</span></code> calls that may be quite slow. We can
instead factorize the rules into cells that will survive (stay at 1) and cells
that will give birth. For doing this, we can take advantage of NumPy boolean
capability and write quite naturally:</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>We did not write <code class="code docutils literal notranslate"><span class="pre">Z</span> <span class="pre">=</span> <span class="pre">0</span></code> as this would simply assign the value 0 to <code class="code docutils literal notranslate"><span class="pre">Z</span></code> that
would then become a simple scalar.</p>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">birth</span> <span class="o">=</span> <span class="p">(</span><span class="n">N</span><span class="o">==</span><span class="mi">3</span><span class="p">)[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">Z</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span>
<span class="n">survive</span> <span class="o">=</span> <span class="p">((</span><span class="n">N</span><span class="o">==</span><span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">N</span><span class="o">==</span><span class="mi">3</span><span class="p">))[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">Z</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span>
<span class="n">Z</span><span class="p">[</span><span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">Z</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">birth</span> <span class="o">|</span> <span class="n">survive</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</pre></div>
</div>
<p>If you look at the <code class="code docutils literal notranslate"><span class="pre">birth</span></code> and <code class="code docutils literal notranslate"><span class="pre">survive</span></code> lines, you’ll see that these two
variables are arrays that can be used to set <code class="code docutils literal notranslate"><span class="pre">Z</span></code> values to 1 after having
cleared it.</p>
<div class="legend admonition">
<p class="admonition-title"><strong>Figure 4.3</strong></p>
<p>The Game of Life. Gray levels indicate how much a cell has been active in
the past.</p>
</div>
<video width="100%" class="bordered" controls>
<source src="data/game-of-life.mp4" type="video/mp4">
Your browser does not support the video tag. </video></div>
<div class="section" id="exercise">
<h4><a class="toc-backref" href="#id94">Exercise</a><a class="headerlink" href="#exercise" title="Permalink to this headline">¶</a></h4>
<p>Reaction and diffusion of chemical species can produce a variety of
patterns, reminiscent of those often seen in nature. The Gray-Scott
equations model such a reaction. For more information on this chemical
system see the article <em>Complex Patterns in a Simple System</em>
(John E. Pearson, Science, Volume 261, 1993). Let’s consider two
chemical species <span class="math notranslate nohighlight">\(U\)</span> and <span class="math notranslate nohighlight">\(V\)</span> with respective
concentrations <span class="math notranslate nohighlight">\(u\)</span> and <span class="math notranslate nohighlight">\(v\)</span> and diffusion rates <span class="math notranslate nohighlight">\(Du\)</span>
and <span class="math notranslate nohighlight">\(Dv\)</span>. <span class="math notranslate nohighlight">\(V\)</span> is converted into <span class="math notranslate nohighlight">\(P\)</span> with a rate of
conversion <span class="math notranslate nohighlight">\(k\)</span>. <span class="math notranslate nohighlight">\(f\)</span> represents the rate of the process
that feeds <span class="math notranslate nohighlight">\(U\)</span> and drains <span class="math notranslate nohighlight">\(U\)</span>, <span class="math notranslate nohighlight">\(V\)</span> and
<span class="math notranslate nohighlight">\(P\)</span>. This can be written as:</p>
<table class="colwidths-given table">
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Chemical reaction</p></th>
<th class="head"><p>Equations</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><span class="math notranslate nohighlight">\(U + 2V  \rightarrow 3V\)</span></p></td>
<td><p><span class="math notranslate nohighlight">\(\dot{u} = Du \nabla^2 u - uv^2 + f(1-u)\)</span></p></td>
</tr>
<tr class="row-odd"><td><p><span class="math notranslate nohighlight">\(V  \rightarrow P\)</span></p></td>
<td><p><span class="math notranslate nohighlight">\(\dot{v} = Dv \nabla^2 v + uv^2 - (f+k)v\)</span></p></td>
</tr>
</tbody>
</table>
<p>Based on the Game of Life example, try to implement such reaction-diffusion system.
Here is a set of interesting parameters to test:</p>
<table class="table">
<colgroup>
<col style="width: 39%" />
<col style="width: 15%" />
<col style="width: 15%" />
<col style="width: 15%" />
<col style="width: 15%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Name</p></th>
<th class="head"><p>Du</p></th>
<th class="head"><p>Dv</p></th>
<th class="head"><p>f</p></th>
<th class="head"><p>k</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Bacteria 1</p></td>
<td><p>0.16</p></td>
<td><p>0.08</p></td>
<td><p>0.035</p></td>
<td><p>0.065</p></td>
</tr>
<tr class="row-odd"><td><p>Bacteria 2</p></td>
<td><p>0.14</p></td>
<td><p>0.06</p></td>
<td><p>0.035</p></td>
<td><p>0.065</p></td>
</tr>
<tr class="row-even"><td><p>Coral</p></td>
<td><p>0.16</p></td>
<td><p>0.08</p></td>
<td><p>0.060</p></td>
<td><p>0.062</p></td>
</tr>
<tr class="row-odd"><td><p>Fingerprint</p></td>
<td><p>0.19</p></td>
<td><p>0.05</p></td>
<td><p>0.060</p></td>
<td><p>0.062</p></td>
</tr>
<tr class="row-even"><td><p>Spirals</p></td>
<td><p>0.10</p></td>
<td><p>0.10</p></td>
<td><p>0.018</p></td>
<td><p>0.050</p></td>
</tr>
<tr class="row-odd"><td><p>Spirals Dense</p></td>
<td><p>0.12</p></td>
<td><p>0.08</p></td>
<td><p>0.020</p></td>
<td><p>0.050</p></td>
</tr>
<tr class="row-even"><td><p>Spirals Fast</p></td>
<td><p>0.10</p></td>
<td><p>0.16</p></td>
<td><p>0.020</p></td>
<td><p>0.050</p></td>
</tr>
<tr class="row-odd"><td><p>Unstable</p></td>
<td><p>0.16</p></td>
<td><p>0.08</p></td>
<td><p>0.020</p></td>
<td><p>0.055</p></td>
</tr>
<tr class="row-even"><td><p>Worms 1</p></td>
<td><p>0.16</p></td>
<td><p>0.08</p></td>
<td><p>0.050</p></td>
<td><p>0.065</p></td>
</tr>
<tr class="row-odd"><td><p>Worms 2</p></td>
<td><p>0.16</p></td>
<td><p>0.08</p></td>
<td><p>0.054</p></td>
<td><p>0.063</p></td>
</tr>
<tr class="row-even"><td><p>Zebrafish</p></td>
<td><p>0.16</p></td>
<td><p>0.08</p></td>
<td><p>0.035</p></td>
<td><p>0.060</p></td>
</tr>
</tbody>
</table>
<p>The figure below shows some animations of the model for a specific set of parameters.</p>
<div class="legend admonition">
<p class="admonition-title"><strong>Figure 4.4</strong></p>
<p>Reaction-diffusion Gray-Scott model. From left to right, <em>Bacteria 1</em>, <em>Coral</em> and
<em>Spiral Dense</em>.</p>
</div>
<video width="33%" controls>
<source src="data/gray-scott-1.mp4" type="video/mp4">
Your browser does not support the video tag. </video>

<video width="33%" controls>
<source src="data/gray-scott-2.mp4" type="video/mp4">
Your browser does not support the video tag. </video>

<video width="33%" controls>
<source src="data/gray-scott-3.mp4" type="video/mp4">
Your browser does not support the video tag. </video></div>
<div class="section" id="sources">
<h4><a class="toc-backref" href="#id95">Sources</a><a class="headerlink" href="#sources" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li><p><a class="reference external" href="code/game_of_life_python.py">game_of_life_python.py</a></p></li>
<li><p><a class="reference external" href="code/game_of_life_numpy.py">game_of_life_numpy.py</a></p></li>
<li><p><a class="reference external" href="code/gray_scott.py">gray_scott.py</a> (solution to the exercise)</p></li>
</ul>
</div>
<div class="section" id="references">
<h4><a class="toc-backref" href="#id96">References</a><a class="headerlink" href="#references" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li><p><a class="reference external" href="https://web.archive.org/web/20090603015231/http://ddi.cs.uni-potsdam.de/HyFISCH/Produzieren/lis_projekt/proj_gamelife/ConwayScientificAmerican.htm">John Conway new solitaire game “life”</a>, Martin Gardner, Scientific American 223, 1970.</p></li>
<li><p><a class="reference external" href="http://groups.csail.mit.edu/mac/projects/amorphous/GrayScott/">Gray Scott Model of Reaction Diffusion</a>, Abelson, Adams, Coore, Hanson, Nagpal, Sussman, 1997.</p></li>
<li><p><a class="reference external" href="http://mrob.com/pub/comp/xmorphia/">Reaction-Diffusion by the Gray-Scott Model</a>,
Robert P. Munafo, 1996.</p></li>
</ul>
</div>
</div>
<div class="section" id="temporal-vectorization">
<h3><a class="toc-backref" href="#id97">Temporal vectorization</a><a class="headerlink" href="#temporal-vectorization" title="Permalink to this headline">¶</a></h3>
<p>The Mandelbrot set is the set of complex numbers <span class="math notranslate nohighlight">\(c\)</span> for which
the function <span class="math notranslate nohighlight">\(f_c(z) = z^2+ c\)</span> does not diverge when iterated
from <span class="math notranslate nohighlight">\(z=0\)</span>, i.e., for which the sequence <span class="math notranslate nohighlight">\(f_c(0),
f_c(f_c(0))\)</span>, etc., remains bounded in absolute value. It is very easy
to compute, but it can take a very long time because you need to
ensure a given number does not diverge. This is generally done by
iterating the computation up to a maximum number of iterations, after
which, if the number is still within some bounds, it is considered
non-divergent. Of course, the more iterations you do, the more
precision you get.</p>
<div class="legend admonition">
<p class="admonition-title"><strong>Figure 4.5</strong></p>
<p>Romanesco broccoli, showing self-similar form approximating a natural fractal.
Image by <a class="reference external" href="https://commons.wikimedia.org/wiki/File:Fractal_Broccoli.jpg">Jon Sullivan</a>, 2004.</p>
</div>
<a class="bordered reference internal image-reference" href="_images/Fractal-Broccoli-cropped.jpg"><img alt="_images/Fractal-Broccoli-cropped.jpg" class="bordered" src="_images/Fractal-Broccoli-cropped.jpg" style="width: 100%;" /></a>
<div class="section" id="id8">
<h4><a class="toc-backref" href="#id98">Python implementation</a><a class="headerlink" href="#id8" title="Permalink to this headline">¶</a></h4>
<p>A pure python implementation is written as:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">mandelbrot_python</span><span class="p">(</span><span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span><span class="p">,</span> <span class="n">xn</span><span class="p">,</span> <span class="n">yn</span><span class="p">,</span> <span class="n">maxiter</span><span class="p">,</span> <span class="n">horizon</span><span class="o">=</span><span class="mf">2.0</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">mandelbrot</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">maxiter</span><span class="p">):</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">z</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">maxiter</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">z</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">horizon</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">n</span>
            <span class="n">z</span> <span class="o">=</span> <span class="n">z</span><span class="o">*</span><span class="n">z</span> <span class="o">+</span> <span class="n">c</span>
        <span class="k">return</span> <span class="n">maxiter</span>
    <span class="n">r1</span> <span class="o">=</span> <span class="p">[</span><span class="n">xmin</span><span class="o">+</span><span class="n">i</span><span class="o">*</span><span class="p">(</span><span class="n">xmax</span><span class="o">-</span><span class="n">xmin</span><span class="p">)</span><span class="o">/</span><span class="n">xn</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">xn</span><span class="p">)]</span>
    <span class="n">r2</span> <span class="o">=</span> <span class="p">[</span><span class="n">ymin</span><span class="o">+</span><span class="n">i</span><span class="o">*</span><span class="p">(</span><span class="n">ymax</span><span class="o">-</span><span class="n">ymin</span><span class="p">)</span><span class="o">/</span><span class="n">yn</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">yn</span><span class="p">)]</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">mandelbrot</span><span class="p">(</span><span class="nb">complex</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">i</span><span class="p">),</span><span class="n">maxiter</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">r1</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">r2</span><span class="p">]</span>
</pre></div>
</div>
<p>The interesting (and slow) part of this code is the <code class="code docutils literal notranslate"><span class="pre">mandelbrot</span></code> function that
actually computes the sequence <span class="math notranslate nohighlight">\(f_c(f_c(f_c ...)))\)</span>. The vectorization of
such code is not totally straightforward because the internal <code class="code docutils literal notranslate"><span class="pre">return</span></code> implies a
differential processing of the element. Once it has diverged, we don’t need to
iterate any more and we can safely return the iteration count at
divergence. The problem is to then do the same in NumPy. But how?</p>
</div>
<div class="section" id="id9">
<h4><a class="toc-backref" href="#id99">NumPy implementation</a><a class="headerlink" href="#id9" title="Permalink to this headline">¶</a></h4>
<p>The trick is to search at each iteration values that have not yet
diverged and update relevant information for these values and only
these values. Because we start from <span class="math notranslate nohighlight">\(Z = 0\)</span>, we know that each
value will be updated at least once (when they’re equal to <span class="math notranslate nohighlight">\(0\)</span>,
they have not yet diverged) and will stop being updated as soon as
they’ve diverged. To do that, we’ll use NumPy fancy indexing with the
<code class="code docutils literal notranslate"><span class="pre">less(x1,x2)</span></code> function that return the truth value of <code class="code docutils literal notranslate"><span class="pre">(x1</span> <span class="pre">&lt;</span> <span class="pre">x2)</span></code>
element-wise.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">mandelbrot_numpy</span><span class="p">(</span><span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span><span class="p">,</span> <span class="n">xn</span><span class="p">,</span> <span class="n">yn</span><span class="p">,</span> <span class="n">maxiter</span><span class="p">,</span> <span class="n">horizon</span><span class="o">=</span><span class="mf">2.0</span><span class="p">):</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">xn</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span><span class="p">,</span> <span class="n">yn</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">C</span> <span class="o">=</span> <span class="n">X</span> <span class="o">+</span> <span class="n">Y</span><span class="p">[:,</span><span class="kc">None</span><span class="p">]</span><span class="o">*</span><span class="mi">1</span><span class="n">j</span>
    <span class="n">N</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">C</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">C</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">complex64</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">maxiter</span><span class="p">):</span>
        <span class="n">I</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">less</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">Z</span><span class="p">),</span> <span class="n">horizon</span><span class="p">)</span>
        <span class="n">N</span><span class="p">[</span><span class="n">I</span><span class="p">]</span> <span class="o">=</span> <span class="n">n</span>
        <span class="n">Z</span><span class="p">[</span><span class="n">I</span><span class="p">]</span> <span class="o">=</span> <span class="n">Z</span><span class="p">[</span><span class="n">I</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">C</span><span class="p">[</span><span class="n">I</span><span class="p">]</span>
    <span class="n">N</span><span class="p">[</span><span class="n">N</span> <span class="o">==</span> <span class="n">maxiter</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="n">Z</span><span class="p">,</span> <span class="n">N</span>
</pre></div>
</div>
<p>Here is the benchmark:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">xn</span> <span class="o">=</span> <span class="o">-</span><span class="mf">2.25</span><span class="p">,</span> <span class="o">+</span><span class="mf">0.75</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="mi">3000</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span><span class="p">,</span> <span class="n">yn</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.25</span><span class="p">,</span> <span class="o">+</span><span class="mf">1.25</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="mi">2500</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">maxiter</span> <span class="o">=</span> <span class="mi">200</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">timeit</span><span class="p">(</span><span class="s2">&quot;mandelbrot_python(xmin, xmax, ymin, ymax, xn, yn, maxiter)&quot;</span><span class="p">,</span> <span class="nb">globals</span><span class="p">())</span>
<span class="go">1 loops, best of 3: 6.1 sec per loop</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">timeit</span><span class="p">(</span><span class="s2">&quot;mandelbrot_numpy(xmin, xmax, ymin, ymax, xn, yn, maxiter)&quot;</span><span class="p">,</span> <span class="nb">globals</span><span class="p">())</span>
<span class="go">1 loops, best of 3: 1.15 sec per loop</span>
</pre></div>
</div>
</div>
<div class="section" id="faster-numpy-implementation">
<h4><a class="toc-backref" href="#id100">Faster NumPy implementation</a><a class="headerlink" href="#faster-numpy-implementation" title="Permalink to this headline">¶</a></h4>
<p>The gain is roughly a 5x factor, not as much as we could have
expected. Part of the problem is that the <code class="code docutils literal notranslate"><span class="pre">np.less</span></code> function implies
<span class="math notranslate nohighlight">\(xn \times yn\)</span> tests at every iteration while we know that some
values have already diverged. Even if these tests are performed at the
C level (through NumPy), the cost is nonetheless
significant. Another approach proposed by <a class="reference external" href="https://thesamovar.wordpress.com/">Dan Goodman</a> is to work on a dynamic array at
each iteration that stores only the points which have not yet
diverged. It requires more lines but the result is faster and leads to
a 10x factor speed improvement compared to the Python version.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">mandelbrot_numpy_2</span><span class="p">(</span><span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span><span class="p">,</span> <span class="n">xn</span><span class="p">,</span> <span class="n">yn</span><span class="p">,</span> <span class="n">itermax</span><span class="p">,</span> <span class="n">horizon</span><span class="o">=</span><span class="mf">2.0</span><span class="p">):</span>
    <span class="n">Xi</span><span class="p">,</span> <span class="n">Yi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mgrid</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">xn</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="n">yn</span><span class="p">]</span>
    <span class="n">Xi</span><span class="p">,</span> <span class="n">Yi</span> <span class="o">=</span> <span class="n">Xi</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">),</span> <span class="n">Yi</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">)</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">xn</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)[</span><span class="n">Xi</span><span class="p">]</span>
    <span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span><span class="p">,</span> <span class="n">yn</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)[</span><span class="n">Yi</span><span class="p">]</span>
    <span class="n">C</span> <span class="o">=</span> <span class="n">X</span> <span class="o">+</span> <span class="n">Y</span><span class="o">*</span><span class="mi">1</span><span class="n">j</span>
    <span class="n">N_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">C</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">)</span>
    <span class="n">Z_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">C</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">complex64</span><span class="p">)</span>
    <span class="n">Xi</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="n">Yi</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="n">C</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="n">xn</span><span class="o">*</span><span class="n">yn</span>

    <span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">C</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">complex64</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">itermax</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">Z</span><span class="p">):</span> <span class="k">break</span>

        <span class="c1"># Compute for relevant points only</span>
        <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span> <span class="n">Z</span><span class="p">,</span> <span class="n">Z</span><span class="p">)</span>
        <span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">Z</span><span class="p">)</span>

        <span class="c1"># Failed convergence</span>
        <span class="n">I</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">Z</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">horizon</span>
        <span class="n">N_</span><span class="p">[</span><span class="n">Xi</span><span class="p">[</span><span class="n">I</span><span class="p">],</span> <span class="n">Yi</span><span class="p">[</span><span class="n">I</span><span class="p">]]</span> <span class="o">=</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span>
        <span class="n">Z_</span><span class="p">[</span><span class="n">Xi</span><span class="p">[</span><span class="n">I</span><span class="p">],</span> <span class="n">Yi</span><span class="p">[</span><span class="n">I</span><span class="p">]]</span> <span class="o">=</span> <span class="n">Z</span><span class="p">[</span><span class="n">I</span><span class="p">]</span>

        <span class="c1"># Keep going with those who have not diverged yet</span>
        <span class="n">np</span><span class="o">.</span><span class="n">negative</span><span class="p">(</span><span class="n">I</span><span class="p">,</span><span class="n">I</span><span class="p">)</span>
        <span class="n">Z</span> <span class="o">=</span> <span class="n">Z</span><span class="p">[</span><span class="n">I</span><span class="p">]</span>
        <span class="n">Xi</span><span class="p">,</span> <span class="n">Yi</span> <span class="o">=</span> <span class="n">Xi</span><span class="p">[</span><span class="n">I</span><span class="p">],</span> <span class="n">Yi</span><span class="p">[</span><span class="n">I</span><span class="p">]</span>
        <span class="n">C</span> <span class="o">=</span> <span class="n">C</span><span class="p">[</span><span class="n">I</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">Z_</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">N_</span><span class="o">.</span><span class="n">T</span>
</pre></div>
</div>
<p>The benchmark gives us:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">timeit</span><span class="p">(</span><span class="s2">&quot;mandelbrot_numpy_2(xmin, xmax, ymin, ymax, xn, yn, maxiter)&quot;</span><span class="p">,</span> <span class="nb">globals</span><span class="p">())</span>
<span class="go">1 loops, best of 3: 510 msec per loop</span>
</pre></div>
</div>
</div>
<div class="section" id="visualization">
<h4><a class="toc-backref" href="#id101">Visualization</a><a class="headerlink" href="#visualization" title="Permalink to this headline">¶</a></h4>
<p>In order to visualize our results, we could directly display the <code class="code docutils literal notranslate"><span class="pre">N</span></code> array
using the matplotlib <code class="code docutils literal notranslate"><span class="pre">imshow</span></code> command, but this would result in a “banded” image
that is a known consequence of the escape count algorithm that we’ve been
using. Such banding can be eliminated by using a fractional escape count. This
can be done by measuring how far the iterated point landed outside of the
escape cutoff. See the reference below about the renormalization of the escape
count. Here is a picture of the result where we use recount normalization,
and added a power normalized color map (gamma=0.3) as well as light shading.</p>
<div class="legend admonition">
<p class="admonition-title"><strong>Figure 4.6</strong></p>
<p>The Mandelbrot as rendered by matplotlib using recount normalization, power
normalized color map (gamma=0.3) and light shading.</p>
</div>
<div class="figure align-default">
<a class="bordered reference internal image-reference" href="_images/mandelbrot.png"><img alt="_images/mandelbrot.png" class="bordered" src="_images/mandelbrot.png" style="width: 100%;" /></a>
</div>
</div>
<div class="section" id="id10">
<h4><a class="toc-backref" href="#id102">Exercise</a><a class="headerlink" href="#id10" title="Permalink to this headline">¶</a></h4>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>You should look at the <a class="reference external" href="https://docs.scipy.org/doc/numpy/reference/generated/numpy.ufunc.reduceat.html">ufunc.reduceat</a> method that performs a (local) reduce with specified slices over a single axis.</p>
</div>
<p>We now want to measure the fractal dimension of the Mandelbrot set using the
<a class="reference external" href="https://en.wikipedia.org/wiki/Minkowski–Bouligand_dimension">Minkowski–Bouligand dimension</a>. To do that, we
need to do box-counting with a decreasing box size (see figure below). As you
can imagine, we cannot use pure Python because it would be way too slow. The goal of
the exercise is to write a function using NumPy that takes a two-dimensional
float array and returns the dimension. We’ll consider values in the array to be
normalized (i.e. all values are between 0 and 1).</p>
<div class="legend admonition">
<p class="admonition-title"><strong>Figure 4.7</strong></p>
<p>The Minkowski–Bouligand dimension of the Great Britain coastlines is
approximately 1.24.</p>
</div>
<div class="figure align-default">
<a class="reference internal image-reference" href="_images/fractal-dimension.png"><img alt="_images/fractal-dimension.png" src="_images/fractal-dimension.png" style="width: 100%;" /></a>
</div>
</div>
<div class="section" id="id11">
<h4><a class="toc-backref" href="#id103">Sources</a><a class="headerlink" href="#id11" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li><p><a class="reference external" href="code/mandelbrot.py">mandelbrot.py</a></p></li>
<li><p><a class="reference external" href="code/mandelbrot_python.py">mandelbrot_python.py</a></p></li>
<li><p><a class="reference external" href="code/mandelbrot_numpy_1.py">mandelbrot_numpy_1.py</a></p></li>
<li><p><a class="reference external" href="code/mandelbrot_numpy_2.py">mandelbrot_numpy_2.py</a></p></li>
<li><p><a class="reference external" href="code/fractal_dimension.py">fractal_dimension.py</a> (solution to the exercise)</p></li>
</ul>
</div>
<div class="section" id="id12">
<h4><a class="toc-backref" href="#id104">References</a><a class="headerlink" href="#id12" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li><p><a class="reference external" href="https://www.ibm.com/developerworks/community/blogs/jfp/entry/How_To_Compute_Mandelbrodt_Set_Quickly?lang=en">How To Quickly Compute the Mandelbrot Set in Python</a>, Jean Francois Puget, 2015.</p></li>
<li><p><a class="reference external" href="https://www.ibm.com/developerworks/community/blogs/jfp/entry/My_Christmas_Gift?lang=en">My Christmas Gift: Mandelbrot Set Computation In Python</a>, Jean Francois Puget, 2015.</p></li>
<li><p><a class="reference external" href="https://thesamovar.wordpress.com/2009/03/22/fast-fractals-with-python-and-numpy/">Fast fractals with Python and NumPy</a>, Dan Goodman, 2009.</p></li>
<li><p><a class="reference external" href="http://linas.org/art-gallery/escape/escape.html">Renormalizing the Mandelbrot Escape</a>, Linas Vepstas, 1997.</p></li>
</ul>
</div>
</div>
<div class="section" id="spatial-vectorization">
<h3><a class="toc-backref" href="#id105">Spatial vectorization</a><a class="headerlink" href="#spatial-vectorization" title="Permalink to this headline">¶</a></h3>
<p>Spatial vectorization refers to a situation where elements share the same
computation but are in interaction with only a subgroup of other elements. This
was already the case for the game of life example, but in some situations
there is an added difficulty because the subgroup is dynamic and needs to be
updated at each iteration. This the case, for example, in particle systems where
particles interact mostly with local neighbours. This is also the case for
“boids” that simulate flocking behaviors.</p>
<div class="legend admonition">
<p class="admonition-title"><strong>Figure 4.8</strong></p>
<p>Flocking birds are an example of self-organization in biology.
Image by <a class="reference external" href="https://commons.wikimedia.org/wiki/File:Fugle,_ørnsø_073.jpg">Christoffer A Rasmussen</a>, 2012.</p>
</div>
<a class="bordered reference internal image-reference" href="_images/Fugle-cropped.jpg"><img alt="_images/Fugle-cropped.jpg" class="bordered" src="_images/Fugle-cropped.jpg" style="width: 100%;" /></a>
<div class="section" id="boids">
<h4><a class="toc-backref" href="#id106">Boids</a><a class="headerlink" href="#boids" title="Permalink to this headline">¶</a></h4>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Excerpt from the Wikipedia entry
<a class="reference external" href="https://en.wikipedia.org/wiki/Boids">Boids</a></p>
</div>
<p>Boids is an artificial life program, developed by Craig Reynolds in 1986, which
simulates the flocking behaviour of birds. The name “boid” corresponds to a
shortened version of “bird-oid object”, which refers to a bird-like object.</p>
<p>As with most artificial life simulations, Boids is an example of emergent
behavior; that is, the complexity of Boids arises from the interaction of
individual agents (the boids, in this case) adhering to a set of simple
rules. The rules applied in the simplest Boids world are as follows:</p>
<ul class="simple">
<li><p><strong>separation</strong>: steer to avoid crowding local flock-mates</p></li>
<li><p><strong>alignment</strong>: steer towards the average heading of local flock-mates</p></li>
<li><p><strong>cohesion</strong>: steer to move toward the average position (center of mass) of
local flock-mates</p></li>
</ul>
<div class="legend admonition">
<p class="admonition-title"><strong>Figure 4.9</strong></p>
<p>Boids are governed by a set of three local rules (separation, cohesion and
alignment) that serve as computing velocity and acceleration.</p>
</div>
<a class="reference internal image-reference" href="_images/boids.png"><img alt="_images/boids.png" src="_images/boids.png" style="width: 100%;" /></a>
</div>
<div class="section" id="id14">
<h4><a class="toc-backref" href="#id107">Python implementation</a><a class="headerlink" href="#id14" title="Permalink to this headline">¶</a></h4>
<p>Since each boid is an autonomous entity with several properties such as
position and velocity, it seems natural to start by writing a Boid class:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">from</span> <span class="nn">vec2</span> <span class="kn">import</span> <span class="n">vec2</span>

<span class="k">class</span> <span class="nc">Boid</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="n">vec2</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
        <span class="n">angle</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">velocity</span> <span class="o">=</span> <span class="n">vec2</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">angle</span><span class="p">),</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">angle</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">acceleration</span> <span class="o">=</span> <span class="n">vec2</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
<p>The <code class="code docutils literal notranslate"><span class="pre">vec2</span></code> object is a very simple class that handles all common vector
operations with 2 components. It will save us some writing in the main <code class="code docutils literal notranslate"><span class="pre">Boid</span></code>
class. Note that there are some vector packages in the Python Package Index, but
that would be overkill for such a simple example.</p>
<p>Boid is a difficult case for regular Python because a boid has interaction with
local neighbours. However, and because boids are moving, to find such local
neighbours requires computing at each time step the distance to each and every
other boid in order to sort those which are in a given interaction radius. The
prototypical way of writing the three rules is thus something like:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">separation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">boids</span><span class="p">):</span>
    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">other</span> <span class="ow">in</span> <span class="n">boids</span><span class="p">:</span>
        <span class="n">d</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">position</span> <span class="o">-</span> <span class="n">other</span><span class="o">.</span><span class="n">position</span><span class="p">)</span><span class="o">.</span><span class="n">length</span><span class="p">()</span>
        <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">d</span> <span class="o">&lt;</span> <span class="n">desired_separation</span><span class="p">:</span>
            <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="o">...</span>
    <span class="k">if</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="o">...</span>

 <span class="k">def</span> <span class="nf">alignment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">boids</span><span class="p">):</span> <span class="o">...</span>
 <span class="k">def</span> <span class="nf">cohesion</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">boids</span><span class="p">):</span> <span class="o">...</span>
</pre></div>
</div>
<p>Full sources are given in the references section below, it would be too long to
describe it here and there is no real difficulty.</p>
<p>To complete the picture, we can also create a <code class="code docutils literal notranslate"><span class="pre">Flock</span></code> object:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Flock</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="mi">150</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">boids</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">count</span><span class="p">):</span>
            <span class="n">boid</span> <span class="o">=</span> <span class="n">Boid</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">boids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">boid</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">boid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">boids</span><span class="p">:</span>
            <span class="n">boid</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">boids</span><span class="p">)</span>
</pre></div>
</div>
<p>Using this approach, we can have up to 50 boids until the computation
time becomes too slow for a smooth animation. As you may have guessed,
we can do much better using NumPy, but let me first point out the main
problem with this Python implementation. If you look at the code, you
will certainly notice there is a lot of redundancy. More precisely, we
do not exploit the fact that the Euclidean distance is reflexive, that
is, <span class="math notranslate nohighlight">\(|x-y| = |y-x|\)</span>. In this naive Python implementation, each
rule (function) computes <span class="math notranslate nohighlight">\(n^2\)</span> distances while
<span class="math notranslate nohighlight">\(\frac{n^2}{2}\)</span> would be sufficient if properly
cached. Furthermore, each rule re-computes every distance without
caching the result for the other functions. In the end, we are
computing <span class="math notranslate nohighlight">\(3n^2\)</span> distances instead of <span class="math notranslate nohighlight">\(\frac{n^2}{2}\)</span>.</p>
</div>
<div class="section" id="id15">
<h4><a class="toc-backref" href="#id108">NumPy implementation</a><a class="headerlink" href="#id15" title="Permalink to this headline">¶</a></h4>
<p>As you might expect, the NumPy implementation takes a different approach and
we’ll gather all our boids into a <code class="code docutils literal notranslate"><span class="pre">position</span></code> array and a <code class="code docutils literal notranslate"><span class="pre">velocity</span></code> array:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">n</span> <span class="o">=</span> <span class="mi">500</span>
<span class="n">velocity</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="n">position</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</pre></div>
</div>
<p>The first step is to compute the local neighborhood for all boids, and for
this we need to compute all paired distances:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">dx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">subtract</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">position</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">position</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span>
<span class="n">dy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">subtract</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">position</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">position</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span>
<span class="n">distance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hypot</span><span class="p">(</span><span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">)</span>
</pre></div>
</div>
<p>We could have used the scipy <a class="reference external" href="https://docs.scipy.org/doc/scipy/reference/generated/scipy.spatial.distance.cdist.html">cdist</a>
but we’ll need the <code class="code docutils literal notranslate"><span class="pre">dx</span></code> and <code class="code docutils literal notranslate"><span class="pre">dy</span></code> arrays later. Once those have been computed,
it is faster to use the <a class="reference external" href="https://docs.scipy.org/doc/numpy/reference/generated/numpy.hypot.html">hypot</a>
method. Note that distance shape is <code class="code docutils literal notranslate"><span class="pre">(n,</span> <span class="pre">n)</span></code> and each line relates to one boid,
i.e. each line gives the distance to all other boids (including self).</p>
<p>From theses distances, we can now compute the local neighborhood for
each of the three rules, taking advantage of the fact that we can mix
them together. We can actually compute a mask for distances that are
strictly positive (i.e. have no self-interaction) and multiply it with
other distance masks.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If we suppose that boids cannot occupy the same position, how can you
compute <code class="code docutils literal notranslate"><span class="pre">mask_0</span></code> more efficiently?</p>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">mask_0</span> <span class="o">=</span> <span class="p">(</span><span class="n">distance</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">mask_1</span> <span class="o">=</span> <span class="p">(</span><span class="n">distance</span> <span class="o">&lt;</span> <span class="mi">25</span><span class="p">)</span>
<span class="n">mask_2</span> <span class="o">=</span> <span class="p">(</span><span class="n">distance</span> <span class="o">&lt;</span> <span class="mi">50</span><span class="p">)</span>
<span class="n">mask_1</span> <span class="o">*=</span> <span class="n">mask_0</span>
<span class="n">mask_2</span> <span class="o">*=</span> <span class="n">mask_0</span>
<span class="n">mask_3</span> <span class="o">=</span> <span class="n">mask_2</span>
</pre></div>
</div>
<p>Then, we compute the number of neighbours within the given radius and we ensure
it is at least 1 to avoid division by zero.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">mask_1_count</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">mask_1</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">mask_2_count</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">mask_2</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">mask_3_count</span> <span class="o">=</span> <span class="n">mask_2_count</span>
</pre></div>
</div>
<p>We’re ready to write our three rules:</p>
<p><strong>Alignment</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Compute the average velocity of local neighbours</span>
<span class="n">target</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">velocity</span><span class="p">)</span><span class="o">/</span><span class="n">count</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="c1"># Normalize the result</span>
<span class="n">norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">target</span><span class="o">*</span><span class="n">target</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">norm</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">target</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="n">norm</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>

<span class="c1"># Alignment at constant speed</span>
<span class="n">target</span> <span class="o">*=</span> <span class="n">max_velocity</span>

<span class="c1"># Compute the resulting steering</span>
<span class="n">alignment</span> <span class="o">=</span> <span class="n">target</span> <span class="o">-</span> <span class="n">velocity</span>
</pre></div>
</div>
<p><strong>Cohesion</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Compute the gravity center of local neighbours</span>
<span class="n">center</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">position</span><span class="p">)</span><span class="o">/</span><span class="n">count</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="c1"># Compute direction toward the center</span>
<span class="n">target</span> <span class="o">=</span> <span class="n">center</span> <span class="o">-</span> <span class="n">position</span>

<span class="c1"># Normalize the result</span>
<span class="n">norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">target</span><span class="o">*</span><span class="n">target</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">norm</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">target</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="n">norm</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>

<span class="c1"># Cohesion at constant speed (max_velocity)</span>
<span class="n">target</span> <span class="o">*=</span> <span class="n">max_velocity</span>

<span class="c1"># Compute the resulting steering</span>
<span class="n">cohesion</span> <span class="o">=</span> <span class="n">target</span> <span class="o">-</span> <span class="n">velocity</span>
</pre></div>
</div>
<p><strong>Separation</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Compute the repulsion force from local neighbours</span>
<span class="n">repulsion</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dstack</span><span class="p">((</span><span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">))</span>

<span class="c1"># Force is inversely proportional to the distance</span>
<span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">repulsion</span><span class="p">,</span> <span class="n">distance</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">repulsion</span><span class="p">,</span>
          <span class="n">where</span><span class="o">=</span><span class="n">distance</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>

<span class="c1"># Compute direction away from others</span>
<span class="n">target</span> <span class="o">=</span> <span class="p">(</span><span class="n">repulsion</span><span class="o">*</span><span class="n">mask</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">count</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="c1"># Normalize the result</span>
<span class="n">norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">target</span><span class="o">*</span><span class="n">target</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">norm</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">target</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="n">norm</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>

<span class="c1"># Separation at constant speed (max_velocity)</span>
<span class="n">target</span> <span class="o">*=</span> <span class="n">max_velocity</span>

<span class="c1"># Compute the resulting steering</span>
<span class="n">separation</span> <span class="o">=</span> <span class="n">target</span> <span class="o">-</span> <span class="n">velocity</span>
</pre></div>
</div>
<p>All three resulting steerings (separation, alignment &amp; cohesion) need to
be limited in magnitude. We leave this as an exercise for the reader. Combination
of these rules is straightforward as well as the resulting update of
velocity and position:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">acceleration</span> <span class="o">=</span> <span class="mf">1.5</span> <span class="o">*</span> <span class="n">separation</span> <span class="o">+</span> <span class="n">alignment</span> <span class="o">+</span> <span class="n">cohesion</span>
<span class="n">velocity</span> <span class="o">+=</span> <span class="n">acceleration</span>
<span class="n">position</span> <span class="o">+=</span> <span class="n">velocity</span>
</pre></div>
</div>
<p>We finally visualize the result using a custom oriented scatter plot.</p>
<div class="legend admonition">
<p class="admonition-title"><strong>Figure 4.10</strong></p>
<p>Boids is an artificial life program, developed by Craig Reynolds in 1986,
which simulates the flocking behaviour of birds.</p>
</div>
<video width="100%" class="bordered" controls>
<source src="data/boids.mp4" type="video/mp4">
Your browser does not support the video tag. </video></div>
<div class="section" id="id16">
<h4><a class="toc-backref" href="#id109">Exercise</a><a class="headerlink" href="#id16" title="Permalink to this headline">¶</a></h4>
<p>We are now ready to visualize our boids. The easiest way is to use the
matplotlib animation function and a scatter plot. Unfortunately, scatters
cannot be individually oriented and we need to make our own objects using a
matplotlib <code class="code docutils literal notranslate"><span class="pre">PathCollection</span></code>. A simple triangle path can be defined as:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">v</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([(</span><span class="o">-</span><span class="mf">0.25</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.25</span><span class="p">),</span>
             <span class="p">(</span> <span class="mf">0.00</span><span class="p">,</span>  <span class="mf">0.50</span><span class="p">),</span>
             <span class="p">(</span> <span class="mf">0.25</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.25</span><span class="p">),</span>
             <span class="p">(</span> <span class="mf">0.00</span><span class="p">,</span>  <span class="mf">0.00</span><span class="p">)])</span>
<span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">Path</span><span class="o">.</span><span class="n">MOVETO</span><span class="p">,</span>
              <span class="n">Path</span><span class="o">.</span><span class="n">LINETO</span><span class="p">,</span>
              <span class="n">Path</span><span class="o">.</span><span class="n">LINETO</span><span class="p">,</span>
              <span class="n">Path</span><span class="o">.</span><span class="n">CLOSEPOLY</span><span class="p">])</span>
</pre></div>
</div>
<p>This path can be repeated several times inside an array and each triangle can
be made independent.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">n</span> <span class="o">=</span> <span class="mi">500</span>
<span class="n">vertices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">n</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">codes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">n</span><span class="p">)</span>
</pre></div>
</div>
<p>We now have a <code class="code docutils literal notranslate"><span class="pre">(n,4,2)</span></code> array for vertices and a <code class="code docutils literal notranslate"><span class="pre">(n,4)</span></code> array for codes
representing <code class="code docutils literal notranslate"><span class="pre">n</span></code> boids. We are interested in manipulating the vertices array to
reflect the translation, scaling and rotation of each of the <code class="code docutils literal notranslate"><span class="pre">n</span></code> boids.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Rotate is really tricky.</p>
</div>
<p>How would you write the <code class="code docutils literal notranslate"><span class="pre">translate</span></code>, <code class="code docutils literal notranslate"><span class="pre">scale</span></code> and <code class="code docutils literal notranslate"><span class="pre">rotate</span></code> functions ?</p>
</div>
<div class="section" id="id17">
<h4><a class="toc-backref" href="#id110">Sources</a><a class="headerlink" href="#id17" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li><p><a class="reference external" href="code/boid_python.py">boid_python.py</a></p></li>
<li><p><a class="reference external" href="code/boid_numpy.py">boid_numpy.py</a> (solution to the exercise)</p></li>
</ul>
</div>
<div class="section" id="id18">
<h4><a class="toc-backref" href="#id111">References</a><a class="headerlink" href="#id18" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li><p><a class="reference external" href="https://processing.org/examples/flocking.html">Flocking</a>, Daniel Shiffman, 2010.</p></li>
<li><p><a class="reference external" href="http://www.red3d.com/cwr/boids/">Flocks, herds and schools: A distributed behavioral model</a>, Craig Reynolds, SIGGRAPH, 1987</p></li>
</ul>
</div>
</div>
<div class="section" id="id19">
<h3><a class="toc-backref" href="#id112">Conclusion</a><a class="headerlink" href="#id19" title="Permalink to this headline">¶</a></h3>
<p>We’ve seen through these examples three forms of code vectorization:</p>
<ul class="simple">
<li><p>Uniform vectorization where elements share the same computation
unconditionally and for the same duration.</p></li>
<li><p>Temporal vectorization where elements share the same computation but
necessitate a different number of iterations.</p></li>
<li><p>Spatial vectorization where elements share the same computation but on
dynamic spatial arguments.</p></li>
</ul>
<p>And there are probably many more forms of such direct code vectorization. As
explained before, this kind of vectorization is one of the most simple even
though we’ve seen it can be really tricky to implement and requires some
experience, some help or both. For example, the solution to the boids exercise
was provided by <a class="reference external" href="http://stackoverflow.com/users/3293881/divakar">Divakar</a> on
<a class="reference external" href="http://stackoverflow.com/questions/40822983/multiple-individual-2d-rotation-at-once">stack overflow</a> after having explained my problem.</p>
</div>
</div>
<div class="section" id="problem-vectorization">
<h2><a class="toc-backref" href="#id67">Problem vectorization</a><a class="headerlink" href="#problem-vectorization" title="Permalink to this headline">¶</a></h2>
<div class="contents local topic" id="id20">
<p class="topic-title"><strong>Contents</strong></p>
<ul class="simple">
<li><p><a class="reference internal" href="#id21" id="id113">Introduction</a></p></li>
<li><p><a class="reference internal" href="#path-finding" id="id114">Path finding</a></p>
<ul>
<li><p><a class="reference internal" href="#building-a-maze" id="id115">Building a maze</a></p></li>
<li><p><a class="reference internal" href="#breadth-first" id="id116">Breadth-first</a></p></li>
<li><p><a class="reference internal" href="#bellman-ford-method" id="id117">Bellman-Ford method</a></p></li>
<li><p><a class="reference internal" href="#id22" id="id118">Sources</a></p></li>
<li><p><a class="reference internal" href="#id23" id="id119">References</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#fluid-dynamics" id="id120">Fluid Dynamics</a></p>
<ul>
<li><p><a class="reference internal" href="#lagrangian-vs-eulerian-method" id="id121">Lagrangian vs Eulerian method</a></p></li>
<li><p><a class="reference internal" href="#id24" id="id122">NumPy implementation</a></p></li>
<li><p><a class="reference internal" href="#id25" id="id123">Sources</a></p></li>
<li><p><a class="reference internal" href="#id26" id="id124">References</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#blue-noise-sampling" id="id125">Blue noise sampling</a></p>
<ul>
<li><p><a class="reference internal" href="#dart-method" id="id126">DART method</a></p></li>
<li><p><a class="reference internal" href="#bridson-method" id="id127">Bridson method</a></p></li>
<li><p><a class="reference internal" href="#id27" id="id128">Sources</a></p></li>
<li><p><a class="reference internal" href="#id28" id="id129">References</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#id29" id="id130">Conclusion</a></p></li>
</ul>
</div>
<div class="section" id="id21">
<h3><a class="toc-backref" href="#id113">Introduction</a><a class="headerlink" href="#id21" title="Permalink to this headline">¶</a></h3>
<p>Problem vectorization is much harder than code vectorization because it means
that you fundamentally have to rethink your problem in order to make it
vectorizable. Most of the time this means you have to use a different algorithm
to solve your problem or even worse… to invent a new one. The difficulty is thus
to think out-of-the-box.</p>
<p>To illustrate this, let’s consider a simple problem where given two vectors <code class="code docutils literal notranslate"><span class="pre">X</span></code> and
<code class="code docutils literal notranslate"><span class="pre">Y</span></code>, we want to compute the sum of <code class="code docutils literal notranslate"><span class="pre">X[i]*Y[j]</span></code> for all pairs of indices <code class="code docutils literal notranslate"><span class="pre">i</span></code>,
<code class="code docutils literal notranslate"><span class="pre">j</span></code>. One simple and obvious solution is to write:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">compute_python</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">):</span>
    <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Y</span><span class="p">)):</span>
            <span class="n">result</span> <span class="o">+=</span> <span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">Y</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">result</span>
</pre></div>
</div>
<p>However, this first and naïve implementation requires two loops and we already
know it will be slow:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">timeit</span><span class="p">(</span><span class="s2">&quot;compute_python(X,X)&quot;</span><span class="p">)</span>
<span class="go">1 loops, best of 3: 0.274481 sec per loop</span>
</pre></div>
</div>
<p>How to vectorize the problem then? If you remember your linear algebra course,
you may have identified the expression <code class="code docutils literal notranslate"><span class="pre">X[i]</span> <span class="pre">*</span> <span class="pre">Y[j]</span></code> to be very similar to a
matrix product expression. So maybe we could benefit from some NumPy
speedup. One wrong solution would be to write:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">compute_numpy_wrong</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">X</span><span class="o">*</span><span class="n">Y</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</pre></div>
</div>
<p>This is wrong because the <code class="code docutils literal notranslate"><span class="pre">X*Y</span></code> expression will actually compute a new vector
<code class="code docutils literal notranslate"><span class="pre">Z</span></code> such that <code class="code docutils literal notranslate"><span class="pre">Z[i]</span> <span class="pre">=</span> <span class="pre">X[i]</span> <span class="pre">*</span> <span class="pre">Y[i]</span></code> and this is not what we want. Instead, we
can exploit NumPy broadcasting by first reshaping the two vectors and then
multiply them:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">compute_numpy</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">):</span>
    <span class="n">Z</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">),</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">Y</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">Y</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">Z</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</pre></div>
</div>
<p>Here we have <code class="code docutils literal notranslate"><span class="pre">Z[i,j]</span> <span class="pre">==</span> <span class="pre">X[i,0]*Y[0,j]</span></code> and if we take the sum over each elements of
<code class="code docutils literal notranslate"><span class="pre">Z</span></code>, we get the expected result. Let’s see how much speedup we gain in the
process:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">timeit</span><span class="p">(</span><span class="s2">&quot;compute_numpy(X,X)&quot;</span><span class="p">)</span>
<span class="go">10 loops, best of 3: 0.00157926 sec per loop</span>
</pre></div>
</div>
<p>This is better, we gained a factor of ~150. But we can do much better.</p>
<p>If you look again and more closely at the pure Python version, you can see that
the inner loop is using <code class="code docutils literal notranslate"><span class="pre">X[i]</span></code> that does not depend on the <code class="code docutils literal notranslate"><span class="pre">j</span></code> index, meaning
it can be removed from the inner loop. Code can be rewritten as:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">compute_numpy_better_1</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">):</span>
    <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)):</span>
        <span class="n">Ysum</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Y</span><span class="p">)):</span>
            <span class="n">Ysum</span> <span class="o">+=</span> <span class="n">Y</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
        <span class="n">result</span> <span class="o">+=</span> <span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">Ysum</span>
    <span class="k">return</span> <span class="n">result</span>
</pre></div>
</div>
<p>But since the inner loop does not depend on the <code class="code docutils literal notranslate"><span class="pre">i</span></code> index, we might as well
compute it only once:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">compute_numpy_better_2</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">):</span>
    <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">Ysum</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Y</span><span class="p">)):</span>
        <span class="n">Ysum</span> <span class="o">+=</span> <span class="n">Y</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)):</span>
        <span class="n">result</span> <span class="o">+=</span> <span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">Ysum</span>
    <span class="k">return</span> <span class="n">result</span>
</pre></div>
</div>
<p>Not so bad, we have removed the inner loop, transforming <span class="math notranslate nohighlight">\(O(n^2)\)</span>
complexity into <span class="math notranslate nohighlight">\(O(n)\)</span> complexity. Using the same approach, we can now
write:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">compute_numpy_better_3</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="n">Ysum</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Y</span><span class="p">)):</span>
        <span class="n">Ysum</span> <span class="o">+=</span> <span class="n">Y</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
    <span class="n">Xsum</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)):</span>
        <span class="n">Xsum</span> <span class="o">+=</span> <span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">Xsum</span><span class="o">*</span><span class="n">Ysum</span>
</pre></div>
</div>
<p>Finally, having realized we only need the product of the sum over <code class="code docutils literal notranslate"><span class="pre">X</span></code> and <code class="code docutils literal notranslate"><span class="pre">Y</span></code>
respectively, we can benefit from the <code class="code docutils literal notranslate"><span class="pre">np.sum</span></code> function and write:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">compute_numpy_better</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
<p>It is shorter, clearer and much, much faster:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">timeit</span><span class="p">(</span><span class="s2">&quot;compute_numpy_better(X,X)&quot;</span><span class="p">)</span>
<span class="go">1000 loops, best of 3: 3.97208e-06 sec per loop</span>
</pre></div>
</div>
<p>We have indeed reformulated our problem, taking advantage of the fact that
<span class="math notranslate nohighlight">\(\sum_{ij}{X_i}{Y_j} = \sum_{i}X_i \sum_{j}Y_j$\)</span> and we’ve learned in the
meantime that there are two kinds of vectorization: code vectorization and
problem vectorization. The latter is the most difficult but the most
important because this is where you can expect huge gains in speed. In this
simple example, we gain a factor of 150 with code vectorization but we gained a
factor of 70,000 with problem vectorization, just by writing our problem
differently (even though you cannot expect such a huge speedup in all
situations). However, code vectorization remains an important factor, and if we
rewrite the last solution the Python way, the improvement is good but not as much as
in the NumPy version:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">compute_python_better</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">*</span><span class="nb">sum</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
</pre></div>
</div>
<p>This new Python version is much faster than the previous Python version, but
still, it is 50 times slower than the NumPy version:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">timeit</span><span class="p">(</span><span class="s2">&quot;compute_python_better(X,X)&quot;</span><span class="p">)</span>
<span class="go">1000 loops, best of 3: 0.000155677 sec per loop</span>
</pre></div>
</div>
</div>
<div class="section" id="path-finding">
<h3><a class="toc-backref" href="#id114">Path finding</a><a class="headerlink" href="#path-finding" title="Permalink to this headline">¶</a></h3>
<p>Path finding is all about finding the shortest path in a graph. This can be
split in two distinct problems: to find a path between two nodes in a graph and
to find the shortest path. We’ll illustrate this through path finding in a
maze. The first task is thus to build a maze.</p>
<div class="legend admonition">
<p class="admonition-title"><strong>Figure 5.1</strong></p>
<p>A hedge maze at Longleat stately home in England.
Image by <a class="reference external" href="https://commons.wikimedia.org/wiki/File:Longleat_maze.jpg">Prince Rurik</a>, 2005.</p>
</div>
<a class="bordered reference internal image-reference" href="_images/Longleat-maze-cropped.jpg"><img alt="_images/Longleat-maze-cropped.jpg" class="bordered" src="_images/Longleat-maze-cropped.jpg" style="width: 100%;" /></a>
<div class="section" id="building-a-maze">
<h4><a class="toc-backref" href="#id115">Building a maze</a><a class="headerlink" href="#building-a-maze" title="Permalink to this headline">¶</a></h4>
<p>There exist <a class="reference external" href="https://en.wikipedia.org/wiki/Maze_generation_algorithm">many maze generation algorithms</a> but I tend to
prefer the one I’ve been using for several years but whose origin is unknown to
me. I’ve added the code in the cited wikipedia entry. Feel free to complete it
if you know the original author. This algorithm works by creating <code class="code docutils literal notranslate"><span class="pre">n</span></code> (density)
islands of length <code class="code docutils literal notranslate"><span class="pre">p</span></code> (complexity). An island is created by choosing a random
starting point with odd coordinates, then a random direction is chosen. If the
cell two steps in a given direction is free, then a wall is added at both one step
and two steps in this direction. The process is iterated for <code class="code docutils literal notranslate"><span class="pre">n</span></code> steps for this
island. <code class="code docutils literal notranslate"><span class="pre">p</span></code> islands are created. <code class="code docutils literal notranslate"><span class="pre">n</span></code> and <code class="code docutils literal notranslate"><span class="pre">p</span></code> are expressed as <code class="code docutils literal notranslate"><span class="pre">float</span></code> to adapt them to
the size of the maze. With a low complexity, islands are very small and the
maze is easy to solve. With low density, the maze has more “big empty rooms”.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">build_maze</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">65</span><span class="p">,</span> <span class="mi">65</span><span class="p">),</span> <span class="n">complexity</span><span class="o">=</span><span class="mf">0.75</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="mf">0.50</span><span class="p">):</span>
    <span class="c1"># Only odd shapes</span>
    <span class="n">shape</span> <span class="o">=</span> <span class="p">((</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">//</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">//</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Adjust complexity and density relatively to maze size</span>
    <span class="n">n_complexity</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">complexity</span><span class="o">*</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">n_density</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">density</span><span class="o">*</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

    <span class="c1"># Build actual maze</span>
    <span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>

    <span class="c1"># Fill borders</span>
    <span class="n">Z</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">Z</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">Z</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">Z</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="c1"># Islands starting point with a bias in favor of border</span>
    <span class="n">P</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="p">(</span><span class="n">n_density</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
    <span class="n">P</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="o">+</span><span class="mf">0.5</span><span class="p">))</span>
    <span class="n">P</span> <span class="o">=</span> <span class="p">(</span><span class="n">P</span><span class="o">*</span><span class="p">[</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">P</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">P</span><span class="o">//</span><span class="mi">2</span><span class="p">)</span>

    <span class="c1"># Create islands</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_density</span><span class="p">):</span>
        <span class="c1"># Test for early stop: if all starting point are busy, this means we</span>
        <span class="c1"># won&#39;t be able to connect any island, so we stop.</span>
        <span class="n">T</span> <span class="o">=</span> <span class="n">Z</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">T</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">==</span> <span class="n">T</span><span class="o">.</span><span class="n">size</span><span class="p">:</span> <span class="k">break</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">P</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">Z</span><span class="p">[</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_complexity</span><span class="p">):</span>
            <span class="n">neighbours</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>          <span class="n">neighbours</span><span class="o">.</span><span class="n">append</span><span class="p">([(</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="o">-</span><span class="mi">2</span><span class="p">)])</span>
            <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span> <span class="n">neighbours</span><span class="o">.</span><span class="n">append</span><span class="p">([(</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="o">+</span><span class="mi">2</span><span class="p">)])</span>
            <span class="k">if</span> <span class="n">y</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>          <span class="n">neighbours</span><span class="o">.</span><span class="n">append</span><span class="p">([(</span><span class="n">y</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">x</span><span class="p">),</span> <span class="p">(</span><span class="n">y</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="n">x</span><span class="p">)])</span>
            <span class="k">if</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span> <span class="n">neighbours</span><span class="o">.</span><span class="n">append</span><span class="p">([(</span><span class="n">y</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">x</span><span class="p">),</span> <span class="p">(</span><span class="n">y</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="n">x</span><span class="p">)])</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">neighbours</span><span class="p">):</span>
                <span class="n">choice</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">neighbours</span><span class="p">))</span>
                <span class="n">next_1</span><span class="p">,</span> <span class="n">next_2</span> <span class="o">=</span> <span class="n">neighbours</span><span class="p">[</span><span class="n">choice</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">Z</span><span class="p">[</span><span class="n">next_2</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">Z</span><span class="p">[</span><span class="n">next_1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="n">Z</span><span class="p">[</span><span class="n">next_2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="n">y</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="n">next_2</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">break</span>
    <span class="k">return</span> <span class="n">Z</span>
</pre></div>
</div>
<p>Here is an animation showing the generation process.</p>
<div class="legend admonition">
<p class="admonition-title"><strong>Figure 5.2</strong></p>
<p>Progressive maze building with complexity and density control.</p>
</div>
<video width="100%" controls>
<source src="data/maze-build.mp4" type="video/mp4">
Your browser does not support the video tag. </video></div>
<div class="section" id="breadth-first">
<h4><a class="toc-backref" href="#id116">Breadth-first</a><a class="headerlink" href="#breadth-first" title="Permalink to this headline">¶</a></h4>
<p>The breadth-first (as well as depth-first) search algorithm addresses the problem
of finding a path between two nodes by examining all possibilities starting
from the root node and stopping as soon as a solution has been found
(destination node has been reached). This algorithm runs in linear time with
complexity in <span class="math notranslate nohighlight">\(O(|V|+|E|)\)</span> (where <span class="math notranslate nohighlight">\(V\)</span> is the number of vertices, and <span class="math notranslate nohighlight">\(E\)</span> is
the number of edges). Writing such an algorithm is not especially difficult,
provided you have the right data structure. In our case, the array
representation of the maze is not the most well-suited and we need to transform
it into an actual graph as proposed by <a class="reference external" href="http://bryukh.com">Valentin Bryukhanov</a>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">build_graph</span><span class="p">(</span><span class="n">maze</span><span class="p">):</span>
    <span class="n">height</span><span class="p">,</span> <span class="n">width</span> <span class="o">=</span> <span class="n">maze</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">graph</span> <span class="o">=</span> <span class="p">{(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">):</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">width</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">height</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">maze</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]}</span>
    <span class="k">for</span> <span class="n">row</span><span class="p">,</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">graph</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">row</span> <span class="o">&lt;</span> <span class="n">height</span> <span class="o">-</span> <span class="mi">1</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">maze</span><span class="p">[</span><span class="n">row</span> <span class="o">+</span> <span class="mi">1</span><span class="p">][</span><span class="n">col</span><span class="p">]:</span>
            <span class="n">graph</span><span class="p">[(</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">)]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;S&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">row</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">col</span><span class="p">)))</span>
            <span class="n">graph</span><span class="p">[(</span><span class="n">row</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">col</span><span class="p">)]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;N&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">)))</span>
        <span class="k">if</span> <span class="n">col</span> <span class="o">&lt;</span> <span class="n">width</span> <span class="o">-</span> <span class="mi">1</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">maze</span><span class="p">[</span><span class="n">row</span><span class="p">][</span><span class="n">col</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]:</span>
            <span class="n">graph</span><span class="p">[(</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">)]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;E&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)))</span>
            <span class="n">graph</span><span class="p">[(</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;W&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">graph</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If we had used the depth-first algorithm, there is no guarantee to find the
shortest path, only to find a path (if it exists).</p>
</div>
<p>Once this is done, writing the breadth-first algorithm is
straightforward. We start from the starting node and we visit nodes at
the current depth only (breadth-first, remember?) and we iterate the
process until reaching the final node, if possible. The question is
then: do we get the shortest path exploring the graph this way? In
this specific case, “yes”, because we don’t have an edge-weighted graph,
i.e. all the edges have the same weight (or cost).</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">breadth_first</span><span class="p">(</span><span class="n">maze</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">goal</span><span class="p">):</span>
    <span class="n">queue</span> <span class="o">=</span> <span class="n">deque</span><span class="p">([([</span><span class="n">start</span><span class="p">],</span> <span class="n">start</span><span class="p">)])</span>
    <span class="n">visited</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">graph</span> <span class="o">=</span> <span class="n">build_graph</span><span class="p">(</span><span class="n">maze</span><span class="p">)</span>

    <span class="k">while</span> <span class="n">queue</span><span class="p">:</span>
        <span class="n">path</span><span class="p">,</span> <span class="n">current</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="n">popleft</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">current</span> <span class="o">==</span> <span class="n">goal</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">current</span> <span class="ow">in</span> <span class="n">visited</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">visited</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">current</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">direction</span><span class="p">,</span> <span class="n">neighbour</span> <span class="ow">in</span> <span class="n">graph</span><span class="p">[</span><span class="n">current</span><span class="p">]:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="n">p</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">neighbour</span><span class="p">)</span>
            <span class="n">queue</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">p</span><span class="p">,</span> <span class="n">neighbour</span><span class="p">))</span>
    <span class="k">return</span> <span class="kc">None</span>
</pre></div>
</div>
</div>
<div class="section" id="bellman-ford-method">
<h4><a class="toc-backref" href="#id117">Bellman-Ford method</a><a class="headerlink" href="#bellman-ford-method" title="Permalink to this headline">¶</a></h4>
<p>The Bellman–Ford algorithm is an algorithm that is able to find the optimal
path in a graph using a diffusion process. The optimal path is found by ascending
the resulting gradient. This algorithm runs in quadratic time <span class="math notranslate nohighlight">\(O(|V||E|)\)</span>
(where <span class="math notranslate nohighlight">\(V\)</span> is the number of vertices, and <span class="math notranslate nohighlight">\(E\)</span> is the number of edges). However, in
our simple case, we won’t hit the worst case scenario. The algorithm is
illustrated below (reading from left to right, top to bottom). Once this is
done, we can ascend the gradient from the starting node. You can check on the
figure that this leads to the shortest path.</p>
<div class="legend admonition">
<p class="admonition-title"><strong>Figure 5.3</strong></p>
<p>Value iteration algorithm on a simple maze. Once entrance has been reached,
it is easy to find the shortest path by ascending the value gradient.</p>
</div>
<a class="reference internal image-reference" href="_images/value-iteration-1.png"><img alt="_images/value-iteration-1.png" src="_images/value-iteration-1.png" style="width: 19%;" /></a>
<a class="reference internal image-reference" href="_images/value-iteration-2.png"><img alt="_images/value-iteration-2.png" src="_images/value-iteration-2.png" style="width: 19%;" /></a>
<a class="reference internal image-reference" href="_images/value-iteration-3.png"><img alt="_images/value-iteration-3.png" src="_images/value-iteration-3.png" style="width: 19%;" /></a>
<a class="reference internal image-reference" href="_images/value-iteration-4.png"><img alt="_images/value-iteration-4.png" src="_images/value-iteration-4.png" style="width: 19%;" /></a>
<a class="reference internal image-reference" href="_images/value-iteration-5.png"><img alt="_images/value-iteration-5.png" src="_images/value-iteration-5.png" style="width: 19%;" /></a>
<a class="reference internal image-reference" href="_images/value-iteration-6.png"><img alt="_images/value-iteration-6.png" src="_images/value-iteration-6.png" style="width: 19%;" /></a>
<a class="reference internal image-reference" href="_images/value-iteration-7.png"><img alt="_images/value-iteration-7.png" src="_images/value-iteration-7.png" style="width: 19%;" /></a>
<a class="reference internal image-reference" href="_images/value-iteration-8.png"><img alt="_images/value-iteration-8.png" src="_images/value-iteration-8.png" style="width: 19%;" /></a>
<a class="reference internal image-reference" href="_images/value-iteration-9.png"><img alt="_images/value-iteration-9.png" src="_images/value-iteration-9.png" style="width: 19%;" /></a>
<a class="reference internal image-reference" href="_images/value-iteration-10.png"><img alt="_images/value-iteration-10.png" src="_images/value-iteration-10.png" style="width: 19%;" /></a>
<p>We start by setting the exit node to the value 1, while every other node is
set to 0, except the walls. Then we iterate a process such that each
cell’s new value is computed as the maximum value between the current cell value
and the discounted (<code class="code docutils literal notranslate"><span class="pre">gamma=0.9</span></code> in the case below) 4 neighbour values. The
process starts as soon as the starting node value becomes strictly positive.</p>
<p>The NumPy implementation is straightforward if we take advantage of the
<code class="code docutils literal notranslate"><span class="pre">generic_filter</span></code> (from <code class="code docutils literal notranslate"><span class="pre">scipy.ndimage</span></code>) for the diffusion process:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">diffuse</span><span class="p">(</span><span class="n">Z</span><span class="p">):</span>
    <span class="c1"># North, West, Center, East, South</span>
    <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="n">gamma</span><span class="o">*</span><span class="n">Z</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">gamma</span><span class="o">*</span><span class="n">Z</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">Z</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">gamma</span><span class="o">*</span><span class="n">Z</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">gamma</span><span class="o">*</span><span class="n">Z</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>

<span class="c1"># Build gradient array</span>
<span class="n">G</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">Z</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="c1"># Initialize gradient at the entrance with value 1</span>
<span class="n">G</span><span class="p">[</span><span class="n">start</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

<span class="c1"># Discount factor</span>
<span class="n">gamma</span> <span class="o">=</span> <span class="mf">0.99</span>

<span class="c1"># We iterate until value at exit is &gt; 0. This requires the maze</span>
<span class="c1"># to have a solution or it will be stuck in the loop.</span>
<span class="k">while</span> <span class="n">G</span><span class="p">[</span><span class="n">goal</span><span class="p">]</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>
    <span class="n">G</span> <span class="o">=</span> <span class="n">Z</span> <span class="o">*</span> <span class="n">generic_filter</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">diffuse</span><span class="p">,</span> <span class="n">footprint</span><span class="o">=</span><span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                                                  <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                                                  <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]])</span>
</pre></div>
</div>
<p>But in this specific case, it is rather slow. We’d better cook-up our own
solution, reusing part of the game of life code:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Build gradient array</span>
<span class="n">G</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">Z</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="c1"># Initialize gradient at the entrance with value 1</span>
<span class="n">G</span><span class="p">[</span><span class="n">start</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

<span class="c1"># Discount factor</span>
<span class="n">gamma</span> <span class="o">=</span> <span class="mf">0.99</span>

<span class="c1"># We iterate until value at exit is &gt; 0. This requires the maze</span>
<span class="c1"># to have a solution or it will be stuck in the loop.</span>
<span class="n">G_gamma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty_like</span><span class="p">(</span><span class="n">G</span><span class="p">)</span>
<span class="k">while</span> <span class="n">G</span><span class="p">[</span><span class="n">goal</span><span class="p">]</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>
    <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">gamma</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">G_gamma</span><span class="p">)</span>
    <span class="n">N</span> <span class="o">=</span> <span class="n">G_gamma</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">W</span> <span class="o">=</span> <span class="n">G_gamma</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">C</span> <span class="o">=</span> <span class="n">G</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">E</span> <span class="o">=</span> <span class="n">G_gamma</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">:]</span>
    <span class="n">S</span> <span class="o">=</span> <span class="n">G_gamma</span><span class="p">[</span><span class="mi">2</span><span class="p">:,</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">G</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">Z</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">N</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">W</span><span class="p">,</span>
                                <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">C</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">E</span><span class="p">,</span><span class="n">S</span><span class="p">))))</span>
</pre></div>
</div>
<p>Once this is done, we can ascend the gradient to find the shortest path as
illustrated on the figure below:</p>
<div class="legend admonition">
<p class="admonition-title"><strong>Figure 5.4</strong></p>
<p>Path finding using the Bellman-Ford algorithm. Gradient colors indicate
propagated values from the end-point of the maze (bottom-right). Path is
found by ascending gradient from the goal.</p>
</div>
<a class="reference internal image-reference" href="_images/maze.png"><img alt="_images/maze.png" src="_images/maze.png" style="width: 100%;" /></a>
</div>
<div class="section" id="id22">
<h4><a class="toc-backref" href="#id118">Sources</a><a class="headerlink" href="#id22" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li><p><a class="reference external" href="code/maze_build.py">maze_build.py</a></p></li>
<li><p><a class="reference external" href="code/maze_numpy.py">maze_numpy.py</a></p></li>
</ul>
</div>
<div class="section" id="id23">
<h4><a class="toc-backref" href="#id119">References</a><a class="headerlink" href="#id23" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li><p><a class="reference external" href="http://bryukh.com/labyrinth-algorithms/">Labyrinth Algorithms</a>, Valentin
Bryukhanov, 2014.</p></li>
</ul>
</div>
</div>
<div class="section" id="fluid-dynamics">
<h3><a class="toc-backref" href="#id120">Fluid Dynamics</a><a class="headerlink" href="#fluid-dynamics" title="Permalink to this headline">¶</a></h3>
<div class="legend admonition">
<p class="admonition-title"><strong>Figure 5.5</strong></p>
<p>Hydrodynamic flow at two different zoom levels, Neckar river, Heidelberg,
Germany. Image by <a class="reference external" href="https://commons.wikimedia.org/wiki/File:Self_Similar_Turbulence.png">Steven Mathey</a>, 2012.</p>
</div>
<a class="reference internal image-reference" href="_images/Self-similar-turbulence.png"><img alt="_images/Self-similar-turbulence.png" src="_images/Self-similar-turbulence.png" style="width: 100%;" /></a>
<div class="section" id="lagrangian-vs-eulerian-method">
<h4><a class="toc-backref" href="#id121">Lagrangian vs Eulerian method</a><a class="headerlink" href="#lagrangian-vs-eulerian-method" title="Permalink to this headline">¶</a></h4>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Excerpt from the Wikipedia entry on the
<a class="reference external" href="https://en.wikipedia.org/wiki/Lagrangian_and_Eulerian_specification_of_the_flow_field">Lagrangian and Eulerian specification</a></p>
</div>
<p>In classical field theory, the Lagrangian specification of the field is a way of
looking at fluid motion where the observer follows an individual fluid parcel
as it moves through space and time. Plotting the position of an individual
parcel through time gives the pathline of the parcel. This can be visualized as
sitting in a boat and drifting down a river.</p>
<p>The Eulerian specification of the flow field is a way of looking at fluid
motion that focuses on specific locations in the space through which the fluid
flows as time passes. This can be visualized by sitting on the bank of a river
and watching the water pass the fixed location.</p>
<p>In other words, in the Eulerian case, you divide a portion of space into cells
and each cell contains a velocity vector and other information, such as density
and temperature. In the Lagrangian case, we need particle-based physics with
dynamic interactions and generally we need a high number of particles. Both
methods have advantages and disadvantages and the choice between the two
methods depends on the nature of your problem. Of course, you can also mix the
two methods into a hybrid method.</p>
<p>However, the biggest problem for particle-based simulation is that particle
interaction requires finding neighbouring particles and this has a cost as
we’ve seen in the boids case. If we target Python and NumPy only, it is probably
better to choose the Eulerian method since vectorization will be almost trivial
compared to the Lagrangian method.</p>
</div>
<div class="section" id="id24">
<h4><a class="toc-backref" href="#id122">NumPy implementation</a><a class="headerlink" href="#id24" title="Permalink to this headline">¶</a></h4>
<p>I won’t explain all the theory behind computational fluid dynamics because
first, I cannot (I’m not an expert at all in this domain) and there are many
resources online that explain this nicely (have a look at references below,
especially tutorial by L. Barba). Why choose a computational fluid as an example
then? Because results are (almost) always beautiful and fascinating. I couldn’t
resist (look at the movie below).</p>
<p>We’ll further simplify the problem by implementing a method from computer
graphics where the goal is not correctness but convincing behavior. Jos Stam
wrote a very nice article for SIGGRAPH 1999 describing a technique to have
stable fluids over time (i.e. whose solution in the long term does not
diverge). <a class="reference external" href="https://github.com/albertosantini/python-fluid">Alberto Santini</a>
wrote a Python replication a long time ago (using numarray!) such that I only
had to adapt it to modern NumPy and accelerate it a bit using modern NumPy
tricks.</p>
<p>I won’t comment the code since it would be too long, but you can read the
original paper as well as the explanation by <a class="reference external" href="http://prideout.net/blog/?p=58">Philip Rideout</a> on his blog. Below are some movies I’ve made
using this technique.</p>
<div class="legend admonition">
<p class="admonition-title"><strong>Figure 5.6</strong></p>
<p>Smoke simulation using the stable fluids algorithm by Jos Stam.  Right most
video comes from the <a class="reference external" href="http://glumpy.github.io">glumpy</a> package and is
using the GPU (framebuffer operations, i.e. no OpenCL nor CUDA) for faster
computations.</p>
</div>
<video width="33%" controls>
<source src="data/smoke-1.mp4" type="video/mp4">
Your browser does not support the video tag. </video>

<video width="33%" controls>
<source src="data/smoke-2.mp4" type="video/mp4">
Your browser does not support the video tag. </video>

<video width="33%" controls>
<source src="data/smoke-gpu.mp4" type="video/mp4">
Your browser does not support the video tag. </video></div>
<div class="section" id="id25">
<h4><a class="toc-backref" href="#id123">Sources</a><a class="headerlink" href="#id25" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li><p><a class="reference external" href="code/smoke_1.py">smoke_1.py</a></p></li>
<li><p><a class="reference external" href="code/smoke_2.py">smoke_2.py</a></p></li>
<li><p><a class="reference external" href="code/smoke_solver.py">smoke_solver.py</a></p></li>
<li><p><a class="reference external" href="code/smoke_interactive.py">smoke_interactive.py</a></p></li>
</ul>
</div>
<div class="section" id="id26">
<h4><a class="toc-backref" href="#id124">References</a><a class="headerlink" href="#id26" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li><p><a class="reference external" href="https://github.com/barbagroup/CFDPython">12 Steps to Navier-Stokes</a>, Lorena Barba, 2013.</p></li>
<li><p><a class="reference external" href="http://www.dgp.toronto.edu/people/stam/reality/Research/pdf/ns.pdf">Stable Fluids</a>, Jos Stam, 1999.</p></li>
<li><p><a class="reference external" href="http://prideout.net/blog/?p=58">Simple Fluid Simulation</a>, Philip Rideout, 2010</p></li>
<li><p><a class="reference external" href="http://http.developer.nvidia.com/GPUGems/gpugems_ch38.html">Fast Fluid Dynamics Simulation on the GPU</a>, Mark Harris, 2004.</p></li>
<li><p><a class="reference external" href="https://www.cs.ubc.ca/%7Erbridson/docs/zhu-siggraph05-sandfluid.pdf">Animating Sand as a Fluid</a>, Yongning Zhu &amp; Robert Bridson, 2005.</p></li>
</ul>
</div>
</div>
<div class="section" id="blue-noise-sampling">
<h3><a class="toc-backref" href="#id125">Blue noise sampling</a><a class="headerlink" href="#blue-noise-sampling" title="Permalink to this headline">¶</a></h3>
<p>Blue noise refers to sample sets that have random and yet uniform distributions
with absence of any spectral bias. Such noise is very useful in a variety of
graphics applications like rendering, dithering, stippling, etc. Many different
methods have been proposed to achieve such noise, but the most simple is certainly
the DART method.</p>
<div class="legend admonition">
<p class="admonition-title"><strong>Figure 5.7</strong></p>
<p>Detail of “The Starry Night”, Vincent van Gogh, 1889. The detail has been
resampled using voronoi cells whose centers are a blue noise sample.</p>
</div>
<a class="bordered reference internal image-reference" href="_images/mosaic.png"><img alt="_images/mosaic.png" class="bordered" src="_images/mosaic.png" style="width: 100%;" /></a>
<div class="section" id="dart-method">
<h4><a class="toc-backref" href="#id126">DART method</a><a class="headerlink" href="#dart-method" title="Permalink to this headline">¶</a></h4>
<p>The DART method is one of the earliest and simplest methods. It works by
sequentially drawing uniform random points and only accepting those that lie at a
minimum distance from every previous accepted sample. This sequential method is
therefore extremely slow because each new candidate needs to be tested against
previous accepted candidates. The more points you accept, the slower the
method is. Let’s consider the unit surface and a minimum radius <code class="code docutils literal notranslate"><span class="pre">r</span></code> to be enforced
between each point.</p>
<p>Knowing that the densest packing of circles in the plane is the hexagonal
lattice of the bee’s honeycomb, we know this density is <span class="math notranslate nohighlight">\(d =
\frac{1}{6}\pi\sqrt{3}\)</span> (in fact <a class="reference external" href="https://en.wikipedia.org/wiki/Circle_packing">I learned it</a> while writing this book).
Considering circles with radius <span class="math notranslate nohighlight">\(r\)</span>, we can pack at most <span class="math notranslate nohighlight">\(\frac{d}{\pi r^2}
= \frac{\sqrt{3}}{6r^2} = \frac{1}{2r^2\sqrt{3}}\)</span>. We know the theoretical
upper limit for the number of discs we can pack onto the surface, but we’ll
likely not reach this upper limit because of random placements. Furthermore,
because a lot of points will be rejected after a few have been accepted, we
need to set a limit on the number of successive failed trials before we stop
the whole process.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">random</span>

<span class="k">def</span> <span class="nf">DART_sampling</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">r</span> <span class="o">=</span> <span class="mf">0.025</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">distance</span><span class="p">(</span><span class="n">p0</span><span class="p">,</span> <span class="n">p1</span><span class="p">):</span>
        <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span> <span class="o">=</span> <span class="n">p0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">p1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">p0</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">p1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">math</span><span class="o">.</span><span class="n">hypot</span><span class="p">(</span><span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">)</span>

    <span class="n">points</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">last_success</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">width</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">height</span><span class="p">)</span>
        <span class="n">accept</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">points</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">distance</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span> <span class="o">&lt;</span> <span class="n">r</span><span class="p">:</span>
                <span class="n">accept</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="n">accept</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">points</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">i</span><span class="o">-</span><span class="n">last_success</span> <span class="o">&gt;</span> <span class="n">k</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">last_success</span> <span class="o">=</span> <span class="n">i</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">points</span>
</pre></div>
</div>
<p>I left as an exercise the vectorization of the DART method. The idea is to
pre-compute enough uniform random samples as well as paired distances and to
test for their sequential inclusion.</p>
</div>
<div class="section" id="bridson-method">
<h4><a class="toc-backref" href="#id127">Bridson method</a><a class="headerlink" href="#bridson-method" title="Permalink to this headline">¶</a></h4>
<p>If the vectorization of the previous method poses no real difficulty, the speed
improvement is not so good and the quality remains low and dependent on the <code class="code docutils literal notranslate"><span class="pre">k</span></code>
parameter. The higher, the better since it basically governs how hard to try to
insert a new sample. But, when there is already a large number of accepted
samples, only chance allows us to find a position to insert a new sample. We
could increase the <code class="code docutils literal notranslate"><span class="pre">k</span></code> value but this would make the method even slower
without any guarantee in quality. It’s time to think out-of-the-box and luckily
enough, Robert Bridson did that for us and proposed a simple yet efficient
method:</p>
<blockquote>
<div><p><strong>Step 0</strong>. Initialize an n-dimensional background grid for storing samples and
accelerating spatial searches. We pick the cell size to be bounded by
<span class="math notranslate nohighlight">\(\frac{r}{\sqrt{n}}\)</span>, so that each grid cell will contain at most one
sample, and thus the grid can be implemented as a simple n-dimensional array of
integers: the default −1 indicates no sample, a non-negative integer gives the
index of the sample located in a cell.</p>
<p><strong>Step 1</strong>. Select the initial sample, <span class="math notranslate nohighlight">\(x_0\)</span>, randomly chosen uniformly from the
domain. Insert it into the background grid, and initialize the “active list”
(an array of sample indices) with this index (zero).</p>
<p><strong>Step 2</strong>. While the active list is not empty, choose a random index from
it (say <span class="math notranslate nohighlight">\(i\)</span>). Generate up to <span class="math notranslate nohighlight">\(k\)</span> points chosen uniformly from the
spherical annulus between radius <span class="math notranslate nohighlight">\(r\)</span> and <span class="math notranslate nohighlight">\(2r\)</span> around
<span class="math notranslate nohighlight">\(x_i\)</span>. For each point in turn, check if it is within distance <span class="math notranslate nohighlight">\(r\)</span>
of existing samples (using the background grid to only test nearby
samples). If a point is adequately far from existing samples, emit it as the
next sample and add it to the active list. If after <span class="math notranslate nohighlight">\(k\)</span> attempts no
such point is found, instead remove <span class="math notranslate nohighlight">\(i\)</span> from the active list.</p>
</div></blockquote>
<p>Implementation poses no real problem and is left as an exercise for the
reader. Note that not only is this method fast, but it also offers a better
quality (more samples) than the DART method even with a high <span class="math notranslate nohighlight">\(k\)</span>
parameter.</p>
<div class="legend admonition">
<p class="admonition-title"><strong>Figure 5.8</strong></p>
<p>Comparison of uniform, grid-jittered and Bridson sampling.</p>
</div>
<a class="reference internal image-reference" href="_images/sampling.png"><img alt="_images/sampling.png" src="_images/sampling.png" style="width: 100%;" /></a>
</div>
<div class="section" id="id27">
<h4><a class="toc-backref" href="#id128">Sources</a><a class="headerlink" href="#id27" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li><p><a class="reference external" href="code/DART_sampling_python.py">DART_sampling_python.py</a></p></li>
<li><p><a class="reference external" href="code/DART_sampling_numpy.py">DART_sampling_numpy.py</a> (solution to the exercise)</p></li>
<li><p><a class="reference external" href="code/Bridson_sampling.py">Bridson_sampling.py</a> (solution to the exercise)</p></li>
<li><p><a class="reference external" href="code/sampling.py">sampling.py</a></p></li>
<li><p><a class="reference external" href="code/mosaic.py">mosaic.py</a></p></li>
<li><p><a class="reference external" href="code/voronoi.py">voronoi.py</a></p></li>
</ul>
</div>
<div class="section" id="id28">
<h4><a class="toc-backref" href="#id129">References</a><a class="headerlink" href="#id28" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li><p><a class="reference external" href="https://bost.ocks.org/mike/algorithms/">Visualizing Algorithms</a>
Mike Bostock, 2014.</p></li>
<li><p><a class="reference external" href="http://www.joesfer.com/?p=108">Stippling and Blue Noise</a>
Jose Esteve, 2012.</p></li>
<li><p><a class="reference external" href="http://devmag.org.za/2009/05/03/poisson-disk-sampling/">Poisson Disk Sampling</a>
Herman Tulleken, 2009.</p></li>
<li><p><a class="reference external" href="http://www.cs.ubc.ca/~rbridson/docs/bridson-siggraph07-poissondisk.pdf">Fast Poisson Disk Sampling in Arbitrary Dimensions</a>,
Robert Bridson, SIGGRAPH, 2007.</p></li>
</ul>
</div>
</div>
<div class="section" id="id29">
<h3><a class="toc-backref" href="#id130">Conclusion</a><a class="headerlink" href="#id29" title="Permalink to this headline">¶</a></h3>
<p>The last example we’ve been studying is indeed a nice example where it is more
important to vectorize the problem rather than to vectorize the code (and too
early). In this specific case we were lucky enough to have the work done for us
but it won’t be always the case and in such a case, the temptation might be
high to vectorize the first solution we’ve found. I hope you’re now convinced
it might be a good idea in general to look for alternative solutions once
you’ve found one. You’ll (almost) always improve speed by vectorizing your
code, but in the process, you may miss huge improvements.</p>
</div>
</div>
<div class="section" id="custom-vectorization">
<h2><a class="toc-backref" href="#id68">Custom vectorization</a><a class="headerlink" href="#custom-vectorization" title="Permalink to this headline">¶</a></h2>
<div class="contents local topic" id="id30">
<p class="topic-title"><strong>Contents</strong></p>
<ul class="simple">
<li><p><a class="reference internal" href="#id31" id="id131">Introduction</a></p></li>
<li><p><a class="reference internal" href="#typed-list" id="id132">Typed list</a></p>
<ul>
<li><p><a class="reference internal" href="#creation" id="id133">Creation</a></p></li>
<li><p><a class="reference internal" href="#access" id="id134">Access</a></p></li>
<li><p><a class="reference internal" href="#id33" id="id135">Exercise</a></p></li>
<li><p><a class="reference internal" href="#id34" id="id136">Sources</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#memory-aware-array" id="id137">Memory aware array</a></p>
<ul>
<li><p><a class="reference internal" href="#id35" id="id138">Glumpy</a></p></li>
<li><p><a class="reference internal" href="#array-subclass" id="id139">Array subclass</a></p></li>
<li><p><a class="reference internal" href="#computing-extents" id="id140">Computing extents</a></p></li>
<li><p><a class="reference internal" href="#keeping-track-of-pending-data" id="id141">Keeping track of pending data</a></p></li>
<li><p><a class="reference internal" href="#id37" id="id142">Sources</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#id38" id="id143">Conclusion</a></p></li>
</ul>
</div>
<div class="section" id="id31">
<h3><a class="toc-backref" href="#id131">Introduction</a><a class="headerlink" href="#id31" title="Permalink to this headline">¶</a></h3>
<p>One of the strengths of NumPy is that it can be used to build new objects or to
<a class="reference external" href="https://docs.scipy.org/doc/numpy/user/basics.subclassing.html">subclass the ndarray</a> object. This
later process is a bit tedious but it is worth the effort because it allows you
to improve the <code class="code docutils literal notranslate"><span class="pre">ndarray</span></code> object to suit your problem. We’ll examine in
the following section two real-world cases (typed list and memory-aware array)
that are extensively used in the <a class="reference external" href="http://glumpy.github.io">glumpy</a> project
(that I maintain) while the last one (double precision array) is a more
academic case.</p>
</div>
<div class="section" id="typed-list">
<h3><a class="toc-backref" href="#id132">Typed list</a><a class="headerlink" href="#typed-list" title="Permalink to this headline">¶</a></h3>
<p>Typed list (also known as ragged array) is a list of items that all have the
same data type (in the sense of NumPy). They offer both the list and the
ndarray API (with some restriction of course) but because their respective APIs may not be
compatible in some cases, we have to make choices. For example, concerning
the <code class="code docutils literal notranslate"><span class="pre">+</span></code> operator, we’ll choose to use the NumPy API where the value is added to
each individual item instead of expanding the list by appending a new item
(<code class="code docutils literal notranslate"><span class="pre">1</span></code>).</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">l</span> <span class="o">=</span> <span class="n">TypedList</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mi">3</span><span class="p">]])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
<span class="go">[1, 2], [3]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">l</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
<span class="go">[2, 3], [4]</span>
</pre></div>
</div>
<p>From the list API, we want our new object to offer the possibility of inserting,
appending and removing items seamlessly.</p>
<div class="section" id="creation">
<h4><a class="toc-backref" href="#id133">Creation</a><a class="headerlink" href="#creation" title="Permalink to this headline">¶</a></h4>
<p>Since the object is dynamic by definition, it is important to offer a
general-purpose creation method powerful enough to avoid having to do later
manipulations. Such manipulations, for example insertion/deletion, cost
a lot of operations and we want to avoid them. Here is a proposal (among
others) for the creation of a <code class="code docutils literal notranslate"><span class="pre">TypedList</span></code> object.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sizes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>

<span class="sd">    data : array_like</span>
<span class="sd">        An array, any object exposing the array interface, an object</span>
<span class="sd">        whose __array__ method returns an array, or any (nested) sequence.</span>

<span class="sd">    sizes:  int or 1-D array</span>
<span class="sd">        If `itemsize` is an integer, N, the array will be divided</span>
<span class="sd">        into elements of size N. If such partition is not possible,</span>
<span class="sd">        an error is raised.</span>

<span class="sd">        If `itemsize` is a 1-D array, the array will be divided into</span>
<span class="sd">        elements whose successive sizes will be picked from itemsize.</span>
<span class="sd">        If the sum of itemsize values is different from array size,</span>
<span class="sd">        an error is raised.</span>

<span class="sd">    dtype: np.dtype</span>
<span class="sd">        Any object that can be interpreted as a NumPy data type.</span>
<span class="sd">    &quot;&quot;&quot;</span>
</pre></div>
</div>
<p>This API allows creating an empty list or creating a list from some external
data. Note that in the latter case, we need to specify how to partition the
data into several items or they will split into 1-size items. It can be a regular
partition (i.e. each item is 2 data long) or a custom one (i.e. data must be
split in items of size 1, 2, 3 and 4 items).</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">L</span> <span class="o">=</span> <span class="n">TypedList</span><span class="p">([[</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">],</span> <span class="p">[</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">]])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">L</span><span class="p">)</span>
<span class="go">[ [0] [1 2] [3 4 5] [6 7 8] ]</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">L</span> <span class="o">=</span> <span class="n">TypedList</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">])</span>
<span class="go">[ [0] [1 2] [3 4 5] [6 7 8] ]</span>
</pre></div>
</div>
<p>At this point, the question is whether to subclass the <code class="code docutils literal notranslate"><span class="pre">ndarray</span></code> class or to use
an internal <code class="code docutils literal notranslate"><span class="pre">ndarray</span></code> to store our data. In our specific case, it does not really make
sense to subclass <code class="code docutils literal notranslate"><span class="pre">ndarray</span></code> because we don’t really want to offer the
<code class="code docutils literal notranslate"><span class="pre">ndarray</span></code> interface. Instead, we’ll use an <code class="code docutils literal notranslate"><span class="pre">ndarray</span></code> for storing the list data and
this design choice will offer us more flexibility.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>╌╌╌╌┬───┐┌───┬───┐┌───┬───┬───┐┌───┬───┬───┬───┬╌╌╌╌╌
    │ 0 ││ 1 │ 2 ││ 3 │ 4 │ 5 ││ 6 │ 7 │ 8 │ 9 │
 ╌╌╌┴───┘└───┴───┘└───┴───┴───┘└───┴───┴───┴───┴╌╌╌╌╌╌
   item 1  item 2    item 3         item 4
</pre></div>
</div>
<p>To store the limit of each item, we’ll use an <code class="code docutils literal notranslate"><span class="pre">items</span></code> array that will take care
of storing the position (start and end) for each item. For the creation of a
list, there are two distinct cases: no data is given or some data is given. The
first case is easy and requires only the creation of the <code class="code docutils literal notranslate"><span class="pre">_data</span></code> and <code class="code docutils literal notranslate"><span class="pre">_items</span></code>
arrays. Note that their size is not <code class="code docutils literal notranslate"><span class="pre">null</span></code> since it would be too costly to resize
the array each time we insert a new item. Instead, it’s better to reserve some
space.</p>
<p><strong>First case.</strong> No data has been given, only dtype.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">512</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
<span class="bp">self</span><span class="o">.</span><span class="n">_items</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">64</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
<span class="bp">self</span><span class="o">.</span><span class="n">_size</span> <span class="o">=</span> <span class="mi">0</span>
<span class="bp">self</span><span class="o">.</span><span class="n">_count</span> <span class="o">=</span> <span class="mi">0</span>
</pre></div>
</div>
<p><strong>Second case.</strong> Some data has been given as well as a list of item sizes (for
other cases, see full code below)</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="bp">self</span><span class="o">.</span><span class="n">_size</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">size</span>
<span class="bp">self</span><span class="o">.</span><span class="n">_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sizes</span><span class="p">)</span>
<span class="n">indices</span> <span class="o">=</span> <span class="n">sizes</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span>
<span class="bp">self</span><span class="o">.</span><span class="n">_items</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">sizes</span><span class="p">),</span><span class="mi">2</span><span class="p">),</span><span class="nb">int</span><span class="p">)</span>
<span class="bp">self</span><span class="o">.</span><span class="n">_items</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">indices</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="bp">self</span><span class="o">.</span><span class="n">_items</span><span class="p">[</span><span class="mi">0</span><span class="p">:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">indices</span>
</pre></div>
</div>
</div>
<div class="section" id="access">
<h4><a class="toc-backref" href="#id134">Access</a><a class="headerlink" href="#access" title="Permalink to this headline">¶</a></h4>
<p>Once this is done, every list method requires only a bit of computation and
playing with the different key when getting, inserting or setting an item. Here is
the code for the <code class="code docutils literal notranslate"><span class="pre">__getitem__</span></code> method. No real difficulty but the possible
negative step:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">key</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">key</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">key</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="s2">&quot;Tuple index out of range&quot;</span><span class="p">)</span>
        <span class="n">dstart</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_items</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">dstop</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_items</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">dstart</span><span class="p">:</span><span class="n">dstop</span><span class="p">]</span>

    <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">slice</span><span class="p">:</span>
        <span class="n">istart</span><span class="p">,</span> <span class="n">istop</span><span class="p">,</span> <span class="n">step</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">indices</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">istart</span> <span class="o">&gt;</span> <span class="n">istop</span><span class="p">:</span>
            <span class="n">istart</span><span class="p">,</span><span class="n">istop</span> <span class="o">=</span> <span class="n">istop</span><span class="p">,</span><span class="n">istart</span>
        <span class="n">dstart</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_items</span><span class="p">[</span><span class="n">istart</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">istart</span> <span class="o">==</span> <span class="n">istop</span><span class="p">:</span>
            <span class="n">dstop</span> <span class="o">=</span> <span class="n">dstart</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dstop</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_items</span><span class="p">[</span><span class="n">istop</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">dstart</span><span class="p">:</span><span class="n">dstop</span><span class="p">]</span>

    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="nb">str</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">key</span><span class="p">][:</span><span class="bp">self</span><span class="o">.</span><span class="n">_size</span><span class="p">]</span>

    <span class="k">elif</span> <span class="n">key</span> <span class="ow">is</span> <span class="bp">Ellipsis</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;List indices must be integers&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="id33">
<h4><a class="toc-backref" href="#id135">Exercise</a><a class="headerlink" href="#id33" title="Permalink to this headline">¶</a></h4>
<p>Modification of the list is a bit more complicated, because it requires
managing memory properly. Since it poses no real difficulty, we left this as an
exercise for the reader. For the lazy, you can have a look at the code below.
Be careful with negative steps, key range and array expansion. When the
underlying array needs to be expanded, it’s better to expand it more than
necessary in order to avoid future expansion.</p>
<p><strong>setitem</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">L</span> <span class="o">=</span> <span class="n">TypedList</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]])</span>
<span class="n">L</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>╌╌╌╌┬───┬───┐┌───┬───┐┌───┬───┬╌╌╌╌╌
    │ 0 │ 0 ││ 1 │ 1 ││ 2 │ 2 │
 ╌╌╌┴───┴───┘└───┴───┘└───┴───┴╌╌╌╌╌╌
     item 1   item 2   item 3

╌╌╌╌┬───┬───┐┌───┬───┲━━━┓┌───┬───┬╌╌╌╌╌
    │ 0 │ 0 ││ 1 │ 1 ┃ 1 ┃│ 2 │ 2 │
 ╌╌╌┴───┴───┘└───┴───┺━━━┛└───┴───┴╌╌╌╌╌╌
     item 1     item 2     item 3
</pre></div>
</div>
<p><strong>delitem</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">L</span> <span class="o">=</span> <span class="n">TypedList</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]])</span>
<span class="k">del</span> <span class="n">L</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>╌╌╌╌┬───┬───┐┏━━━┳━━━┓┌───┬───┬╌╌╌╌╌
    │ 0 │ 0 │┃ 1 ┃ 1 ┃│ 2 │ 2 │
 ╌╌╌┴───┴───┘┗━━━┻━━━┛└───┴───┴╌╌╌╌╌╌
     item 1   item 2   item 3

╌╌╌╌┬───┬───┐┌───┬───┬╌╌╌╌╌
    │ 0 │ 0 ││ 2 │ 2 │
 ╌╌╌┴───┴───┘└───┴───┴╌╌╌╌╌╌
     item 1    item 2
</pre></div>
</div>
<p><strong>insert</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">L</span> <span class="o">=</span> <span class="n">TypedList</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]])</span>
<span class="n">L</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">])</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>╌╌╌╌┬───┬───┐┌───┬───┐┌───┬───┬╌╌╌╌╌
    │ 0 │ 0 ││ 1 │ 1 ││ 2 │ 2 │
 ╌╌╌┴───┴───┘└───┴───┘└───┴───┴╌╌╌╌╌╌
     item 1   item 2   item 3

╌╌╌╌┬───┬───┐┏━━━┳━━━┓┌───┬───┐┌───┬───┬╌╌╌╌╌
    │ 0 │ 0 │┃ 3 ┃ 3 ┃│ 1 │ 1 ││ 2 │ 2 │
 ╌╌╌┴───┴───┘┗━━━┻━━━┛└───┴───┘└───┴───┴╌╌╌╌╌╌
     item 1   item 2   item 3   item 4
</pre></div>
</div>
</div>
<div class="section" id="id34">
<h4><a class="toc-backref" href="#id136">Sources</a><a class="headerlink" href="#id34" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li><p><a class="reference external" href="code/array_list.py">array_list.py</a> (solution to the exercise)</p></li>
</ul>
</div>
</div>
<div class="section" id="memory-aware-array">
<h3><a class="toc-backref" href="#id137">Memory aware array</a><a class="headerlink" href="#memory-aware-array" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id35">
<h4><a class="toc-backref" href="#id138">Glumpy</a><a class="headerlink" href="#id35" title="Permalink to this headline">¶</a></h4>
<p><a class="reference external" href="http://glumpy.github.io">Glumpy</a> is an OpenGL-based interactive
visualization library in Python whose goal is to make it easy to create fast,
scalable, beautiful, interactive and dynamic visualizations.</p>
<div class="legend admonition">
<p class="admonition-title"><strong>Figure 6.1</strong></p>
<p>Simulation of a spiral galaxy using the density wave theory.</p>
</div>
<a class="bordered reference internal image-reference" href="_images/galaxy.png"><img alt="_images/galaxy.png" class="bordered" src="_images/galaxy.png" style="width: 100%;" /></a>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="legend admonition">
<p class="admonition-title"><strong>Figure 6.2</strong></p>
<p>Tiger display using collections and 2 GL calls</p>
</div>
<a class="bordered reference internal image-reference" href="_images/tiger.png"><img alt="_images/tiger.png" class="bordered" src="_images/tiger.png" style="width: 100%;" /></a>
<p>Glumpy is based on a tight and seamless integration with NumPy arrays. This
means you can manipulate GPU data as you would with regular NumPy arrays and
glumpy will take care of the rest. But an example is worth a thousand words:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">glumpy</span> <span class="kn">import</span> <span class="n">gloo</span>

<span class="n">dtype</span> <span class="o">=</span> <span class="p">[(</span><span class="s2">&quot;position&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>  <span class="c1"># x,y</span>
         <span class="p">(</span><span class="s2">&quot;color&quot;</span><span class="p">,</span>    <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="mi">3</span><span class="p">)]</span>  <span class="c1"># r,g,b</span>
<span class="n">V</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="n">dtype</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">gloo</span><span class="o">.</span><span class="n">VertexBuffer</span><span class="p">)</span>
<span class="n">V</span><span class="p">[</span><span class="s2">&quot;position&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span>
<span class="n">V</span><span class="p">[</span><span class="s2">&quot;position&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span>
</pre></div>
</div>
<p><code class="code docutils literal notranslate"><span class="pre">V</span></code> is a <code class="code docutils literal notranslate"><span class="pre">VertexBuffer</span></code> which is both a <code class="code docutils literal notranslate"><span class="pre">GPUData</span></code> and a NumPy array. When <code class="code docutils literal notranslate"><span class="pre">V</span></code> is
modified, glumpy takes care of computing the smallest contiguous block of dirty
memory since it was last uploaded to GPU memory. When this buffer is to be used
on the GPU, glumpy takes care of uploading the “dirty” area at the very last
moment. This means that if you never use <code class="code docutils literal notranslate"><span class="pre">V</span></code>, nothing will be ever uploaded to
the GPU! In the case above, the last computed “dirty” area is made of 88 bytes
starting at offset 0 as illustrated below:</p>
<a class="reference internal image-reference" href="_images/GPUData.png"><img alt="_images/GPUData.png" src="_images/GPUData.png" style="width: 100%;" /></a>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>When a buffer is created, it is marked as totally dirty, but for the sake of
illustration, just pretend this is not the case here.</p>
</div>
<p>Glumpy will thus end up uploading 88 bytes while only 16 bytes have been
actually modified. You might wonder if this optimal. Actually, most of the time
it is, because uploading some data to a buffer requires a lot of operations on
the GL side and each call has a fixed cost.</p>
</div>
<div class="section" id="array-subclass">
<h4><a class="toc-backref" href="#id139">Array subclass</a><a class="headerlink" href="#array-subclass" title="Permalink to this headline">¶</a></h4>
<p>As explained in the <a class="reference external" href="https://docs.scipy.org/doc/numpy/user/basics.subclassing.html">Subclassing ndarray</a>
documentation, subclassing <code class="code docutils literal notranslate"><span class="pre">ndarray</span></code> is complicated by the fact that new
instances of <code class="code docutils literal notranslate"><span class="pre">ndarray</span></code> classes can come about in three different ways:</p>
<ul class="simple">
<li><p>Explicit constructor call</p></li>
<li><p>View casting</p></li>
<li><p>New from template</p></li>
</ul>
<p>However our case is simpler because we’re only interested in the view
casting. We thus only need to define the <code class="code docutils literal notranslate"><span class="pre">__new__</span></code> method that will be called
at each instance creation. As such, the <code class="code docutils literal notranslate"><span class="pre">GPUData</span></code> class will be equipped with two
properties:</p>
<ul class="simple">
<li><p><code class="code docutils literal notranslate"><span class="pre">extents</span></code>: This represents the full extent of the view relatively to the base
array. It is stored as a byte offset and a byte size.</p></li>
<li><p><code class="code docutils literal notranslate"><span class="pre">pending_data</span></code>: This represents the contiguous <em>dirty</em> area as (byte offset,
byte size) relatively to the <code class="code docutils literal notranslate"><span class="pre">extents</span></code> property.</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">GPUData</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">__array_finalize__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">GPUData</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_extents</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">itemsize</span>
            <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pending_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extents</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_extents</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">_extents</span>
</pre></div>
</div>
</div>
<div class="section" id="computing-extents">
<h4><a class="toc-backref" href="#id140">Computing extents</a><a class="headerlink" href="#computing-extents" title="Permalink to this headline">¶</a></h4>
<p>Each time a partial view of the array is requested, we need to compute the
extents of this partial view while we have access to the base array.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
    <span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span><span class="s1">&#39;shape&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">Z</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">():</span>
        <span class="k">return</span> <span class="n">Z</span>
    <span class="n">Z</span><span class="o">.</span><span class="n">_extents</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_extents</span><span class="p">(</span><span class="n">Z</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">Z</span>

<span class="k">def</span> <span class="nf">_compute_extents</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Z</span><span class="p">):</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">base</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">base</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">__array_interface__</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">view</span> <span class="o">=</span> <span class="n">Z</span><span class="o">.</span><span class="n">__array_interface__</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="n">view</span> <span class="o">-</span> <span class="n">base</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Z</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">strides</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Z</span><span class="o">.</span><span class="n">strides</span><span class="p">)</span>
        <span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="n">shape</span><span class="o">*</span><span class="n">strides</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">+</span> <span class="n">Z</span><span class="o">.</span><span class="n">itemsize</span>
        <span class="k">return</span> <span class="n">offset</span><span class="p">,</span> <span class="n">offset</span><span class="o">+</span><span class="n">size</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">itemsize</span>
</pre></div>
</div>
</div>
<div class="section" id="keeping-track-of-pending-data">
<h4><a class="toc-backref" href="#id141">Keeping track of pending data</a><a class="headerlink" href="#keeping-track-of-pending-data" title="Permalink to this headline">¶</a></h4>
<p>One extra difficulty is that we don’t want all the views to keep track of the
dirty area but only the base array. This is the reason why we don’t instantiate
the <code class="code docutils literal notranslate"><span class="pre">self._pending_data</span></code> in the second case of the <code class="code docutils literal notranslate"><span class="pre">__array_finalize__</span></code>
method. This will be handled when we need to update some data as during a
<code class="code docutils literal notranslate"><span class="pre">__setitem__</span></code> call for example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">Z</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">():</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">key</span><span class="p">)</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extents</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="p">(</span><span class="n">key</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">strides</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">size</span> <span class="o">=</span> <span class="n">Z</span><span class="o">.</span><span class="n">itemsize</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_pending_data</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">offset</span><span class="o">+</span><span class="n">size</span><span class="p">)</span>
        <span class="n">key</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">Z</span><span class="o">.</span><span class="n">_extents</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_extents</span><span class="p">(</span><span class="n">Z</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_pending_data</span><span class="p">(</span><span class="n">Z</span><span class="o">.</span><span class="n">_extents</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">Z</span><span class="o">.</span><span class="n">_extents</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="o">.</span><span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_add_pending_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">):</span>
    <span class="n">base</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">GPUData</span><span class="p">):</span>
        <span class="n">base</span><span class="o">.</span><span class="n">_add_pending_data</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pending_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pending_data</span> <span class="o">=</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">start</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pending_data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">start</span><span class="p">)</span>
            <span class="n">stop</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pending_data</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">stop</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pending_data</span> <span class="o">=</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span>
</pre></div>
</div>
</div>
<div class="section" id="id37">
<h4><a class="toc-backref" href="#id142">Sources</a><a class="headerlink" href="#id37" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li><p><a class="reference external" href="code/gpudata.py">gpudata.py</a></p></li>
</ul>
</div>
</div>
<div class="section" id="id38">
<h3><a class="toc-backref" href="#id143">Conclusion</a><a class="headerlink" href="#id38" title="Permalink to this headline">¶</a></h3>
<p>As explained on the NumPy website, NumPy is the fundamental package for
scientific computing with Python. However, as illustrated in this chapter, the
usage of NumPy strengths goes far beyond a mere <em>multi-dimensional container of
generic data</em>. Using <code class="code docutils literal notranslate"><span class="pre">ndarray</span></code> as a private property in one case (<code class="code docutils literal notranslate"><span class="pre">TypedList</span></code>) or
directly subclassing the <code class="code docutils literal notranslate"><span class="pre">ndarray</span></code> class (<code class="code docutils literal notranslate"><span class="pre">GPUData</span></code>) to keep track of memory in
another case, we’ve seen how it is possible to extend NumPy’s capabilities to
suit very specific needs. The limit is only your imagination and your experience.</p>
</div>
</div>
<div class="section" id="beyond-numpy">
<h2><a class="toc-backref" href="#id69">Beyond NumPy</a><a class="headerlink" href="#beyond-numpy" title="Permalink to this headline">¶</a></h2>
<div class="contents local topic" id="id39">
<p class="topic-title"><strong>Contents</strong></p>
<ul class="simple">
<li><p><a class="reference internal" href="#back-to-python" id="id144">Back to Python</a></p></li>
<li><p><a class="reference internal" href="#numpy-co" id="id145">NumPy &amp; co</a></p>
<ul>
<li><p><a class="reference internal" href="#numexpr" id="id146">NumExpr</a></p></li>
<li><p><a class="reference internal" href="#cython" id="id147">Cython</a></p></li>
<li><p><a class="reference internal" href="#numba" id="id148">Numba</a></p></li>
<li><p><a class="reference internal" href="#theano" id="id149">Theano</a></p></li>
<li><p><a class="reference internal" href="#pycuda" id="id150">PyCUDA</a></p></li>
<li><p><a class="reference internal" href="#pyopencl" id="id151">PyOpenCL</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#scipy-co" id="id152">Scipy &amp; co</a></p>
<ul>
<li><p><a class="reference internal" href="#scikit-learn" id="id153">scikit-learn</a></p></li>
<li><p><a class="reference internal" href="#scikit-image" id="id154">scikit-image</a></p></li>
<li><p><a class="reference internal" href="#sympy" id="id155">SymPy</a></p></li>
<li><p><a class="reference internal" href="#astropy" id="id156">Astropy</a></p></li>
<li><p><a class="reference internal" href="#cartopy" id="id157">Cartopy</a></p></li>
<li><p><a class="reference internal" href="#brian" id="id158">Brian</a></p></li>
<li><p><a class="reference internal" href="#id52" id="id159">Glumpy</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#id54" id="id160">Conclusion</a></p></li>
</ul>
</div>
<div class="section" id="back-to-python">
<h3><a class="toc-backref" href="#id144">Back to Python</a><a class="headerlink" href="#back-to-python" title="Permalink to this headline">¶</a></h3>
<p>You’ve almost reached the end of the book and, hopefully, you’ve learned that
NumPy is a very versatile and powerful library. However in the meantime,
remember that Python is also quite a powerful language. In fact, in some
specific cases, it might be more powerful than NumPy. Let’s consider, for
example, an interesting exercise that has been proposed by Tucker Balch in his
<a class="reference external" href="https://www.coursera.org/learn/computational-investing">Coursera’s Computational Investing</a> course. The exercise
is written as:</p>
<blockquote>
<div><p><em>Write the most succinct code possible to compute all “legal” allocations to 4
stocks such that the allocations are in 1.0 chunks, and the allocations sum
to 10.0.</em></p>
</div></blockquote>
<p><a class="reference external" href="http://yasermartinez.com/blog/index.html">Yaser Martinez</a> collected the
different answers from the community and the proposed solutions yield
surprising results. But let’s start with the most obvious Python solution:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">solution_1</span><span class="p">():</span>
    <span class="c1"># Brute force</span>
    <span class="c1"># 14641 (=11*11*11*11) iterations &amp; tests</span>
    <span class="n">Z</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">11</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">11</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">11</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">11</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">i</span><span class="o">+</span><span class="n">j</span><span class="o">+</span><span class="n">k</span><span class="o">+</span><span class="n">l</span> <span class="o">==</span> <span class="mi">10</span><span class="p">:</span>
                        <span class="n">Z</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">l</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">Z</span>
</pre></div>
</div>
<p>This solution is the slowest solution because it requires 4 loops, and more
importantly, it tests all the different combinations (14641) of 4 integers
between 0 and 10 to retain only combinations whose sum is 10. We can of course
get rid of the 4 loops using itertools, but the code remains slow:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">itertools</span> <span class="k">as</span> <span class="nn">it</span>

<span class="k">def</span> <span class="nf">solution_2</span><span class="p">():</span>
    <span class="c1"># Itertools</span>
    <span class="c1"># 14641 (=11*11*11*11) iterations &amp; tests</span>
    <span class="k">return</span> <span class="p">[(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">l</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">l</span> <span class="ow">in</span> <span class="n">it</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">11</span><span class="p">),</span><span class="n">repeat</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span><span class="o">+</span><span class="n">j</span><span class="o">+</span><span class="n">k</span><span class="o">+</span><span class="n">l</span> <span class="o">==</span> <span class="mi">10</span><span class="p">]</span>
</pre></div>
</div>
<p>One of the best solution that has been proposed by Nick Popplas takes advantage
of the fact we can have intelligent imbricated loops that will allow us to
directly build each tuple without any test as shown below:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">solution_3</span><span class="p">():</span>
    <span class="k">return</span> <span class="p">[(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="p">(</span><span class="mi">10</span> <span class="o">-</span> <span class="n">a</span> <span class="o">-</span> <span class="n">b</span> <span class="o">-</span> <span class="n">c</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">11</span> <span class="o">-</span> <span class="n">a</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">11</span> <span class="o">-</span> <span class="n">a</span> <span class="o">-</span> <span class="n">b</span><span class="p">)]</span>
</pre></div>
</div>
<p>The best NumPy solution by Yaser Martinez uses a different strategy with a
restricted set of tests:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">solution_4</span><span class="p">():</span>
    <span class="n">X123</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">indices</span><span class="p">((</span><span class="mi">11</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">11</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">11</span><span class="o">*</span><span class="mi">11</span><span class="o">*</span><span class="mi">11</span><span class="p">)</span>
    <span class="n">X4</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">-</span> <span class="n">X123</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">X123</span><span class="p">,</span> <span class="n">X4</span><span class="p">))</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">X4</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</pre></div>
</div>
<p>If we benchmark these methods, we get:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">timeit</span><span class="p">(</span><span class="s2">&quot;solution_1()&quot;</span><span class="p">,</span> <span class="nb">globals</span><span class="p">())</span>
<span class="go">100 loops, best of 3: 1.9 msec per loop</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">timeit</span><span class="p">(</span><span class="s2">&quot;solution_2()&quot;</span><span class="p">,</span> <span class="nb">globals</span><span class="p">())</span>
<span class="go">100 loops, best of 3: 1.67 msec per loop</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">timeit</span><span class="p">(</span><span class="s2">&quot;solution_3()&quot;</span><span class="p">,</span> <span class="nb">globals</span><span class="p">())</span>
<span class="go">1000 loops, best of 3: 60.4 usec per loop</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">timeit</span><span class="p">(</span><span class="s2">&quot;solution_4()&quot;</span><span class="p">,</span> <span class="nb">globals</span><span class="p">())</span>
<span class="go">1000 loops, best of 3: 54.4 usec per loop</span>
</pre></div>
</div>
<p>The NumPy solution is the fastest but the pure Python solution is comparable.
But let me introduce a small modification to the Python solution:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">solution_3_bis</span><span class="p">():</span>
    <span class="k">return</span> <span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="p">(</span><span class="mi">10</span> <span class="o">-</span> <span class="n">a</span> <span class="o">-</span> <span class="n">b</span> <span class="o">-</span> <span class="n">c</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">11</span> <span class="o">-</span> <span class="n">a</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">11</span> <span class="o">-</span> <span class="n">a</span> <span class="o">-</span> <span class="n">b</span><span class="p">))</span>
</pre></div>
</div>
<p>If we benchmark it, we get:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">timeit</span><span class="p">(</span><span class="s2">&quot;solution_3_bis()&quot;</span><span class="p">,</span> <span class="nb">globals</span><span class="p">())</span>
<span class="go">10000 loops, best of 3: 0.643 usec per loop</span>
</pre></div>
</div>
<p>You read that right, we have gained a factor of 100 just by replacing square
brackets with parenthesis. How is that possible? The explanation can be found
by looking at the type of the returned object:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">solution_3</span><span class="p">()))</span>
<span class="go">&lt;class &#39;list&#39;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">solution_3_bis</span><span class="p">()))</span>
<span class="go">&lt;class &#39;generator&#39;&gt;</span>
</pre></div>
</div>
<p>The <code class="code docutils literal notranslate"><span class="pre">solution_3_bis()</span></code> returns a generator that can be used to generate the
full list or to iterate over all the different elements. In any case, the huge
speedup comes from the non-instantiation of the full list and it is thus
important to wonder if you need an actual instance of your result or if a
simple generator might do the job.</p>
</div>
<div class="section" id="numpy-co">
<h3><a class="toc-backref" href="#id145">NumPy &amp; co</a><a class="headerlink" href="#numpy-co" title="Permalink to this headline">¶</a></h3>
<p>Beyond NumPy, there are several other Python packages that are worth a look
because they address similar yet different class of problems using different
technology (compilation, virtual machine, just in time compilation, GPU,
compression, etc.). Depending on your specific problem and your hardware, one
package may be better than the other. Let’s illustrate their usage using a very
simple example where we want to compute an expression based on two float
vectors:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="n">c</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">a</span> <span class="o">+</span> <span class="mi">3</span><span class="o">*</span><span class="n">b</span>
</pre></div>
</div>
<div class="section" id="numexpr">
<h4><a class="toc-backref" href="#id146">NumExpr</a><a class="headerlink" href="#numexpr" title="Permalink to this headline">¶</a></h4>
<p>The <a class="reference external" href="https://github.com/pydata/numexpr/wiki/Numexpr-Users-Guide">numexpr</a>
package supplies routines for the fast evaluation of array expressions
element-wise by using a vector-based virtual machine. It’s comparable to SciPy’s
weave package, but doesn’t require a separate compile step of C or C++ code.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">numexpr</span> <span class="k">as</span> <span class="nn">ne</span>

<span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="n">c</span> <span class="o">=</span> <span class="n">ne</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="s2">&quot;2*a + 3*b&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="cython">
<h4><a class="toc-backref" href="#id147">Cython</a><a class="headerlink" href="#cython" title="Permalink to this headline">¶</a></h4>
<p><a class="reference external" href="http://cython.org">Cython</a> is an optimising static compiler for both the
Python programming language and the extended Cython programming language (based
on Pyrex). It makes writing C extensions for Python as easy as Python itself.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="k">def</span> <span class="nf">evaluate</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="n">a</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="n">b</span><span class="p">):</span>
    <span class="n">cdef</span> <span class="nb">int</span> <span class="n">i</span>
    <span class="n">cdef</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">size</span><span class="p">):</span>
        <span class="n">c</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="mi">3</span><span class="o">*</span><span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">c</span>

<span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="n">c</span> <span class="o">=</span> <span class="n">evaluate</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="numba">
<h4><a class="toc-backref" href="#id148">Numba</a><a class="headerlink" href="#numba" title="Permalink to this headline">¶</a></h4>
<p><a class="reference external" href="http://numba.pydata.org">Numba</a> gives you the power to speed up your
applications with high performance functions written directly in Python. With a
few annotations, array-oriented and math-heavy Python code can be just-in-time
compiled to native machine instructions, similar in performance to C, C++ and
Fortran, without having to switch languages or Python interpreters.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">numba</span> <span class="kn">import</span> <span class="n">jit</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="nd">@jit</span>
<span class="k">def</span> <span class="nf">evaluate</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">size</span><span class="p">):</span>
        <span class="n">c</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="mi">3</span><span class="o">*</span><span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">c</span>

<span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="n">c</span> <span class="o">=</span> <span class="n">evaluate</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="theano">
<h4><a class="toc-backref" href="#id149">Theano</a><a class="headerlink" href="#theano" title="Permalink to this headline">¶</a></h4>
<p><a class="reference external" href="http://www.deeplearning.net/software/theano/">Theano</a> is a Python library
that allows you to define, optimize, and evaluate mathematical expressions
involving multi-dimensional arrays efficiently. Theano features tight
integration with NumPy, transparent use of a GPU, efficient symbolic
differentiation, speed and stability optimizations, dynamic C code generation
and extensive unit-testing and self-verification.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">theano.tensor</span> <span class="k">as</span> <span class="nn">T</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">fvector</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">fvector</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">)</span>
<span class="n">z</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">x</span> <span class="o">+</span> <span class="mi">3</span><span class="o">*</span><span class="n">y</span>
<span class="n">f</span> <span class="o">=</span> <span class="n">function</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">],</span> <span class="n">z</span><span class="p">)</span>

<span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="n">c</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="pycuda">
<h4><a class="toc-backref" href="#id150">PyCUDA</a><a class="headerlink" href="#pycuda" title="Permalink to this headline">¶</a></h4>
<p><a class="reference external" href="http://mathema.tician.de/software/pycuda">PyCUDA</a> lets you access Nvidia’s
CUDA parallel computation API from Python.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pycuda.autoinit</span>
<span class="kn">import</span> <span class="nn">pycuda.driver</span> <span class="k">as</span> <span class="nn">drv</span>
<span class="kn">from</span> <span class="nn">pycuda.compiler</span> <span class="kn">import</span> <span class="n">SourceModule</span>

<span class="n">mod</span> <span class="o">=</span> <span class="n">SourceModule</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    __global__ void evaluate(float *c, float *a, float *b)</span>
<span class="s2">    {</span>
<span class="s2">      const int i = threadIdx.x;</span>
<span class="s2">      c[i] = 2*a[i] + 3*b[i];</span>
<span class="s2">    }</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">)</span>

<span class="n">evaluate</span> <span class="o">=</span> <span class="n">mod</span><span class="o">.</span><span class="n">get_function</span><span class="p">(</span><span class="s2">&quot;evaluate&quot;</span><span class="p">)</span>

<span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>

<span class="n">evaluate</span><span class="p">(</span><span class="n">drv</span><span class="o">.</span><span class="n">Out</span><span class="p">(</span><span class="n">c</span><span class="p">),</span> <span class="n">drv</span><span class="o">.</span><span class="n">In</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="n">drv</span><span class="o">.</span><span class="n">In</span><span class="p">(</span><span class="n">b</span><span class="p">),</span> <span class="n">block</span><span class="o">=</span><span class="p">(</span><span class="mi">400</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">grid</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="section" id="pyopencl">
<h4><a class="toc-backref" href="#id151">PyOpenCL</a><a class="headerlink" href="#pyopencl" title="Permalink to this headline">¶</a></h4>
<p><a class="reference external" href="http://mathema.tician.de/software/pyopencl">PyOpenCL</a> lets you access GPUs
and other massively parallel compute devices from Python.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pyopencl</span> <span class="k">as</span> <span class="nn">cl</span>

<span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty_like</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>

<span class="n">ctx</span> <span class="o">=</span> <span class="n">cl</span><span class="o">.</span><span class="n">create_some_context</span><span class="p">()</span>
<span class="n">queue</span> <span class="o">=</span> <span class="n">cl</span><span class="o">.</span><span class="n">CommandQueue</span><span class="p">(</span><span class="n">ctx</span><span class="p">)</span>

<span class="n">mf</span> <span class="o">=</span> <span class="n">cl</span><span class="o">.</span><span class="n">mem_flags</span>
<span class="n">gpu_a</span> <span class="o">=</span> <span class="n">cl</span><span class="o">.</span><span class="n">Buffer</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">mf</span><span class="o">.</span><span class="n">READ_ONLY</span> <span class="o">|</span> <span class="n">mf</span><span class="o">.</span><span class="n">COPY_HOST_PTR</span><span class="p">,</span> <span class="n">hostbuf</span><span class="o">=</span><span class="n">a</span><span class="p">)</span>
<span class="n">gpu_b</span> <span class="o">=</span> <span class="n">cl</span><span class="o">.</span><span class="n">Buffer</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">mf</span><span class="o">.</span><span class="n">READ_ONLY</span> <span class="o">|</span> <span class="n">mf</span><span class="o">.</span><span class="n">COPY_HOST_PTR</span><span class="p">,</span> <span class="n">hostbuf</span><span class="o">=</span><span class="n">b</span><span class="p">)</span>

<span class="n">evaluate</span> <span class="o">=</span> <span class="n">cl</span><span class="o">.</span><span class="n">Program</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    __kernel void evaluate(__global const float *gpu_a;</span>
<span class="s2">                           __global const float *gpu_b;</span>
<span class="s2">                           __global       float *gpu_c)</span>
<span class="s2">    {</span>
<span class="s2">        int gid = get_global_id(0);</span>
<span class="s2">        gpu_c[gid] = 2*gpu_a[gid] + 3*gpu_b[gid];</span>
<span class="s2">    }</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">build</span><span class="p">()</span>

<span class="n">gpu_c</span> <span class="o">=</span> <span class="n">cl</span><span class="o">.</span><span class="n">Buffer</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">mf</span><span class="o">.</span><span class="n">WRITE_ONLY</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">nbytes</span><span class="p">)</span>
<span class="n">evaluate</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">gpu_a</span><span class="p">,</span> <span class="n">gpu_b</span><span class="p">,</span> <span class="n">gpu_c</span><span class="p">)</span>
<span class="n">cl</span><span class="o">.</span><span class="n">enqueue_copy</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">gpu_c</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="scipy-co">
<h3><a class="toc-backref" href="#id152">Scipy &amp; co</a><a class="headerlink" href="#scipy-co" title="Permalink to this headline">¶</a></h3>
<p>If there are several additional packages for NumPy, there are a trillion
additional packages for scipy. In fact, every domain of science probably has
its own package and most of the examples we’ve been studying until now could
have been solved in two or three calls to a method in the relevant package.
But of course, that was not the goal and programming things yourself is generally
a good exercise if you have some spare time. The biggest difficulty at this
point is to find these relevant packages. Here is a very short list of packages
that are well-maintained, well-tested and may simplify your scientific life
(depending on your domain). There are of course many more and depending on your
specific needs, chances are you do not have to program everything by
yourself. For an extensive list, have a look at the <a class="reference external" href="https://awesome-python.com">Awesome python list</a>.</p>
<div class="section" id="scikit-learn">
<h4><a class="toc-backref" href="#id153">scikit-learn</a><a class="headerlink" href="#scikit-learn" title="Permalink to this headline">¶</a></h4>
<p><a class="reference external" href="http://scikit-learn.org/stable/">scikit-learn</a> is a free software machine
learning library for the Python programming language. It features various
classification, regression and clustering algorithms including support vector
machines, random forests, gradient boosting, k-means and DBSCAN, and is
designed to inter-operate with the Python numerical and scientific libraries
NumPy and SciPy.</p>
</div>
<div class="section" id="scikit-image">
<h4><a class="toc-backref" href="#id154">scikit-image</a><a class="headerlink" href="#scikit-image" title="Permalink to this headline">¶</a></h4>
<p><a class="reference external" href="http://scikit-image.org">scikit-image</a> is a Python package dedicated to
image processing, and using natively NumPy arrays as image objects. This
chapter describes how to use scikit-image on various image processing tasks,
and insists on the link with other scientific Python modules such as NumPy and
SciPy.</p>
</div>
<div class="section" id="sympy">
<h4><a class="toc-backref" href="#id155">SymPy</a><a class="headerlink" href="#sympy" title="Permalink to this headline">¶</a></h4>
<p><a class="reference external" href="http://www.sympy.org/en/index.html">SymPy</a> is a Python library for symbolic
mathematics. It aims to become a full-featured computer algebra system (CAS)
while keeping the code as simple as possible in order to be comprehensible and
easily extensible. SymPy is written entirely in Python.</p>
</div>
<div class="section" id="astropy">
<h4><a class="toc-backref" href="#id156">Astropy</a><a class="headerlink" href="#astropy" title="Permalink to this headline">¶</a></h4>
<p>The <a class="reference external" href="http://www.astropy.org">Astropy</a> project is a community effort to
develop a single core package for astronomy in Python and foster
interoperability between Python astronomy packages.</p>
</div>
<div class="section" id="cartopy">
<h4><a class="toc-backref" href="#id157">Cartopy</a><a class="headerlink" href="#cartopy" title="Permalink to this headline">¶</a></h4>
<p><a class="reference external" href="http://scitools.org.uk/cartopy/">Cartopy</a> is a Python package designed to
make drawing maps for data analysis and visualization as easy as
possible. Cartopy makes use of the powerful PROJ.4, NumPy and shapely libraries
and has a simple and intuitive drawing interface to matplotlib for creating
publication quality maps.</p>
</div>
<div class="section" id="brian">
<h4><a class="toc-backref" href="#id158">Brian</a><a class="headerlink" href="#brian" title="Permalink to this headline">¶</a></h4>
<p><a class="reference external" href="http://www.briansimulator.org">Brian</a> is a free, open source simulator for
spiking neural networks. It is written in the Python programming language and
is available on almost all platforms. We believe that a simulator should not
only save the time of processors, but also the time of scientists. Brian is
therefore designed to be easy to learn and use, highly flexible and easily
extensible.</p>
</div>
<div class="section" id="id52">
<h4><a class="toc-backref" href="#id159">Glumpy</a><a class="headerlink" href="#id52" title="Permalink to this headline">¶</a></h4>
<p><a class="reference external" href="http://glumpy.github.io">Glumpy</a> is an OpenGL-based interactive
visualization library in Python. Its goal is to make it easy to create fast,
scalable, beautiful, interactive and dynamic visualizations.</p>
</div>
</div>
<div class="section" id="id54">
<h3><a class="toc-backref" href="#id160">Conclusion</a><a class="headerlink" href="#id54" title="Permalink to this headline">¶</a></h3>
<p>NumPy is a very versatile library but still, it does not mean you have to use
it in every situation. In this chapter, we’ve seen some alternatives (including
Python itself) that are worth a look. As always, the choice belongs to you. You
have to consider what is the best solution for you in term of development time,
computation time and effort in maintenance. On the one hand, if you design your
own solution, you’ll have to test it and to maintain it, but in exchange,
you’ll be free to design it the way you want. On the other hand, if you decide
to rely on a third-party package, you’ll save time in development and benefit
from community-support even though you might have to adapt the package to your
specific needs. The choice is up to you.</p>
</div>
</div>
<div class="section" id="id55">
<h2><a class="toc-backref" href="#id70">Conclusion</a><a class="headerlink" href="#id55" title="Permalink to this headline">¶</a></h2>
<p>You’ve reached the end of this book. I hope you’ve learned something while
reading it, I sure learned a lot writing it. Trying to explain something is a
generally a good exercise to test for your knowledge of this thing. Of course,
we only scratched the surface of NumPy and there are many things left to
discover. Have a look at the bibliography for books written by true experts, at
the documentation written by people making NumPy and don’t hesitate to ask your
questions on the mailing lists because the NumPy community is very friendly.</p>
<p>If there’s a single message to retain from this book it is “premature
optimization is the root of all evil”. We’ve seen that code vectorization can
drastically improve your computation, with several orders of magnitude in some
cases. Still, problem vectorization is generally much more powerful. If you
write code vectorization too early in your design process, you won’t be able to
think out-of-the-box and you’ll certainly miss some really powerful alternatives
because you won’t be able to identify your problem properly as we’ve
seen in the problem vectorization chapter. This requires some experience and
you have to be patient: experience is not an overnight process.</p>
<p>Finally, custom vectorization is an option worth considering once you’ve looked
at the alternatives to NumPy. When nothing works for you, NumPy still offers
you a clever framework to forge your own tools. And who knows, this can be the
start of an exciting adventure for you and the community as it happened to me
with the <a class="reference external" href="http://glumpy.github.io">glumpy</a> and the <a class="reference external" href="http://vispy.org">vispy</a> packages.</p>
</div>
<div class="section" id="quick-references">
<h2><a class="toc-backref" href="#id71">Quick References</a><a class="headerlink" href="#quick-references" title="Permalink to this headline">¶</a></h2>
<div class="contents local topic" id="id57">
<p class="topic-title"><strong>Contents</strong></p>
<ul class="simple">
<li><p><a class="reference internal" href="#id58" id="id161">Data type</a></p></li>
<li><p><a class="reference internal" href="#id59" id="id162">Creation</a></p></li>
<li><p><a class="reference internal" href="#id60" id="id163">Indexing</a></p></li>
<li><p><a class="reference internal" href="#reshaping" id="id164">Reshaping</a></p></li>
<li><p><a class="reference internal" href="#broadcasting" id="id165">Broadcasting</a></p></li>
</ul>
</div>
<div class="section" id="id58">
<h3><a class="toc-backref" href="#id161">Data type</a><a class="headerlink" href="#id58" title="Permalink to this headline">¶</a></h3>
<table class="table">
<colgroup>
<col style="width: 16%" />
<col style="width: 7%" />
<col style="width: 6%" />
<col style="width: 71%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Type</p></th>
<th class="head"><p>Name</p></th>
<th class="head"><p>Bytes</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="code docutils literal notranslate"><span class="pre">bool</span></code></p></td>
<td><p><code class="code docutils literal notranslate"><span class="pre">b</span></code></p></td>
<td><p>1</p></td>
<td><p>Boolean (True or False) stored as a byte</p></td>
</tr>
<tr class="row-odd"><td><p><code class="code docutils literal notranslate"><span class="pre">int</span></code></p></td>
<td><p><code class="code docutils literal notranslate"><span class="pre">l</span></code></p></td>
<td><p>4-8</p></td>
<td><p>Platform (long) integer (normally either int32 or int64)</p></td>
</tr>
<tr class="row-even"><td><p><code class="code docutils literal notranslate"><span class="pre">intp</span></code></p></td>
<td><p><code class="code docutils literal notranslate"><span class="pre">p</span></code></p></td>
<td><p>4-8</p></td>
<td><p>Integer used for indexing (normally either int32 or int64)</p></td>
</tr>
<tr class="row-odd"><td><p><code class="code docutils literal notranslate"><span class="pre">int8</span></code></p></td>
<td><p><code class="code docutils literal notranslate"><span class="pre">i1</span></code></p></td>
<td><p>1</p></td>
<td><p>Byte (-128 to 127)</p></td>
</tr>
<tr class="row-even"><td><p><code class="code docutils literal notranslate"><span class="pre">int16</span></code></p></td>
<td><p><code class="code docutils literal notranslate"><span class="pre">i2</span></code></p></td>
<td><p>2</p></td>
<td><p>Integer (-32768 to 32767)</p></td>
</tr>
<tr class="row-odd"><td><p><code class="code docutils literal notranslate"><span class="pre">int32</span></code></p></td>
<td><p><code class="code docutils literal notranslate"><span class="pre">i4</span></code></p></td>
<td><p>4</p></td>
<td><p>Integer (-2147483648 to 2147483647)</p></td>
</tr>
<tr class="row-even"><td><p><code class="code docutils literal notranslate"><span class="pre">int64</span></code></p></td>
<td><p><code class="code docutils literal notranslate"><span class="pre">i8</span></code></p></td>
<td><p>8</p></td>
<td><p>Integer (-9223372036854775808 to 9223372036854775807)</p></td>
</tr>
<tr class="row-odd"><td><p><code class="code docutils literal notranslate"><span class="pre">uint8</span></code></p></td>
<td><p><code class="code docutils literal notranslate"><span class="pre">u1</span></code></p></td>
<td><p>1</p></td>
<td><p>Unsigned integer (0 to 255)</p></td>
</tr>
<tr class="row-even"><td><p><code class="code docutils literal notranslate"><span class="pre">uint16</span></code></p></td>
<td><p><code class="code docutils literal notranslate"><span class="pre">u2</span></code></p></td>
<td><p>2</p></td>
<td><p>Unsigned integer (0 to 65535)</p></td>
</tr>
<tr class="row-odd"><td><p><code class="code docutils literal notranslate"><span class="pre">uint32</span></code></p></td>
<td><p><code class="code docutils literal notranslate"><span class="pre">u4</span></code></p></td>
<td><p>4</p></td>
<td><p>Unsigned integer (0 to 4294967295)</p></td>
</tr>
<tr class="row-even"><td><p><code class="code docutils literal notranslate"><span class="pre">uint64</span></code></p></td>
<td><p><code class="code docutils literal notranslate"><span class="pre">u8</span></code></p></td>
<td><p>8</p></td>
<td><p>Unsigned integer (0 to 18446744073709551615)</p></td>
</tr>
<tr class="row-odd"><td><p><code class="code docutils literal notranslate"><span class="pre">float</span></code></p></td>
<td><p><code class="code docutils literal notranslate"><span class="pre">f8</span></code></p></td>
<td><p>8</p></td>
<td><p>Shorthand for float64</p></td>
</tr>
<tr class="row-even"><td><p><code class="code docutils literal notranslate"><span class="pre">float16</span></code></p></td>
<td><p><code class="code docutils literal notranslate"><span class="pre">f2</span></code></p></td>
<td><p>2</p></td>
<td><p>Half precision float:
sign bit, 5 bits exponent, 10 bits mantissa</p></td>
</tr>
<tr class="row-odd"><td><p><code class="code docutils literal notranslate"><span class="pre">float32</span></code></p></td>
<td><p><code class="code docutils literal notranslate"><span class="pre">f</span></code></p></td>
<td><p>4</p></td>
<td><p>Single precision float:
sign bit, 8 bits exponent, 23 bits mantissa</p></td>
</tr>
<tr class="row-even"><td><p><code class="code docutils literal notranslate"><span class="pre">float64</span></code></p></td>
<td><p><code class="code docutils literal notranslate"><span class="pre">d</span></code></p></td>
<td><p>8</p></td>
<td><p>Double precision float:
sign bit, 11 bits exponent, 52 bits mantissa</p></td>
</tr>
<tr class="row-odd"><td><p><code class="code docutils literal notranslate"><span class="pre">complex</span></code></p></td>
<td><p><code class="code docutils literal notranslate"><span class="pre">c16</span></code></p></td>
<td><p>16</p></td>
<td><p>Shorthand for complex128.</p></td>
</tr>
<tr class="row-even"><td><p><code class="code docutils literal notranslate"><span class="pre">complex64</span></code></p></td>
<td><p><code class="code docutils literal notranslate"><span class="pre">c8</span></code></p></td>
<td><p>8</p></td>
<td><p>Complex number, represented by two 32-bit floats</p></td>
</tr>
<tr class="row-odd"><td><p><code class="code docutils literal notranslate"><span class="pre">complex128</span></code></p></td>
<td><p><code class="code docutils literal notranslate"><span class="pre">c16</span></code></p></td>
<td><p>16</p></td>
<td><p>Complex number, represented by two 64-bit floats</p></td>
</tr>
</tbody>
</table>
<p><code class="code docutils literal notranslate"><span class="pre">bool</span></code>, <code class="code docutils literal notranslate"><span class="pre">int</span></code>, <code class="code docutils literal notranslate"><span class="pre">float</span></code>, and <code class="code docutils literal notranslate"><span class="pre">complex</span></code> are understood, but named <code class="code docutils literal notranslate"><span class="pre">np.bool_</span></code> with
an additional underscore in NumPy. Additionally the names such as <code class="code docutils literal notranslate"><span class="pre">intc</span></code>,
<code class="code docutils literal notranslate"><span class="pre">long</span></code>, or <code class="code docutils literal notranslate"><span class="pre">double</span></code>  used in the C programming language are defined.</p>
</div>
<div class="section" id="id59">
<h3><a class="toc-backref" href="#id162">Creation</a><a class="headerlink" href="#id59" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>┌───┬───┬───┬───┬───┬───┬───┬───┬───┐
│ 0 │ 0 │ 0 │ 0 │ 0 │ 0 │ 0 │ 0 │ 0 │
└───┴───┴───┴───┴───┴───┴───┴───┴───┘
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>┌───┬───┬───┬───┬───┬───┬───┬───┬───┐
│ 1 │ 1 │ 1 │ 1 │ 1 │ 1 │ 1 │ 1 │ 1 │
└───┴───┴───┴───┴───┴───┴───┴───┴───┘
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>┌───┬───┬───┬───┬───┬───┬───┬───┬───┐
│ 1 │ 0 │ 0 │ 0 │ 0 │ 0 │ 0 │ 1 │ 0 │
└───┴───┴───┴───┴───┴───┴───┴───┴───┘
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">Z</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>┌───┬───┬───┬───┬───┬───┬───┬───┬───┐
│ 2 │ 2 │ 2 │ 2 │ 2 │ 2 │ 2 │ 2 │ 2 │
└───┴───┴───┴───┴───┴───┴───┴───┴───┘
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>┌───┬───┬───┬───┬───┬───┬───┬───┬───┐
│ 0 │ 1 │ 2 │ 3 │ 4 │ 5 │ 6 │ 7 │ 8 │
└───┴───┴───┴───┴───┴───┴───┴───┴───┘
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>┌───┐
│ 0 │
├───┤
│ 1 │
├───┤
│ 2 │
├───┤
│ 3 │
├───┤
│ 4 │
├───┤
│ 5 │
├───┤
│ 6 │
├───┤
│ 7 │
├───┤
│ 8 │
└───┘
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>┌───┬───┬───┐
│ 0 │ 1 │ 2 │
├───┼───┼───┤
│ 3 │ 4 │ 5 │
├───┼───┼───┤
│ 6 │ 7 │ 8 │
└───┴───┴───┘
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">9</span><span class="p">,(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>┌───┬───┬───┐
│ 4 │ 5 │ 7 │
├───┼───┼───┤
│ 0 │ 2 │ 6 │
├───┼───┼───┤
│ 8 │ 4 │ 0 │
└───┴───┴───┘
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>┌──────┬──────┬──────┬──────┬──────┐
│ 0.00 │ 0.25 │ 0.50 │ 0.75 │ 1.00 │
└──────┴──────┴──────┴──────┴──────┘
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">mgrid</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>┌───┬───┬───┐   ┌───┬───┬───┐
│ 0 │ 0 │ 0 │   │ 0 │ 1 │ 2 │
├───┼───┼───┤   ├───┼───┼───┤
│ 1 │ 1 │ 1 │   │ 0 │ 1 │ 2 │
├───┼───┼───┤   ├───┼───┼───┤
│ 2 │ 2 │ 2 │   │ 0 │ 1 │ 2 │
└───┴───┴───┘   └───┴───┴───┘
</pre></div>
</div>
</div>
<div class="section" id="id60">
<h3><a class="toc-backref" href="#id163">Indexing</a><a class="headerlink" href="#id60" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="n">Z</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>┏━━━┓───┬───┐   ┏━━━┓
┃ 0 ┃ 1 │ 2 │ → ┃ 0 ┃ (scalar)
┗━━━┛───┼───┤   ┗━━━┛
│ 3 │ 4 │ 5 │
├───┼───┼───┤
│ 6 │ 7 │ 8 │
└───┴───┴───┘
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="n">Z</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>┌───┬───┬───┐
│ 0 │ 1 │ 2 │
├───┼───┼───┤
│ 3 │ 4 │ 5 │
├───┼───┏━━━┓   ┏━━━┓
│ 6 │ 7 ┃ 8 ┃ → ┃ 8 ┃ (scalar)
└───┴───┗━━━┛   ┗━━━┛
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="n">Z</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>┌───┬───┬───┐
│ 0 │ 1 │ 2 │
┏━━━┳━━━┳━━━┓   ┏━━━┳━━━┳━━━┓
┃ 3 ┃ 4 ┃ 5 ┃ → ┃ 3 ┃ 4 ┃ 5 ┃
┗━━━┻━━━┻━━━┛   ┗━━━┻━━━┻━━━┛
│ 6 │ 7 │ 8 │      (view)
└───┴───┴───┘
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="n">Z</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>┌───┬───┏━━━┓   ┏━━━┓
│ 0 │ 1 ┃ 2 ┃   ┃ 2 ┃
├───┼───┣━━━┫   ┣━━━┫
│ 3 │ 4 ┃ 5 ┃ → ┃ 5 ┃ (view)
├───┼───┣━━━┫   ┣━━━┫
│ 6 │ 7 ┃ 8 ┃   ┃ 8 ┃
└───┴───┗━━━┛   ┗━━━┛
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="n">Z</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span><span class="mi">1</span><span class="p">:]</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>┌───┬───┬───┐
│ 0 │ 1 │ 2 │    (view)
├───┏━━━┳━━━┓   ┏━━━┳━━━┓
│ 3 ┃ 4 ┃ 5 ┃   ┃ 4 ┃ 5 ┃
├───┣━━━╋━━━┫ → ┣━━━╋━━━┫
│ 6 ┃ 7 ┃ 8 ┃   ┃ 7 ┃ 8 ┃
└───┗━━━┻━━━┛   ┗━━━┻━━━┛
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="n">Z</span><span class="p">[::</span><span class="mi">2</span><span class="p">,::</span><span class="mi">2</span><span class="p">]</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>┏━━━┓───┏━━━┓   ┏━━━┳━━━┓
┃ 0 ┃ 1 ┃ 2 ┃   ┃ 0 ┃ 2 ┃
┗━━━┛───┗━━━┛ → ┣━━━╋━━━┫
│ 3 │ 4 │ 5 │   ┃ 6 ┃ 8 ┃
┏━━━┓───┏━━━┓   ┗━━━┻━━━┛
┃ 6 ┃ 7 ┃ 8 ┃    (view)
┗━━━┛───┗━━━┛
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="n">Z</span><span class="p">[[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">]]</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>┏━━━┓───┬───┐
┃ 0 ┃ 1 │ 2 │
┗━━━┛───┏━━━┓   ┏━━━┳━━━┓
│ 3 │ 4 ┃ 5 ┃ → ┃ 0 ┃ 5 ┃
├───┼───┗━━━┛   ┗━━━┻━━━┛
│ 6 │ 7 │ 8 │    (copy)
└───┴───┴───┘
</pre></div>
</div>
</div>
<div class="section" id="reshaping">
<h3><a class="toc-backref" href="#id164">Reshaping</a><a class="headerlink" href="#reshaping" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>┌───┬───┬───┬───┬───┬───┬───┬───┬───┬───┏━━━┓───┐
│ 0 │ 0 │ 0 │ 0 │ 0 │ 0 │ 0 │ 0 │ 0 │ 0 ┃ 1 ┃ 0 │
└───┴───┴───┴───┴───┴───┴───┴───┴───┴───┗━━━┛───┘
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>┌───┐
│ 0 │
├───┤
│ 0 │
├───┤
│ 0 │
├───┤
│ 0 │
├───┤
│ 0 │
├───┤
│ 0 │
├───┤
│ 0 │
├───┤
│ 0 │
├───┤
│ 0 │
├───┤
│ 0 │
┏━━━┓
┃ 1 ┃
┗━━━┛
│ 0 │
└───┘
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>┌───┬───┬───┬───┐
│ 0 │ 0 │ 0 │ 0 │
├───┼───┼───┼───┤
│ 0 │ 0 │ 0 │ 0 │
├───┼───┏━━━┓───┤
│ 0 │ 0 ┃ 1 ┃ 0 │
└───┴───┗━━━┛───┘
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>┌───┬───┬───┐
│ 0 │ 0 │ 0 │
├───┼───┼───┤
│ 0 │ 0 │ 0 │
├───┼───┼───┤
│ 0 │ 0 │ 0 │
├───┏━━━┓───┤
│ 0 ┃ 1 ┃ 0 │
└───┗━━━┛───┘
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>┌───┬───┐
│ 0 │ 0 │
├───┼───┤
│ 0 │ 0 │
├───┼───┤
│ 0 │ 0 │
├───┼───┤
│ 0 │ 0 │
├───┼───┤
│ 0 │ 0 │
┏━━━┓───┤
┃ 1 ┃ 0 │
┗━━━┛───┘
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>┌───┬───┬───┬───┬───┬───┐
│ 0 │ 0 │ 0 │ 0 │ 0 │ 0 │
├───┼───┼───┼───┏━━━┓───┤
│ 0 │ 0 │ 0 │ 0 ┃ 1 ┃ 0 │
└───┴───┴───┴───┗━━━┛───┘
</pre></div>
</div>
</div>
<div class="section" id="broadcasting">
<h3><a class="toc-backref" href="#id165">Broadcasting</a><a class="headerlink" href="#broadcasting" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">Z1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="n">Z2</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">Z1</span> <span class="o">+</span> <span class="n">Z2</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>┌───┬───┬───┐   ┌───┐   ┌───┬───┬───┐   ┏━━━┓───┬───┐   ┌───┬───┬───┐
│ 0 │ 1 │ 2 │ + │ 1 │ = │ 0 │ 1 │ 2 │ + ┃ 1 ┃ 1 │ 1 │ = │ 1 │ 2 │ 3 │
├───┼───┼───┤   └───┘   ├───┼───┼───┤   ┗━━━┛───┼───┤   ├───┼───┼───┤
│ 3 │ 4 │ 5 │           │ 3 │ 4 │ 5 │   │ 1 │ 1 │ 1 │   │ 4 │ 5 │ 6 │
├───┼───┼───┤           ├───┼───┼───┤   ├───┼───┼───┤   ├───┼───┼───┤
│ 6 │ 7 │ 8 │           │ 6 │ 7 │ 8 │   │ 1 │ 1 │ 1 │   │ 7 │ 8 │ 9 │
└───┴───┴───┘           └───┴───┴───┘   └───┴───┴───┘   └───┴───┴───┘
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">Z1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="n">Z2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">3</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="n">Z1</span> <span class="o">+</span> <span class="n">Z2</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>┌───┬───┬───┐   ┌───┐   ┌───┬───┬───┐   ┏━━━┓───┬───┐   ┌───┬───┬───┐
│ 0 │ 1 │ 2 │ + │ 2 │ = │ 0 │ 1 │ 2 │ + ┃ 2 ┃ 2 │ 2 │ = │ 2 │ 3 │ 4 │
├───┼───┼───┤   ├───┤   ├───┼───┼───┤   ┣━━━┫───┼───┤   ├───┼───┼───┤
│ 3 │ 4 │ 5 │   │ 1 │   │ 3 │ 4 │ 5 │   ┃ 1 ┃ 1 │ 1 │   │ 4 │ 5 │ 6 │
├───┼───┼───┤   ├───┤   ├───┼───┼───┤   ┣━━━┫───┼───┤   ├───┼───┼───┤
│ 6 │ 7 │ 8 │   │ 0 │   │ 6 │ 7 │ 8 │   ┃ 0 ┃ 0 │ 0 │   │ 6 │ 7 │ 8 │
└───┴───┴───┘   └───┘   └───┴───┴───┘   ┗━━━┛───┴───┘   └───┴───┴───┘
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">Z1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="n">Z2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">3</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="n">Z1</span> <span class="o">+</span> <span class="n">Z2</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>┌───┬───┬───┐   ┌───┬───┬───┐   ┌───┬───┬───┐   ┏━━━┳━━━┳━━━┓   ┌───┬───┬───┐
│ 0 │ 1 │ 2 │ + │ 2 │ 1 │ 0 │ = │ 0 │ 1 │ 2 │ + ┃ 2 ┃ 1 ┃ 0 ┃ = │ 2 │ 2 │ 2 │
├───┼───┼───┤   └───┴───┴───┘   ├───┼───┼───┤   ┗━━━┻━━━┻━━━┛   ├───┼───┼───┤
│ 3 │ 4 │ 5 │                   │ 3 │ 4 │ 5 │   │ 2 │ 1 │ 0 │   │ 5 │ 5 │ 5 │
├───┼───┼───┤                   ├───┼───┼───┤   ├───┼───┼───┤   ├───┼───┼───┤
│ 6 │ 7 │ 8 │                   │ 6 │ 7 │ 8 │   │ 2 │ 1 │ 0 │   │ 8 │ 8 │ 8 │
└───┴───┴───┘                   └───┴───┴───┘   └───┴───┴───┘   └───┴───┴───┘
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">Z1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="n">Z2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="n">Z1</span> <span class="o">+</span> <span class="n">Z2</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>┌───┐   ┌───┬───┬───┐   ┏━━━┓───┬───┐   ┏━━━┳━━━┳━━━┓   ┌───┬───┬───┐
│ 0 │ + │ 0 │ 1 │ 2 │ = ┃ 0 ┃ 0 │ 0 │ + ┃ 0 ┃ 1 ┃ 2 ┃ = │ 0 │ 1 │ 2 │
├───┤   └───┴───┴───┘   ┣━━━┫───┼───┤   ┗━━━┻━━━┻━━━┛   ├───┼───┼───┤
│ 1 │                   ┃ 1 ┃ 1 │ 1 │   │ 0 │ 1 │ 2 │   │ 1 │ 2 │ 3 │
├───┤                   ┣━━━┫───┼───┤   ├───┼───┼───┤   ├───┼───┼───┤
│ 2 │                   ┃ 2 ┃ 2 │ 2 │   │ 0 │ 1 │ 2 │   │ 2 │ 3 │ 4 │
└───┘                   ┗━━━┛───┴───┘   └───┴───┴───┘   └───┴───┴───┘
</pre></div>
</div>
</div>
</div>
<div class="section" id="bibliography">
<h2><a class="toc-backref" href="#id72">Bibliography</a><a class="headerlink" href="#bibliography" title="Permalink to this headline">¶</a></h2>
<p>This is a curated list of some NumPy related resources (articles, books &amp;
tutorials) addressing different aspects of NumPy. Some are very specific to
NumPy/Scipy while some others offer a broader view on numerical computing.</p>
<div class="contents local topic" id="id61">
<p class="topic-title"><strong>Contents</strong></p>
<ul class="simple">
<li><p><a class="reference internal" href="#tutorials" id="id166">Tutorials</a></p></li>
<li><p><a class="reference internal" href="#articles" id="id167">Articles</a></p></li>
<li><p><a class="reference internal" href="#books" id="id168">Books</a></p></li>
</ul>
</div>
<div class="section" id="tutorials">
<h3><a class="toc-backref" href="#id166">Tutorials</a><a class="headerlink" href="#tutorials" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p><a class="reference external" href="http://www.labri.fr/perso/nrougier/teaching/numpy.100/index.html">100 Numpy exercises</a>, Nicolas P. Rougier, 2016.</p></li>
<li><p><a class="reference external" href="https://github.com/rougier/numpy-tutorial">Numpy tutorial</a>, Nicolas P. Rougier, 2015.</p></li>
<li><p><a class="reference external" href="http://www.python-course.eu/numpy.php">Python course</a>, Bernd Klein, 2015.</p></li>
<li><p><a class="reference external" href="https://engineering.ucsb.edu/~shell/che210d/numpy.pdf">An introduction to Numpy and Scipy</a>, M. Scott Shell, 2014.</p></li>
<li><p><a class="reference external" href="http://cs231n.github.io/python-numpy-tutorial/">Python Numpy tutorial</a>, Justin Johnson, 2014.</p></li>
<li><p><a class="reference external" href="https://docs.scipy.org/doc/numpy/user/quickstart.html">Quickstart tutorial</a>, Numpy developers, 2009.</p></li>
<li><p><a class="reference external" href="http://mentat.za.net/numpy/numpy_advanced_slides/">Numpy medkits</a>, Stéfan van der Walt, 2008.</p></li>
</ul>
</div>
<div class="section" id="articles">
<h3><a class="toc-backref" href="#id167">Articles</a><a class="headerlink" href="#articles" title="Permalink to this headline">¶</a></h3>
<ul>
<li><div class="line-block">
<div class="line"><a class="reference external" href="https://hal.inria.fr/inria-00564007/document">The NumPy array: a structure for efficient numerical computation</a></div>
<div class="line">Stéfan van der Walt, Chris Colbert &amp; Gael Varoquaux,
Computing in Science and Engineering, 13(2), 2011.</div>
</div>
<div class="abstract docutils container">
<p>In the Python world, NumPy arrays are the standard representation for
numerical data and enable efficient implementation of numerical
computations in a high-level language. As this effort shows, NumPy
performance can be improved through three techniques: vectorizing
calculations, avoiding copying data in memory, and minimizing operation
counts.</p>
</div>
</li>
<li><div class="line-block">
<div class="line"><a class="reference external" href="http://citeseerx.ist.psu.edu/viewdoc/summary?doi=10.1.1.397.6097">Vectorised algorithms for spiking neural network simulation</a></div>
<div class="line">Romain Brette &amp; Dan F. M. Goodman,
Neural Computation, 23(6), 2010.</div>
</div>
<div class="abstract docutils container">
<p>High-level languages (Matlab, Python) are popular in neuroscience because
they are flexible and accelerate development. However, for simulating
spiking neural networks, the cost of interpretation is a bottleneck. We
describe a set of algorithms to simulate large spiking neural networks
efficiently with high-level languages using vector-based operations. These
algorithms constitute the core of Brian, a spiking neural network
simulator written in the Python language. Vectorized simulation makes it
possible to combine the flexibility of high-level languages with the
computational efficiency usually associated with compiled languages.</p>
</div>
</li>
<li><div class="line-block">
<div class="line"><a class="reference external" href="http://dl.acm.org/citation.cfm?id=1251830">Python for Scientific Computing</a></div>
<div class="line">Travis E. Oliphant,
Computing in Science &amp; Engineering, 9(3), 2007.</div>
</div>
<div class="abstract docutils container">
<p>By itself, Python is an excellent “steering” language for scientific codes
written in other languages. However, with additional basic tools, Python
transforms into a high-level language suited for scientific and
engineering code that’s often fast enough to be immediately useful but
also flexible enough to be sped up with additional extensions.</p>
</div>
</li>
</ul>
</div>
<div class="section" id="books">
<h3><a class="toc-backref" href="#id168">Books</a><a class="headerlink" href="#books" title="Permalink to this headline">¶</a></h3>
<ul>
<li><div class="line-block">
<div class="line"><a class="reference external" href="http://www.scipy-lectures.org">SciPy Lecture Notes</a>,</div>
<div class="line">Gaël Varoquaux, Emmanuelle Gouillart, Olav Vahtras et al., 2016.</div>
</div>
<div class="abstract docutils container">
<p>One document to learn numerics, science, and data with Python.  Tutorials
on the scientific Python ecosystem: a quick introduction to central tools
and techniques. The different chapters each correspond to a 1 to 2 hours
course with increasing level of expertise, from beginner to expert.</p>
</div>
</li>
<li><div class="line-block">
<div class="line"><a class="reference external" href="http://shop.oreilly.com/product/0636920034919.do">Python Data Science Handbook</a></div>
<div class="line">Jake van der Plas, O’Reilly, 2016.</div>
</div>
<div class="abstract docutils container">
<p>The Python Data Science Handbook provides a reference to the breadth of
computational and statistical methods that are central to data—intensive
science, research, and discovery. People with a programming background who
want to use Python effectively for data science tasks will learn how to
face a variety of problems: for example, how can you read this data format
into your script? How can you manipulate, transform, and clean this data?
How can you use this data to gain insight, answer questions, or to build
statistical or machine learning models?</p>
</div>
</li>
<li><div class="line-block">
<div class="line"><a class="reference external" href="http://shop.oreilly.com/product/0636920038481.do">Elegant SciPy: The Art of Scientific Python</a></div>
<div class="line">Juan Nunez-Iglesias, Stéfan van der Walt, Harriet Dashnow, O’Reilly, 2016.</div>
</div>
<div class="abstract docutils container">
<p>Welcome to Scientific Python and its community! With this practical book,
you’ll learn the fundamental parts of SciPy and related libraries, and get
a taste of beautiful, easy-to-read code that you can use in practice. More
and more scientists are programming, and the SciPy library is here to
help.  Finding useful functions and using them correctly, efficiently, and
in easily readable code are two very different things. You’ll learn by
example with some of the best code available, selected to cover a wide
range of SciPy and related libraries—including scikit-learn, scikit-image,
toolz, and pandas.</p>
</div>
</li>
<li><div class="line-block">
<div class="line"><a class="reference external" href="https://www.packtpub.com/big-data-and-business-intelligence/learning-ipython-interactive-computing-and-data-visualization-sec">Learning IPython for Interactive Computing and Data Visualization</a></div>
<div class="line">Cyrille Rossant, Packt Publishing, 2015.</div>
</div>
<div class="abstract docutils container">
<p>This book is a beginner-friendly guide to the Python data analysis
platform. After an introduction to the Python language, IPython, and the
Jupyter Notebook, you will learn how to analyze and visualize data on
real-world examples, how to create graphical user interfaces for image
processing in the Notebook, and how to perform fast numerical computations
for scientific simulations with NumPy, Numba, Cython, and ipyparallel. By
the end of this book, you will be able to perform in-depth analyses of all
sorts of data.</p>
</div>
</li>
<li><div class="line-block">
<div class="line"><a class="reference external" href="https://www.safaribooksonline.com/library/view/scipy-and-numpy/9781449361600/">SciPy and NumPy</a></div>
<div class="line">Eli Bressert, O’Reilly Media, Inc., 2012</div>
</div>
<div class="abstract docutils container">
<p>Are you new to SciPy and NumPy? Do you want to learn it quickly and easily
through examples and concise introduction? Then this is the book for
you. You’ll cut through the complexity of online documentation and
discover how easily you can get up to speed with these Python libraries.</p>
</div>
</li>
<li><div class="line-block">
<div class="line"><a class="reference external" href="http://shop.oreilly.com/product/0636920023784.do">Python for Data Analysis</a></div>
<div class="line">Wes McKinney, O’Reilly Media, Inc., 2012.</div>
</div>
<div class="abstract docutils container">
<p>Looking for complete instructions on manipulating, processing, cleaning,
and crunching structured data in Python? This hands-on book is packed
with practical cases studies that show you how to effectively solve a
broad set of data analysis problems, using several Python libraries.*</p>
</div>
</li>
<li><div class="line-block">
<div class="line"><a class="reference external" href="http://csc.ucdavis.edu/~chaos/courses/nlp/Software/NumPyBook.pdf">Guide to NumPy</a></div>
<div class="line">Travis Oliphant, 2006</div>
</div>
<div class="abstract docutils container">
<p>This book only briefly outlines some of the infrastructure that surrounds
the basic objects in NumPy to provide the additional functionality
contained in the older Numeric package (i.e. LinearAlgebra, RandomArray,
FFT). This infrastructure in NumPy includes basic linear algebra routines,
Fourier transform capabilities, and random number generators. In addition,
the f2py module is described in its own documentation, and so is only
briefly mentioned in the second part of the book.</p>
</div>
</li>
</ul>
</div>
</div>
<div class="toctree-wrapper compound">
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
        
        <div class='prev-next-bottom'>
            
    <a class='right-next' id="next-link" href="01-preface-with-jupyter-book.html" title="next page">Preface</a>

        </div>
        
        </div>
    </div>
    <footer class="footer mt-5 mt-md-0">
    <div class="container">
      <p>
        
          By Nicolas P. Rougier; Loïc Houpert<br/>
        
            &copy; Copyright 2021.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>
  
  <script src="_static/js/index.1c5a1a01449ed65a7b51.js"></script>

  
  </body>
</html>